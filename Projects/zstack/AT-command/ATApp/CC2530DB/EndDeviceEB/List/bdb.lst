###############################################################################
#
# IAR C/C++ Compiler V10.30.1.6000 for 8051               23/Feb/2022  09:34:59
# Copyright 2004-2018 IAR Systems AB.
# PC-locked license - IAR Embedded Workbench for 8051
#
#    Core               =  plain
#    Code model         =  banked
#    Data model         =  large
#    Calling convention =  xdata reentrant
#    Constant location  =  data_rom
#    Dptr setup         =  1,16
#                          
#    Source file        =  
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Components\stack\bdb\bdb.c
#    Command line       =  
#        -f C:\Users\Administrator\AppData\Local\Temp\EW30C3.tmp
#        (D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Components\stack\bdb\bdb.c
#        -D WDT_IN_PM1 -D ZIGBEEPRO -D INTER_PAN -D ZIGBEE_FREQ_AGILITY -D
#        DISABLE_GREENPOWER_BASIC_PROXY -D REFLECTOR -D HAL_UART=FALSE -D
#        HAL_LED=FALSE -D HAL_KEY=FALSE -D SECURE=1 -D TC_LINKKEY_JOIN -D
#        NV_INIT -D NV_RESTORE -D POWER_SAVING -D NWK_AUTO_POLL -D xZTOOL_P1 -D
#        xMT_TASK -D xMT_APP_FUNC -D xMT_SYS_FUNC -D xMT_ZDO_FUNC -D
#        xMT_ZDO_MGMT -D xMT_APP_CNF_FUNC -D xLEGACY_LCD_DEBUG -D
#        xLCD_SUPPORTED=DEBUG -D MULTICAST_ENABLED=FALSE -D ZCL_READ -D
#        ZCL_WRITE -D ZCL_DISCOVER -D ZCL_BASIC -D ZCL_IDENTIFY -D ZCL_SCENES
#        -D ZCL_GROUPS -D BDB_REPORTING -D ZCL_DOORLOCK -D ZCL_DOORLOCK_EXT -D
#        ISR_KEYINTERRUPT -lC
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\EndDeviceEB\List
#        -lA
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\EndDeviceEB\List
#        --diag_suppress Pe001,Pa010 -o
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\EndDeviceEB\Obj
#        -e --debug --core=plain --dptr=16,1 --data_model=large
#        --code_model=banked --calling_convention=xdata_reentrant
#        --place_constants=data_rom --nr_virtual_regs 16 -f
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wEndev.cfg
#        (-DCPU32MHZ -DROOT=__near_func -DMAC_CFG_TX_DATA_MAX=3
#        -DMAC_CFG_TX_MAX=6 -DMAC_CFG_RX_MAX=3) -f
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg
#        (-DZIGBEEPRO -DSECURE=1 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR
#        -DDEFAULT_CHANLIST=0x00000800 -DZDAPP_CONFIG_PAN_ID=0xFFFF
#        -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MASK=0x007F
#        -DBEACON_REQUEST_DELAY=100 -DBEACON_REQ_DELAY_MASK=0x00FF
#        -DLINK_STATUS_JITTER_MASK=0x007F -DROUTE_EXPIRY_TIME=30
#        -DAPSC_ACK_WAIT_DURATION_POLLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7
#        -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3
#        -DNWK_MAX_DATA_RETRIES=2 -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9
#        -DAPS_MAX_GROUPS=10 -DMAX_RTG_ENTRIES=15 -DNWK_MAX_BINDING_ENTRIES=4
#        -DMAX_BINDING_CLUSTER_IDS=4 -DDEFAULT_KEY={0} -DMAC_MAX_FRAME_SIZE=116
#        -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const __code"
#        -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=300
#        -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100 -DREJOIN_POLL_RATE=440
#        -DREJOIN_BACKOFF=900000 -DREJOIN_SCAN=900000) -f
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wZCL.cfg
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\Source\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\Source\ZCL\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\Source\UserAPI\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\Source\Controller\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\ZMain\TI2530DB\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\hal\include\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\hal\target\CC2530EB\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\mac\include\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\mac\high_level\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\single_chip\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\mt\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\osal\include\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\services\saddr\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\services\sdata\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\af\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\bdb\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\gp\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\nwk\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\sapi\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\sec\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\sys\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\zcl\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\stack\zdo\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\zmac\
#        -I
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\..\..\..\..\..\Components\zmac\f8w\
#        -Ohz --require_prototypes)
#    Locale             =  Chinese (Simplified)_CHN.936
#    List file          =  
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\EndDeviceEB\List\bdb.lst
#    Object file        =  
#        D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Projects\zstack\AT-command\ATApp\CC2530DB\EndDeviceEB\Obj\bdb.r51
#
###############################################################################

D:\A_proj\A_Cproj\Zigbee\ZigBee-DoorLock-2021.09.27\Components\stack\bdb\bdb.c
      1          /**************************************************************************************************
      2            Filename:       bdb.c
      3            Revised:        $Date: 2016-02-25 11:51:49 -0700 (Thu, 25 Feb 2016) $
      4            Revision:       $Revision: - $
      5          
      6            Description:    This file contains the Base Device Behavior functions and attributes.
      7          
      8          
      9            Copyright 2006-2015 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41           * INCLUDES
     42           */
     43          
     44          #include "bdb.h"
     45          #include "ZDApp.h"
     46          #include "OSAL.h"
     47          #include "ZDConfig.h"
     48          #include "hal_led.h"
     49          #include "ZDObject.h"
     50          #include "OSAL_Nv.h"
     51          #include "AddrMgr.h"
     52          #include "ZDSecMgr.h"
     53          #include "nwk.h"
     54          #include "nwk_util.h"
     55          #include "ssp_hash.h"
     56          #ifdef BDB_REPORTING
     57          #include "bdb_Reporting.h"
     58          #endif
     59          
     60          #if !defined (DISABLE_GREENPOWER_BASIC_PROXY) && (ZG_BUILD_RTR_TYPE)
     61          #include "gp_interface.h"
     62          #include "gp_common.h"
     63          #include "dgp_stub.h"
     64          #endif
     65          
     66          #include "bdb_interface.h"
     67          
     68          #if defined ( INTER_PAN )
     69          #if defined ( BDB_TL_INITIATOR )
     70          #include "bdb_touchlink_initiator.h"
     71          #endif
     72          #if defined ( BDB_TL_TARGET )
     73          #include "bdb_touchlink_target.h"
     74          #endif
     75          #endif
     76          
     77          #if defined ( INTER_PAN ) && ( defined ( BDB_TL_INITIATOR ) || defined ( BDB_TL_TARGET ) )
     78            #include "bdb_touchlink.h"
     79          #endif
     80          
     81          #ifdef MT_APP_CNF_FUNC
     82          #include "MT_APP_CONFIG.h"
     83          #endif
     84          
     85          #include "AT_uart.h"
     86          
     87           /*********************************************************************
     88           * MACROS
     89           */
     90          //This is actually the channels used
     91          #define vScanChannels  zgDefaultChannelList
     92          
     93           /*********************************************************************
     94           * CONSTANTS
     95           */
     96          
     97          #define NUMBER_OF_CHANNELS     16
     98          
     99          #define CHANNEL_11_MASK_POS    11
    100          #define CHANNEL_26_MASK_POS    26
    101          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    102          uint8 bdb_FB_InitiatorCurrentCyclesNumber = 0; //last cycle is #1 (i.e. cycles-left = (bdb_FB_InitiatorCurrentCyclesNumber - 1))
   \                     bdb_FB_InitiatorCurrentCyclesNumber:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    103          
    104          /*********************************************************************
    105           * TYPEDEFS
    106           */
    107          
    108          
    109           /*********************************************************************
    110           * GLOBAL VARIABLES
    111           */
    112          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    113          byte bdb_TaskID;
   \                     bdb_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_I, align 1, keep-with-next
    114          bdbAttributes_t bdbAttributes = BDB_ATTRIBUTES_DEFAULT_CONFIG;
   \                     bdbAttributes:
   \   000000                DS 19
   \   000013                REQUIRE `?<Initializer for bdbAttributes>`
   \   000013                REQUIRE __INIT_XDATA_I

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    115          epList_t *bdb_HeadEpDescriptorList = NULL;
   \                     bdb_HeadEpDescriptorList:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    116          epList_t *bdb_CurrEpDescriptorList = NULL;
   \                     bdb_CurrEpDescriptorList:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    117          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    118          bdbFindingBindingRespondent_t *pRespondentHead = NULL;
   \                     pRespondentHead:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    119          bdbFindingBindingRespondent_t *pRespondentCurr = NULL;
   \                     pRespondentCurr:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    120          bdbFindingBindingRespondent_t *pRespondentNext = NULL;
   \                     pRespondentNext:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    121          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    122          bdbCommissioningProcedureState_t bdbCommissioningProcedureState;
   \                     bdbCommissioningProcedureState:
   \   000000                DS 4
   \   000004                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    123          bool bdb_initialization = FALSE;  //Variable to tell if the initialization process has been started
   \                     bdb_initialization:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    124          
    125          //Nwk formation and nwk steering for nodes not in nwk

   \                                 In  segment XDATA_I, align 1, keep-with-next
    126          bool vDoPrimaryScan = TRUE;
   \                     vDoPrimaryScan:
   \   000000                DS 1
   \   000001                REQUIRE `?<Initializer for vDoPrimaryScan>`
   \   000001                REQUIRE __INIT_XDATA_I
    127          

   \                                 In  segment XDATA_I, align 1, keep-with-next
    128          uint8 zgBdbInstallCodeCRC[INSTALL_CODE_LEN + INSTALL_CODE_CRC_LEN] = {0x83,0xFE,0xD3,0x40,0x7A,0x93,0x97,0x23,0xA5,0xC6,0x39,0xB2,0x69,0x16,0xD5,0x05,0xC3,0xB5};
   \                     zgBdbInstallCodeCRC:
   \   000000                DS 18
   \   000012                REQUIRE `?<Initializer for zgBdbInstallCodeCRC>`
   \   000012                REQUIRE __INIT_XDATA_I
    129          
    130          //Pointer of the nwk being tried in association process
    131          #if (ZG_BUILD_JOINING_TYPE)

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    132          static networkDesc_t *pBDBListNwk = NULL;
   \                     pBDBListNwk:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    133          #endif
    134          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    135          uint8 bdb_ZclTransactionSequenceNumber=0x00;
   \                     bdb_ZclTransactionSequenceNumber:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    136          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    137          bool touchLinkTargetEnabled = FALSE;
   \                     touchLinkTargetEnabled:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    138          
    139           /*********************************************************************
    140           * EXTERNAL VARIABLES
    141           */
    142          
    143          extern devStartModes_t devStartMode;
    144          extern bool  requestNewTrustCenterLinkKey;
    145          extern uint32 requestLinkKeyTimeout;
    146          extern uint32 ZDApp_SavedPollRate;
    147          
    148          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
    149          extern bdbGCB_IdentifyTimeChange_t pfnIdentifyTimeChangeCB;
    150          extern uint8 bdbIndentifyActiveEndpoint;
    151          #endif
    152          
    153          extern bdbFindingBindingRespondent_t *pRespondentNext;
    154          
    155          #ifndef DISABLE_GREENPOWER_BASIC_PROXY
    156          extern ZDO_DeviceAnnce_t aliasConflictAnnce;
    157          #endif
    158          
    159          /*********************************************************************
    160           * EXTERNAL FUNCTIONS
    161           */
    162          
    163          extern void ZDApp_ResetTimerStart( uint16 delay );
    164          extern void ZDApp_NodeProfileSync( uint8 stackProfile );
    165          extern uint8 ZDApp_RestoreNwkKey( uint8 incrFrmCnt );
    166          extern uint8 ZDApp_ReadNetworkRestoreState( void );
    167          
    168          extern bdbFindingBindingRespondent_t* bdb_getRespondentRetry(bdbFindingBindingRespondent_t* pRespondentHead);
    169          extern void bdb_ProcessSimpleDesc( zdoIncomingMsg_t *msgPtr );
    170          extern void bdb_ProcessIEEEAddrRsp(zdoIncomingMsg_t *pMsg);
    171          
    172          /*********************************************************************
    173           * LOCAL VARIABLES
    174           */
    175          #if (ZG_BUILD_JOINING_TYPE)

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    176            static uint8 bdb_nwkAssocRetriesCount = 0;
   \                     bdb_nwkAssocRetriesCount:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    177          #endif
    178          #if (ZG_BUILD_COORDINATOR_TYPE)
    179            static bdb_joiningDeviceList_t *bdb_joiningDeviceList = NULL;
    180          #endif
    181          
    182          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
    183          //Latch to save the status success of any attempt in the periodic F&B process

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    184          static uint8 bdb_FBStateSuccessLatch = FALSE;
   \                     bdb_FBStateSuccessLatch:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    185          #endif
    186           /*********************************************************************
    187           * LOCAL FUNCTIONS
    188           */
    189          static void bdb_ProcessOSALMsg(bdbInMsg_t *msgPtr);
    190          void bdb_NotifyCommissioningModeStart(uint8 commissioningMode);
    191          static void bdb_processZDOMgs(zdoIncomingMsg_t *pMsg);
    192          
    193          #if (ZG_BUILD_JOINING_TYPE)
    194          static void bdb_requestTCStackVersion(void);
    195          static void bdb_requestTCLinkKey(void);
    196          static void bdb_requestVerifyTCLinkKey(void);
    197          static void bdb_tryNwkAssoc(void);
    198          #endif
    199          
    200          
    201          static void bdb_processTimeout(void);
    202          static void bdb_startResumeCommissioningProcess(void);
    203          static void bdb_nwkSteeringDeviceOnNwk(void);
    204          static void bdb_nwkJoiningFormation(bool isJoining);
    205          
    206          #if !defined (DISABLE_GREENPOWER_BASIC_PROXY) && (ZG_BUILD_RTR_TYPE)
    207          static uint8 gp_ChangeChannelReq(void);
    208          static void gp_CBInit(void);
    209          #endif
    210          
    211          
    212          #if (ZG_BUILD_COORDINATOR_TYPE)
    213          static void bdb_TCProcessJoiningList(void);
    214          static ZStatus_t bdb_TCJoiningDeviceFree(bdb_joiningDeviceList_t* JoiningDeviceToRemove);
    215          #endif
    216          #if (ZG_BUILD_COORDINATOR_TYPE)
    217          static bdbGCB_TCLinkKeyExchangeProcess_t  pfnTCLinkKeyExchangeProcessCB = NULL;
    218          #endif

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    219          static bdbGCB_CommissioningStatus_t       pfnCommissioningStatusCB = NULL;
   \                     pfnCommissioningStatusCB:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    220          #if (ZG_BUILD_JOINING_TYPE)

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    221          static bdbGCB_CBKETCLinkKeyExchange_t     pfnCBKETCLinkKeyExchange = NULL;
   \                     pfnCBKETCLinkKeyExchange:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    222          static bdbGCB_FilterNwkDesc_t             pfnFilterNwkDesc = NULL;
   \                     pfnFilterNwkDesc:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z
    223          #endif
    224          
    225          
    226          
    227          void bdb_calculateCCITT_CRC (uint8 *Mb, uint32 msglen, uint16 *crc);
    228          void bdb_crcInit(uint16 *crc, uint16 *crcinit_direct, uint16 *crcinit_nondirect);
    229          uint16 bdb_crcReflect (uint16 crc, uint16 bitnum);
    230          uint16 bdb_crcBitByBitFast(uint8 * p, uint32 len, uint16 crcinit_direct, uint16 crcinit_nondirect);
    231          void bdb_ProcessNodeDescRsp(zdoIncomingMsg_t *pMsg);
    232          
    233          /*********************************************************************
    234           * PUBLIC FUNCTIONS
    235           *********************************************************************/
    236          void bdb_filterNwkDisc(void);
    237          ZStatus_t bdb_joinProcess(networkDesc_t *pChosenNwk);
    238          
    239          ZStatus_t bdb_TCAddJoiningDevice(uint16 parentAddr, uint8* JoiningExtAddr);
    240          void bdb_TCjoiningDeviceComplete(uint8* JoiningExtAddr);
    241          
    242           /*********************************************************************
    243           * @fn          bdb_Init
    244           *
    245           * @brief       Initialization function for the Base Device Behavior.
    246           *
    247           * @param       task_id - bdb_TaskID Task ID
    248           *
    249           * @return      none
    250           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    251          void bdb_Init( byte task_id )
   \                     bdb_Init:
    252          {
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   \   000006   FE           MOV       R6,A
    253            bdb_TaskID = task_id;
   \   000007   90....       MOV       DPTR,#bdb_TaskID
   \   00000A   F0           MOVX      @DPTR,A
    254          
    255          #if (ZG_BUILD_COORDINATOR_TYPE)
    256            if(ZG_DEVICE_COORDINATOR_TYPE)
    257            {
    258              if(bdbAttributes.bdbJoinUsesInstallCodeKey)
    259              {
    260                zgAllowInstallCodes = ZG_IC_MUST_USED;
    261              }
    262            }
    263          #endif
    264          
    265          #if defined ( INTER_PAN ) && defined ( BDB_TL_INITIATOR )
    266            touchLinkInitiator_InitDevice( );
    267          #endif
    268          
    269          #if (BDB_REPORTING)
    270            bdb_RepInit();
   \   00000B                ; Setup parameters for call to function bdb_RepInit
   \   00000B   12....       LCALL     `??bdb_RepInit::?relay`; Banked call to: bdb_RepInit
    271          #endif
    272          
    273            //Register ZDO callbacks
    274            ZDO_RegisterForZDOMsg ( task_id, Node_Desc_rsp );
   \   00000E                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   00000E   7A02         MOV       R2,#0x2
   \   000010   7B80         MOV       R3,#-0x80
   \   000012   EE           MOV       A,R6
   \   000013   F9           MOV       R1,A
   \   000014   12....       LCALL     `??ZDO_RegisterForZDOMsg::?relay`; Banked call to: ZDO_RegisterForZDOMsg
    275          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
    276            ZDO_RegisterForZDOMsg ( task_id, IEEE_addr_rsp );
   \   000017                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   000017   7A01         MOV       R2,#0x1
   \   000019   7B80         MOV       R3,#-0x80
   \   00001B   EE           MOV       A,R6
   \   00001C   F9           MOV       R1,A
   \   00001D   12....       LCALL     `??ZDO_RegisterForZDOMsg::?relay`; Banked call to: ZDO_RegisterForZDOMsg
    277            ZDO_RegisterForZDOMsg ( task_id, Simple_Desc_rsp );
   \   000020                ; Setup parameters for call to function ZDO_RegisterForZDOMsg
   \   000020   7A04         MOV       R2,#0x4
   \   000022   7B80         MOV       R3,#-0x80
   \   000024   EE           MOV       A,R6
   \   000025   F9           MOV       R1,A
   \   000026   12....       LCALL     `??ZDO_RegisterForZDOMsg::?relay`; Banked call to: ZDO_RegisterForZDOMsg
    278          #endif
    279          
    280          #if !defined (DISABLE_GREENPOWER_BASIC_PROXY) && (ZG_BUILD_RTR_TYPE)
    281            gp_RegisterGPChangeChannelReqForBDBCB(gp_ChangeChannelReq);
    282            gp_CBInit();
    283          #endif
    284          }
   \   000029   02....       LJMP      ?Subroutine0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F01         MOV       R7,#0x1
   \   000002   02....       LJMP      ?BANKED_LEAVE_XDATA
    285          
    286          /*********************************************************************
    287           * @fn      bdb_RegisterSimpleDescriptor
    288           *
    289           * @brief   Register the Simple descriptor. This function also registers
    290           *          the profile's cluster conversion table.
    291           *
    292           * @param   simpleDesc - a pointer to a valid SimpleDescriptionFormat_t, must not be NULL.
    293           *
    294           * @return  none
    295           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    296          void bdb_RegisterSimpleDescriptor( SimpleDescriptionFormat_t *simpleDesc )
   \                     bdb_RegisterSimpleDescriptor:
    297          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV       A,R2
   \   000006   FE           MOV       R6,A
   \   000007   EB           MOV       A,R3
   \   000008   FF           MOV       R7,A
    298            endPointDesc_t *epDesc;
    299          
    300            // Register the application's endpoint descriptor
    301            //  - This memory is allocated and never freed.
    302            epDesc = osal_mem_alloc( sizeof ( endPointDesc_t ) );
   \   000009                ; Setup parameters for call to function osal_mem_alloc
   \   000009   7A07         MOV       R2,#0x7
   \   00000B   7B00         MOV       R3,#0x0
   \   00000D   12....       LCALL     `??osal_mem_alloc::?relay`; Banked call to: osal_mem_alloc
    303            if ( epDesc )
   \   000010   EA           MOV       A,R2
   \   000011   4B           ORL       A,R3
   \   000012   6023         JZ        ??bdb_RegisterSimpleDescriptor_0
    304            {
    305              // Fill out the endpoint description.
    306              epDesc->endPoint = simpleDesc->EndPoint;
   \   000014   8E82         MOV       DPL,R6
   \   000016   8F83         MOV       DPH,R7
   \   000018   E0           MOVX      A,@DPTR
   \   000019   8A82         MOV       DPL,R2
   \   00001B   8B83         MOV       DPH,R3
   \   00001D   F0           MOVX      @DPTR,A
    307              epDesc->task_id = &zcl_TaskID;   // all messages get sent to ZCL first
   \   00001E   A3           INC       DPTR
   \   00001F   A3           INC       DPTR
   \   000020   74..         MOV       A,#zcl_TaskID & 0xff
   \   000022   F0           MOVX      @DPTR,A
   \   000023   A3           INC       DPTR
   \   000024   74..         MOV       A,#(zcl_TaskID >> 8) & 0xff
   \   000026   12....       LCALL     ?Subroutine8 & 0xFFFF
    308              epDesc->simpleDesc = simpleDesc;
   \                     ??CrossCallReturnLabel_6:
   \   000029   EE           MOV       A,R6
   \   00002A   F0           MOVX      @DPTR,A
   \   00002B   A3           INC       DPTR
   \   00002C   EF           MOV       A,R7
   \   00002D   12....       LCALL     ?Subroutine8 & 0xFFFF
    309              epDesc->latencyReq = noLatencyReqs;
   \                     ??CrossCallReturnLabel_7:
   \   000030   A3           INC       DPTR
   \   000031   A3           INC       DPTR
   \   000032   E4           CLR       A
   \   000033   F0           MOVX      @DPTR,A
    310          
    311              // Register the endpoint description with the AF
    312              afRegister( epDesc );
   \   000034                ; Setup parameters for call to function afRegister
   \   000034   12....       LCALL     `??afRegister::?relay`; Banked call to: afRegister
    313            }
    314          }
   \                     ??bdb_RegisterSimpleDescriptor_0:
   \   000037   02....       LJMP      ??Subroutine60_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine8:
   \   000000   F0           MOVX      @DPTR,A
   \   000001   8A82         MOV       DPL,R2
   \   000003   8B83         MOV       DPH,R3
   \   000005   A3           INC       DPTR
   \   000006   A3           INC       DPTR
   \   000007   A3           INC       DPTR
   \   000008   A3           INC       DPTR
   \   000009   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine60_0:
   \   000000   7F02         MOV       R7,#0x2
   \   000002   02....       LJMP      ?BANKED_LEAVE_XDATA
    315          
    316          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
    317          /*********************************************************************
    318           * @fn      bdb_ZclIdentifyCmdInd
    319           *
    320           * @brief   Callback from the ZCL General Cluster Library when
    321           *          it received an Identity Command for this application.
    322           *
    323           * @param   identifyTime - the number of seconds to identify yourself
    324           * @param   endpoint - destination endpoint
    325           *
    326           * @return  none
    327           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    328          void bdb_ZclIdentifyCmdInd( uint16 identifyTime, uint8 endpoint )
   \                     bdb_ZclIdentifyCmdInd:
    329          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 8
   \   000005   74F8         MOV       A,#-0x8
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   EA           MOV       A,R2
   \   00000B   FE           MOV       R6,A
   \   00000C   EB           MOV       A,R3
   \   00000D   FF           MOV       R7,A
   \   00000E   89..         MOV       ?V0,R1
    330            zclAttrRec_t identifyAttrRec;
    331          
    332            if ( zclFindAttrRec( endpoint, ZCL_CLUSTER_ID_GEN_IDENTIFY,
    333                                ATTRID_IDENTIFY_TIME, &identifyAttrRec ) )
   \   000010                ; Setup parameters for call to function zclFindAttrRec
   \   000010   A8..         MOV       R0,?XSP + 0
   \   000012   A9..         MOV       R1,?XSP + 1
   \   000014   88..         MOV       ?V2,R0
   \   000016   89..         MOV       ?V3,R1
   \   000018   78..         MOV       R0,#?V2
   \   00001A   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00001D   7C00         MOV       R4,#0x0
   \   00001F   7D00         MOV       R5,#0x0
   \   000021   7A03         MOV       R2,#0x3
   \   000023   7B00         MOV       R3,#0x0
   \   000025   A9..         MOV       R1,?V0
   \   000027   12....       LCALL     `??zclFindAttrRec::?relay`; Banked call to: zclFindAttrRec
   \   00002A   7402         MOV       A,#0x2
   \   00002C   12....       LCALL     ?DEALLOC_XSTACK8
   \   00002F   E9           MOV       A,R1
   \   000030   604A         JZ        ??bdb_ZclIdentifyCmdInd_0
    334            {
    335              //If we are processing an actual change
    336              if(*(uint16*)identifyAttrRec.attr.dataPtr != identifyTime)
   \   000032   7406         MOV       A,#0x6
   \   000034   12....       LCALL     ?XSTACK_DISP0_8
   \   000037   12....       LCALL     ?Subroutine26 & 0xFFFF
   \                     ??CrossCallReturnLabel_25:
   \   00003A   E0           MOVX      A,@DPTR
   \   00003B   6E           XRL       A,R6
   \   00003C   7003         JNZ       ??bdb_ZclIdentifyCmdInd_1
   \   00003E   A3           INC       DPTR
   \   00003F   E0           MOVX      A,@DPTR
   \   000040   6F           XRL       A,R7
   \                     ??bdb_ZclIdentifyCmdInd_1:
   \   000041   6039         JZ        ??bdb_ZclIdentifyCmdInd_0
    337              {
    338                if ( identifyTime > 0 )
   \   000043   EE           MOV       A,R6
   \   000044   4F           ORL       A,R7
   \   000045   8882         MOV       DPL,R0
   \   000047   8983         MOV       DPH,R1
   \   000049   6017         JZ        ??bdb_ZclIdentifyCmdInd_2
    339                {
    340                  *((uint16*)identifyAttrRec.attr.dataPtr) = identifyTime;
   \   00004B   EE           MOV       A,R6
   \   00004C   F0           MOVX      @DPTR,A
   \   00004D   A3           INC       DPTR
   \   00004E   EF           MOV       A,R7
   \   00004F   F0           MOVX      @DPTR,A
    341                  osal_start_timerEx( bdb_TaskID, BDB_IDENTIFY_TIMEOUT, 1000 );
   \   000050                ; Setup parameters for call to function osal_start_timerEx
   \   000050   90....       MOV       DPTR,#__Constant_3e8
   \   000053   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000056   7A00         MOV       R2,#0x0
   \   000058   7B20         MOV       R3,#0x20
   \   00005A   12....       LCALL     ??Subroutine56_0 & 0xFFFF
    342                }
   \                     ??CrossCallReturnLabel_131:
   \   00005D   12....       LCALL     ?DEALLOC_XSTACK8
   \   000060   800A         SJMP      ??CrossCallReturnLabel_71
    343                else if ( identifyTime <= 0 )
    344                {
    345                  *((uint16*)identifyAttrRec.attr.dataPtr) = 0;
   \                     ??bdb_ZclIdentifyCmdInd_2:
   \   000062   E4           CLR       A
   \   000063   F0           MOVX      @DPTR,A
   \   000064   A3           INC       DPTR
   \   000065   F0           MOVX      @DPTR,A
    346                  osal_stop_timerEx( bdb_TaskID, BDB_IDENTIFY_TIMEOUT );
   \   000066                ; Setup parameters for call to function osal_stop_timerEx
   \   000066   FA           MOV       R2,A
   \   000067   7B20         MOV       R3,#0x20
   \   000069   12....       LCALL     ??Subroutine47_0 & 0xFFFF
    347                }
    348          
    349                if(pfnIdentifyTimeChangeCB != NULL)
   \                     ??CrossCallReturnLabel_71:
   \   00006C   90....       MOV       DPTR,#pfnIdentifyTimeChangeCB
   \   00006F   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_93:
   \   000072   6008         JZ        ??bdb_ZclIdentifyCmdInd_0
    350                {
    351                  pfnIdentifyTimeChangeCB(endpoint);
   \   000074                ; Setup parameters for indirect call
   \   000074   A9..         MOV       R1,?V0
   \   000076   12....       LCALL     ??Subroutine51_0 & 0xFFFF
    352                }
    353              }
    354            }
   \                     ??CrossCallReturnLabel_82:
   \   000079   12....       LCALL     ?CALL_IND
    355          }
   \                     ??bdb_ZclIdentifyCmdInd_0:
   \   00007C   7408         MOV       A,#0x8
   \   00007E   02....       LJMP      ??Subroutine49_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine47_0:
   \   000000   90....       MOV       DPTR,#bdb_TaskID
   \   000003   E0           MOVX      A,@DPTR
   \   000004   F9           MOV       R1,A
   \   000005   12....       LCALL     `??osal_stop_timerEx::?relay`; Banked call to: osal_stop_timerEx
   \   000008   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine49_0:
   \   000000   12....       LCALL     ?DEALLOC_XSTACK8
   \   000003                REQUIRE ??Subroutine50_0
   \   000003                ; // Fall through to label ??Subroutine50_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine50_0:
   \   000000   7F04         MOV       R7,#0x4
   \   000002   02....       LJMP      ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine26:
   \   000000   12....       LCALL     ?Subroutine38 & 0xFFFF
   \                     ??CrossCallReturnLabel_110:
   \   000003   F9           MOV       R1,A
   \   000004   8882         MOV       DPL,R0
   \   000006   F583         MOV       DPH,A
   \   000008   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine51_0:
   \   000000   E0           MOVX      A,@DPTR
   \   000001   F583         MOV       DPH,A
   \   000003   8882         MOV       DPL,R0
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine52_0:
   \   000000   12....       LCALL     ?Subroutine38 & 0xFFFF
   \                     ??CrossCallReturnLabel_112:
   \   000003   F9           MOV       R1,A
   \   000004   E8           MOV       A,R0
   \   000005   49           ORL       A,R1
   \   000006   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine38:
   \   000000   E0           MOVX      A,@DPTR
   \   000001   F8           MOV       R0,A
   \   000002   A3           INC       DPTR
   \   000003   E0           MOVX      A,@DPTR
   \   000004   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine56_0:
   \   000000   90....       MOV       DPTR,#bdb_TaskID
   \   000003   E0           MOVX      A,@DPTR
   \   000004   F9           MOV       R1,A
   \   000005   12....       LCALL     `??osal_start_timerEx::?relay`; Banked call to: osal_start_timerEx
   \   000008   7404         MOV       A,#0x4
   \   00000A   22           RET
    356          #endif
    357          
    358          
    359          #if (ZG_BUILD_JOINING_TYPE)
    360           /*********************************************************************
    361           * @fn          bdb_setActiveCentralizedLinkKey
    362           *
    363           * @brief       Set the active centralized key to be used, Global or IC derived. See zstack_CentralizedLinkKeyModes_t
    364           *
    365           * @param       zstack_CentralizedLinkKeyModes - Key to be used for joining centralized network
    366           * @param       pKey - Key to be used (if any)
    367           *
    368           * @return      ZStatus_t - ZFailure when no valid BDB_INSTALL_CODE_USE is used
    369           *                          ZInvalidParameter when IC buffer is null
    370           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    371          ZStatus_t bdb_setActiveCentralizedLinkKey(uint8 zstack_CentralizedLinkKeyModes, uint8* pKey)
   \                     bdb_setActiveCentralizedLinkKey:
    372          {
   \   000000                REQUIRE ?V0
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 8
   \   000005   74F8         MOV       A,#-0x8
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   89..         MOV       ?V0,R1
   \   00000C   EA           MOV       A,R2
   \   00000D   FE           MOV       R6,A
   \   00000E   EB           MOV       A,R3
   \   00000F   FF           MOV       R7,A
    373            ZStatus_t Status;
    374          
    375            uint8 extAddr[Z_EXTADDR_LEN];
    376          
    377            osal_memset(extAddr,0x00,Z_EXTADDR_LEN);
   \   000010                ; Setup parameters for call to function osal_memset
   \   000010   7C08         MOV       R4,#0x8
   \   000012   7D00         MOV       R5,#0x0
   \   000014   7900         MOV       R1,#0x0
   \   000016   AA..         MOV       R2,?XSP + 0
   \   000018   AB..         MOV       R3,?XSP + 1
   \   00001A   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
    378          
    379            if(pKey == NULL)
   \   00001D   EE           MOV       A,R6
   \   00001E   4F           ORL       A,R7
   \   00001F   603E         JZ        ??bdb_setActiveCentralizedLinkKey_0
    380            {
    381              return ZInvalidParameter;
    382            }
    383          
    384            //Clear it, if the request requires it, it will be set
    385            gZDSECMGR_TC_ATTEMPT_DEFAULT_KEY = FALSE;
   \   000021   90....       MOV       DPTR,#gZDSECMGR_TC_ATTEMPT_DEFAULT_KEY
   \   000024   E4           CLR       A
   \   000025   F0           MOVX      @DPTR,A
    386          
    387            switch(zstack_CentralizedLinkKeyModes)
   \   000026   E5..         MOV       A,?V0
   \   000028   600E         JZ        ??bdb_setActiveCentralizedLinkKey_1
   \   00002A   14           DEC       A
   \   00002B   6013         JZ        ??bdb_setActiveCentralizedLinkKey_2
   \   00002D   14           DEC       A
   \   00002E   600D         JZ        ??bdb_setActiveCentralizedLinkKey_3
   \   000030   14           DEC       A
   \   000031   601D         JZ        ??bdb_setActiveCentralizedLinkKey_4
   \   000033   14           DEC       A
   \   000034   6017         JZ        ??bdb_setActiveCentralizedLinkKey_5
   \   000036   8027         SJMP      ??bdb_setActiveCentralizedLinkKey_0
    388            {
    389              case zstack_UseDefaultGlobalTrustCenterLinkKey:
    390                //Set the default key to be used in centralized networks as defaultTCLinkKey
    391                Status = APSME_SetDefaultKey();
   \                     ??bdb_setActiveCentralizedLinkKey_1:
   \   000038                ; Setup parameters for call to function APSME_SetDefaultKey
   \   000038   12....       LCALL     `??APSME_SetDefaultKey::?relay`; Banked call to: APSME_SetDefaultKey
   \   00003B   801E         SJMP      ??bdb_setActiveCentralizedLinkKey_6
    392              break;
    393          
    394              case zstack_UseInstallCodeWithFallback:
    395                //same as zstack_UseInstallCode but attempt default TRUE
    396                gZDSECMGR_TC_ATTEMPT_DEFAULT_KEY = TRUE;
   \                     ??bdb_setActiveCentralizedLinkKey_3:
   \   00003D   7401         MOV       A,#0x1
   \   00003F   F0           MOVX      @DPTR,A
    397              case zstack_UseInstallCode:
    398                 //Set the install code as default key
    399                Status = bdb_addInstallCode(pKey,extAddr);
   \                     ??bdb_setActiveCentralizedLinkKey_2:
   \   000040                ; Setup parameters for call to function bdb_addInstallCode
   \   000040   AC..         MOV       R4,?XSP + 0
   \   000042   AD..         MOV       R5,?XSP + 1
   \   000044   EE           MOV       A,R6
   \   000045   FA           MOV       R2,A
   \   000046   EF           MOV       A,R7
   \   000047   FB           MOV       R3,A
   \   000048   12....       LCALL     `??bdb_addInstallCode::?relay`; Banked call to: bdb_addInstallCode
   \   00004B   800E         SJMP      ??bdb_setActiveCentralizedLinkKey_6
    400              break;
    401          
    402              case zstack_UseAPSKeyWithFallback:
    403                //same as zstack_UseAPSKey but attempt default TRUE
    404                gZDSECMGR_TC_ATTEMPT_DEFAULT_KEY = TRUE;
   \                     ??bdb_setActiveCentralizedLinkKey_5:
   \   00004D   7401         MOV       A,#0x1
   \   00004F   F0           MOVX      @DPTR,A
    405              case zstack_UseAPSKey:
    406                //Set the key as global default
    407                Status = APSME_AddTCLinkKey(pKey,extAddr);
   \                     ??bdb_setActiveCentralizedLinkKey_4:
   \   000050                ; Setup parameters for call to function APSME_AddTCLinkKey
   \   000050   AC..         MOV       R4,?XSP + 0
   \   000052   AD..         MOV       R5,?XSP + 1
   \   000054   EE           MOV       A,R6
   \   000055   FA           MOV       R2,A
   \   000056   EF           MOV       A,R7
   \   000057   FB           MOV       R3,A
   \   000058   12....       LCALL     `??APSME_AddTCLinkKey::?relay`; Banked call to: APSME_AddTCLinkKey
   \                     ??bdb_setActiveCentralizedLinkKey_6:
   \   00005B   E9           MOV       A,R1
   \   00005C   F9           MOV       R1,A
    408              break;
   \   00005D   8002         SJMP      ??bdb_setActiveCentralizedLinkKey_7
    409          
    410              default:
    411                Status = ZInvalidParameter;
   \                     ??bdb_setActiveCentralizedLinkKey_0:
   \   00005F   7902         MOV       R1,#0x2
    412              break;
    413            }
    414          
    415            return Status;
   \                     ??bdb_setActiveCentralizedLinkKey_7:
   \   000061   7408         MOV       A,#0x8
   \   000063   12....       LCALL     ?DEALLOC_XSTACK8
   \   000066   02....       LJMP      ?Subroutine0 & 0xFFFF
    416          }
    417          #endif
    418          
    419          
    420          
    421          
    422          /******************************************************************************
    423           * @fn          bdb_addInstallCode
    424           *
    425           * @brief       Interface to add an install codes and adds a APS TC Link key.
    426           *
    427           * @param       pInstallCode - [in] Install Code with CRC (buffer size of 18 bytes).
    428           *              pExt - [in] Extended address of the node.
    429           *
    430           * @return      ZStatus_t
    431           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    432          ZStatus_t bdb_addInstallCode(uint8* pInstallCode, uint8* pExt)
   \                     bdb_addInstallCode:
    433          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V5
   \   000000   74F2         MOV       A,#-0xe
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 16
   \   000005   74F0         MOV       A,#-0x10
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   EA           MOV       A,R2
   \   00000B   FE           MOV       R6,A
   \   00000C   EB           MOV       A,R3
   \   00000D   FF           MOV       R7,A
   \   00000E   8C..         MOV       ?V0,R4
   \   000010   8D..         MOV       ?V1,R5
    434            uint8  hashOutput[16];
    435            uint16 CRC;
    436          
    437          #if (ZG_BUILD_COORDINATOR_TYPE)
    438            if(ZG_DEVICE_COORDINATOR_TYPE)
    439            {
    440              if(zgAllowInstallCodes == ZG_IC_NOT_SUPPORTED)
    441              {
    442                return ZFailure;
    443              }
    444            }
    445          #endif
    446          
    447            if((pInstallCode == NULL) || (pExt == NULL))
   \   000012   EA           MOV       A,R2
   \   000013   4F           ORL       A,R7
   \   000014   601F         JZ        ??bdb_addInstallCode_0
   \   000016   EC           MOV       A,R4
   \   000017   4D           ORL       A,R5
   \   000018   601B         JZ        ??bdb_addInstallCode_0
    448            {
    449              return ZInvalidParameter;
    450            }
    451          
    452            CRC = bdb_GenerateInstallCodeCRC(pInstallCode);
   \   00001A                ; Setup parameters for call to function bdb_GenerateInstallCodeCRC
   \   00001A   12....       LCALL     `??bdb_GenerateInstallCodeCRC::?relay`; Banked call to: bdb_GenerateInstallCodeCRC
   \   00001D   8A..         MOV       ?V2,R2
   \   00001F   8B..         MOV       ?V3,R3
    453          
    454            //Validate CRC
    455            if(CRC != osal_build_uint16(&pInstallCode[INSTALL_CODE_LEN]))
   \   000021                ; Setup parameters for call to function osal_build_uint16
   \   000021   EE           MOV       A,R6
   \   000022   2410         ADD       A,#0x10
   \   000024   FA           MOV       R2,A
   \   000025   E4           CLR       A
   \   000026   3F           ADDC      A,R7
   \   000027   FB           MOV       R3,A
   \   000028   12....       LCALL     `??osal_build_uint16::?relay`; Banked call to: osal_build_uint16
   \   00002B   EA           MOV       A,R2
   \   00002C   65..         XRL       A,?V2
   \   00002E   7003         JNZ       ??bdb_addInstallCode_1
   \   000030   EB           MOV       A,R3
   \   000031   65..         XRL       A,?V3
   \                     ??bdb_addInstallCode_1:
   \   000033   6004         JZ        ??bdb_addInstallCode_2
    456            {
    457              return ZInvalidParameter;
   \                     ??bdb_addInstallCode_0:
   \   000035   7902         MOV       R1,#0x2
   \   000037   8035         SJMP      ??bdb_addInstallCode_3
    458            }
    459          
    460            sspMMOHash (NULL, 0, pInstallCode,(INSTALL_CODE_LEN + INSTALL_CODE_CRC_LEN) * BITS_PER_BYTE, hashOutput);
   \                     ??bdb_addInstallCode_2:
   \   000039                ; Setup parameters for call to function sspMMOHash
   \   000039   A8..         MOV       R0,?XSP + 0
   \   00003B   A9..         MOV       R1,?XSP + 1
   \   00003D   88..         MOV       ?V2,R0
   \   00003F   89..         MOV       ?V3,R1
   \   000041   78..         MOV       R0,#?V2
   \   000043   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000046   75..90       MOV       ?V2,#-0x70
   \   000049   75..00       MOV       ?V3,#0x0
   \   00004C   78..         MOV       R0,#?V2
   \   00004E   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000051   EE           MOV       A,R6
   \   000052   FC           MOV       R4,A
   \   000053   EF           MOV       A,R7
   \   000054   FD           MOV       R5,A
   \   000055   7900         MOV       R1,#0x0
   \   000057   7A00         MOV       R2,#0x0
   \   000059   7B00         MOV       R3,#0x0
   \   00005B   12....       LCALL     `??sspMMOHash::?relay`; Banked call to: sspMMOHash
   \   00005E   7404         MOV       A,#0x4
   \   000060   12....       LCALL     ?DEALLOC_XSTACK8
    461          
    462            return APSME_AddTCLinkKey(hashOutput,pExt);
   \   000063                ; Setup parameters for call to function APSME_AddTCLinkKey
   \   000063   AC..         MOV       R4,?V0
   \   000065   AD..         MOV       R5,?V1
   \   000067   AA..         MOV       R2,?XSP + 0
   \   000069   AB..         MOV       R3,?XSP + 1
   \   00006B   12....       LCALL     `??APSME_AddTCLinkKey::?relay`; Banked call to: APSME_AddTCLinkKey
   \                     ??bdb_addInstallCode_3:
   \   00006E   7410         MOV       A,#0x10
   \   000070   12....       LCALL     ?DEALLOC_XSTACK8
   \   000073   7F06         MOV       R7,#0x6
   \   000075   02....       LJMP      ?BANKED_LEAVE_XDATA
    463          }
    464          
    465          
    466          #if (ZG_BUILD_COORDINATOR_TYPE)
    467           /*********************************************************************
    468           * @fn      bdb_RegisterTCLinkKeyExchangeProcessCB
    469           *
    470           * @brief   Register a callback to receive notifications on the joining devices
    471           *          and its status on TC link key exchange
    472           *
    473           * @param   bdbGCB_TCLinkKeyExchangeProcess - application callback
    474           *          (extended address of device, status: 0 = Joining, 1 = TC link key exchange success, 2 = TC link key exchange failed)
    475           *
    476           * @return  none
    477           */
    478          void bdb_RegisterTCLinkKeyExchangeProcessCB(bdbGCB_TCLinkKeyExchangeProcess_t bdbGCB_TCLinkKeyExchangeProcess)
    479          {
    480            if(bdbGCB_TCLinkKeyExchangeProcess != NULL)
    481            {
    482              pfnTCLinkKeyExchangeProcessCB = bdbGCB_TCLinkKeyExchangeProcess;
    483            }
    484          }
    485          
    486          
    487          
    488           /*********************************************************************
    489           * @fn          bdb_setTCRequireKeyExchange
    490           *
    491           * @brief       Set the bdb_setTCRequireKeyExchange attribute
    492           *
    493           * @param       isKeyExchangeRequired - True if TC will remove devices that do
    494           *              not perform key exchange after bdbTrustCenterNodeJoinTimeout,
    495           *              False to not remove devices.
    496           *
    497           * @return      none
    498           */
    499          void bdb_setTCRequireKeyExchange(bool isKeyExchangeRequired)
    500          {
    501            bdbAttributes.bdbTrustCenterRequireKeyExchange = isKeyExchangeRequired;
    502          }
    503          
    504          
    505          
    506           /*********************************************************************
    507           * @fn          bdb_TCAddJoiningDevice
    508           *
    509           * @brief       Add a joining device to the list of devices that must request a
    510           *              key before bdbTrustCenterNodeJoinTimeout.
    511           *
    512           * @param       parentAddr - Address of the parent device
    513           * @param       JoiningExtAddr - IEEE address of the joining device
    514           *
    515           * @return      ZStatus_t - ZFailure No memory to allocate the device in the list
    516           *                          ZInvalidParameter
    517           */
    518          ZStatus_t bdb_TCAddJoiningDevice(uint16 parentAddr, uint8* JoiningExtAddr)
    519          {
    520            bdb_joiningDeviceList_t* tempJoiningDescNode;
    521          
    522            if((parentAddr == INVALID_NODE_ADDR) || (JoiningExtAddr == NULL))
    523            {
    524              return ZInvalidParameter;
    525            }
    526          
    527            //If the list was empty and element was allocated, then start the timer
    528            if(bdb_joiningDeviceList == NULL)
    529            {
    530              bdb_joiningDeviceList = osal_mem_alloc(sizeof(bdb_joiningDeviceList_t));
    531              if(bdb_joiningDeviceList == NULL)
    532              {
    533                return ZFailure;
    534              }
    535          
    536              osal_start_reload_timer(bdb_TaskID,BDB_TC_JOIN_TIMEOUT,1000);
    537              tempJoiningDescNode = bdb_joiningDeviceList;
    538            }
    539            //if the list was not empty then add the entry at the end of the list
    540            else
    541            {
    542              tempJoiningDescNode = bdb_joiningDeviceList;
    543          
    544              //Validate that this is not already in the list... somehow
    545              if(osal_memcmp(JoiningExtAddr,tempJoiningDescNode->bdbJoiningNodeEui64,Z_EXTADDR_LEN))
    546              {
    547                //The device added is already in the list, refresh its time and do nothing else
    548                tempJoiningDescNode->NodeJoinTimeout = bdbAttributes.bdbTrustCenterNodeJoinTimeout;
    549                return ZSuccess;
    550              }
    551          
    552              while(tempJoiningDescNode->nextDev != NULL)
    553              {
    554                tempJoiningDescNode = tempJoiningDescNode->nextDev;
    555          
    556                //Validate that this is not already in the list... somehow
    557                if(osal_memcmp(JoiningExtAddr,tempJoiningDescNode->bdbJoiningNodeEui64,Z_EXTADDR_LEN))
    558                {
    559                  //The device added is already in the list, refresh its time and do nothing else
    560                  tempJoiningDescNode->NodeJoinTimeout = bdbAttributes.bdbTrustCenterNodeJoinTimeout;
    561                  return ZSuccess;
    562                }
    563              }
    564          
    565              tempJoiningDescNode->nextDev = osal_mem_alloc(sizeof(bdb_joiningDeviceList_t));
    566              if(tempJoiningDescNode->nextDev == NULL)
    567              {
    568                return ZFailure;
    569              }
    570          
    571              tempJoiningDescNode = tempJoiningDescNode->nextDev;
    572            }
    573          
    574            if(pfnTCLinkKeyExchangeProcessCB)
    575            {
    576              bdb_TCLinkKeyExchProcess_t bdb_TCLinkKeyExchProcess;
    577              osal_memcpy(bdb_TCLinkKeyExchProcess.extAddr,tempJoiningDescNode->bdbJoiningNodeEui64, Z_EXTADDR_LEN);
    578              bdb_TCLinkKeyExchProcess.status = BDB_TC_LK_EXCH_PROCESS_JOINING;
    579          
    580              bdb_SendMsg(bdb_TaskID, BDB_TC_LINK_KEY_EXCHANGE_PROCESS, BDB_MSG_EVENT_SUCCESS,sizeof(bdb_TCLinkKeyExchProcess_t),(uint8*)&bdb_TCLinkKeyExchProcess);
    581            }
    582          
    583            tempJoiningDescNode->nextDev = NULL;
    584            tempJoiningDescNode->NodeJoinTimeout = bdbAttributes.bdbTrustCenterNodeJoinTimeout;
    585            tempJoiningDescNode->parentAddr = parentAddr;
    586            osal_memcpy(tempJoiningDescNode->bdbJoiningNodeEui64, JoiningExtAddr, Z_EXTADDR_LEN);
    587          
    588            return ZSuccess;
    589          }
    590          
    591          /****************************************************************************
    592           * @fn          bdb_TCProcessJoiningList
    593           *
    594           * @brief       Process the timer to handle the joining devices if the TC link
    595           *              key is mandatory for all devices
    596           *
    597           * @param       none
    598           *
    599           * @return      none
    600           */
    601          void bdb_TCProcessJoiningList(void)
    602          {
    603            bdb_joiningDeviceList_t* tempJoiningDescNode;
    604          
    605            if(bdb_joiningDeviceList)
    606            {
    607              tempJoiningDescNode = bdb_joiningDeviceList;
    608          
    609              while(tempJoiningDescNode)
    610              {
    611                if(tempJoiningDescNode->NodeJoinTimeout)
    612                {
    613                  tempJoiningDescNode->NodeJoinTimeout--;
    614                }
    615          
    616                if(tempJoiningDescNode->NodeJoinTimeout == 0)
    617                {
    618                  //Check if the key exchange is required
    619                  if(bdb_doTrustCenterRequireKeyExchange())
    620                  {
    621                      AddrMgrEntry_t entry;
    622          
    623                      entry.user = ADDRMGR_USER_DEFAULT;
    624                      osal_memcpy(entry.extAddr,tempJoiningDescNode->bdbJoiningNodeEui64, Z_EXTADDR_LEN);
    625          
    626                      if(AddrMgrEntryLookupExt(&entry))
    627                      {
    628                        ZDSecMgrAPSRemove(entry.nwkAddr,entry.extAddr,tempJoiningDescNode->parentAddr);
    629                      }
    630                  }
    631          
    632                  //Expired device either is legacy device not using the TCLK entry or got
    633                  //removed from the network because of timeout, eitherway it is not using
    634                  //TCLK entry neither the Security user in the address manager, so free the entry
    635                  //in both tables.
    636          
    637                  uint16 keyNvIndex;
    638                  uint16 index;
    639                  APSME_TCLKDevEntry_t TCLKDevEntry;
    640                  uint8 found;
    641          
    642                  //Remove the entry in address manager
    643                  ZDSecMgrAddrClear(tempJoiningDescNode->bdbJoiningNodeEui64);
    644          
    645                  //search for the entry in the TCLK table
    646                  keyNvIndex = APSME_SearchTCLinkKeyEntry(tempJoiningDescNode->bdbJoiningNodeEui64,&found, NULL);
    647          
    648                  //If found, erase it.
    649                  if(found == TRUE)
    650                  {
    651                    osal_memset(&TCLKDevEntry,0,sizeof(APSME_TCLKDevEntry_t));
    652                    TCLKDevEntry.keyAttributes = ZG_DEFAULT_KEY;
    653          
    654                    //Increase the shift by one. Validate the maximum shift of the seed which is 15
    655                    index = keyNvIndex - ZCD_NV_TCLK_TABLE_START;
    656          
    657                    TCLinkKeyFrmCntr[index].rxFrmCntr = 0;
    658                    TCLinkKeyFrmCntr[index].txFrmCntr = 0;
    659          
    660                    //Update the entry
    661                    osal_nv_write(keyNvIndex,0,sizeof(APSME_TCLKDevEntry_t), &TCLKDevEntry );
    662                  }
    663          
    664                  if(pfnTCLinkKeyExchangeProcessCB)
    665                  {
    666                    bdb_TCLinkKeyExchProcess_t bdb_TCLinkKeyExchProcess;
    667                    osal_memcpy(bdb_TCLinkKeyExchProcess.extAddr,tempJoiningDescNode->bdbJoiningNodeEui64, Z_EXTADDR_LEN);
    668                    bdb_TCLinkKeyExchProcess.status = BDB_TC_LK_EXCH_PROCESS_EXCH_FAIL;
    669          
    670                    bdb_SendMsg(bdb_TaskID, BDB_TC_LINK_KEY_EXCHANGE_PROCESS, BDB_MSG_EVENT_SUCCESS,sizeof(bdb_TCLinkKeyExchProcess_t),(uint8*)&bdb_TCLinkKeyExchProcess);
    671                  }
    672          
    673                  //Free the device from the list
    674                  bdb_TCJoiningDeviceFree(tempJoiningDescNode);
    675                }
    676                tempJoiningDescNode = tempJoiningDescNode->nextDev;
    677              }
    678            }
    679          
    680            //we are done with the list
    681            if(bdb_joiningDeviceList == NULL)
    682            {
    683              osal_stop_timerEx(bdb_TaskID,BDB_TC_JOIN_TIMEOUT);
    684            }
    685          }
    686          
    687          
    688          
    689          /****************************************************************************
    690           * @fn          bdb_TCjoiningDeviceComplete
    691           *
    692           * @brief       This function frees a joining device from the list that has
    693           *              finished TC link key exchange process
    694           *
    695           * @param       JoiningExtAddr - Extended address of the device
    696           *
    697           * @return      none
    698           */
    699          void bdb_TCjoiningDeviceComplete(uint8* JoiningExtAddr)
    700          {
    701            bdb_joiningDeviceList_t* tempJoiningDescNode;
    702          
    703            if((bdb_joiningDeviceList != NULL) && (JoiningExtAddr != NULL))
    704            {
    705              tempJoiningDescNode = bdb_joiningDeviceList;
    706          
    707              while(tempJoiningDescNode != NULL)
    708              {
    709                if(osal_memcmp(tempJoiningDescNode->bdbJoiningNodeEui64,JoiningExtAddr,Z_EXTADDR_LEN))
    710                {
    711                  if(pfnTCLinkKeyExchangeProcessCB)
    712                  {
    713                    bdb_TCLinkKeyExchProcess_t bdb_TCLinkKeyExchProcess;
    714                    osal_memcpy(bdb_TCLinkKeyExchProcess.extAddr,tempJoiningDescNode->bdbJoiningNodeEui64, Z_EXTADDR_LEN);
    715                    bdb_TCLinkKeyExchProcess.status = BDB_TC_LK_EXCH_PROCESS_EXCH_SUCCESS;
    716          
    717                    bdb_SendMsg(bdb_TaskID, BDB_TC_LINK_KEY_EXCHANGE_PROCESS, BDB_MSG_EVENT_SUCCESS,sizeof(bdb_TCLinkKeyExchProcess_t),(uint8*)&bdb_TCLinkKeyExchProcess);
    718                  }
    719          
    720                  bdb_TCJoiningDeviceFree(tempJoiningDescNode);
    721                  break;
    722                }
    723                tempJoiningDescNode = tempJoiningDescNode->nextDev;
    724              }
    725          
    726              if(bdb_joiningDeviceList == NULL)
    727              {
    728                osal_stop_timerEx(bdb_TaskID,BDB_TC_JOIN_TIMEOUT);
    729              }
    730            }
    731          }
    732          
    733          
    734          
    735          /****************************************************************************
    736           * @fn          bdb_TCJoiningDeviceFree
    737           *
    738           * @brief       This function frees a joining device from the list.
    739           *
    740           * @param       ZSuccess - If the device was found and erased
    741           * @param       ZInvalidParameter - Not found
    742           *
    743           * @return      none
    744           */
    745          ZStatus_t bdb_TCJoiningDeviceFree(bdb_joiningDeviceList_t* JoiningDeviceToRemove)
    746          {
    747            bdb_joiningDeviceList_t* descCurrent;
    748            bdb_joiningDeviceList_t* descPrev;
    749          
    750            //validate empty list?
    751          
    752            //Is it the first?
    753            if(osal_memcmp(bdb_joiningDeviceList->bdbJoiningNodeEui64, JoiningDeviceToRemove->bdbJoiningNodeEui64, Z_EXTADDR_LEN))
    754            {
    755              descCurrent = bdb_joiningDeviceList;
    756              bdb_joiningDeviceList = bdb_joiningDeviceList->nextDev;
    757              osal_mem_free( descCurrent );
    758              return ZSuccess;
    759            }
    760          
    761            descPrev = NULL;
    762            descCurrent = bdb_joiningDeviceList;
    763          
    764            while(descCurrent != NULL)
    765            {
    766              if(osal_memcmp(descCurrent->nextDev->bdbJoiningNodeEui64, JoiningDeviceToRemove->bdbJoiningNodeEui64, Z_EXTADDR_LEN))
    767              {
    768                descPrev = descCurrent;
    769                break;
    770              }
    771              descCurrent = descCurrent->nextDev;
    772            }
    773            if(descPrev == NULL)
    774            {
    775              //Not found
    776              return ZInvalidParameter;
    777            }
    778          
    779            descPrev->nextDev = descPrev->nextDev->nextDev;
    780          
    781            osal_mem_free( JoiningDeviceToRemove );
    782            return ZSuccess;
    783          
    784          }
    785          
    786           /*********************************************************************
    787           * @fn          bdb_setJoinUsesInstallCodeKey
    788           *
    789           * @brief       Set BDB attribute bdbJoinUsesInstallCodeKey.
    790           *
    791           * @param       set - If TRUE only devices with IC register in TC can join the
    792           *              nwk, otherwise devices may or not have a IC register
    793           *
    794           * @return      none
    795           */
    796          void bdb_setJoinUsesInstallCodeKey(bool set)
    797          {
    798            bdbAttributes.bdbJoinUsesInstallCodeKey = set;
    799            if(set)
    800            {
    801              zgAllowInstallCodes = ZG_IC_MUST_USED;
    802            }
    803            else
    804            {
    805              zgAllowInstallCodes = ZG_IC_SUPPORTED_NOT_REQUIRED;
    806            }
    807          }
    808          #endif
    809          
    810           /*********************************************************************
    811           * @fn          bdb_StartCommissioning
    812           *
    813           * @brief       Start the commissioning process setting the commissioning mode given.
    814           *
    815           * @param       mode - refer to bdbCommissioningMode
    816           *
    817           * @return      none
    818           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    819          void bdb_StartCommissioning(uint8 mode)
   \                     bdb_StartCommissioning:
    820          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 20
   \   000005   74EC         MOV       A,#-0x14
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   89..         MOV       ?V0,R1
    821            //Application cannot request to set the device in initialization mode or parent lost
    822            mode &= ~(BDB_COMMISSIONING_MODE_INITIALIZATION | BDB_COMMISSIONING_MODE_PARENT_LOST);
    823          
    824          #ifdef BDB_TL_INITIATOR
    825            if ( touchlinkFNReset == TRUE )
    826            {
    827              return;
    828            }
    829          #else
    830            //Commissioning mode used only for initiator
    831            mode &= ~BDB_COMMISSIONING_MODE_INITIATOR_TL;
   \   00000C   53..CE       ANL       ?V0,#0xce
    832          #endif
    833          
    834          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==0)
    835            //Commissioning mode used only for devices with F&B
    836            mode &= ~BDB_COMMISSIONING_MODE_FINDING_BINDING;
    837          #endif
    838          
    839            //If we have running process or the machine state is triggered, then just append and it will be excecuted
    840            if((bdbAttributes.bdbCommissioningMode) || (osal_get_timeoutEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE)))
   \   00000F   90....       MOV       DPTR,#bdbAttributes + 11
   \   000012   E0           MOVX      A,@DPTR
   \   000013   7009         JNZ       ??bdb_StartCommissioning_0
   \   000015                ; Setup parameters for call to function osal_get_timeoutEx
   \   000015   7A04         MOV       R2,#0x4
   \   000017   7B00         MOV       R3,#0x0
   \   000019   12....       LCALL     ??Subroutine43_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_59:
   \   00001C   602F         JZ        ??bdb_StartCommissioning_1
    841            {
    842          #if ZG_BUILD_ENDDEVICE_TYPE
    843              if(ZG_DEVICE_ENDDEVICE_TYPE)
    844              {
    845                //Devices with parent lost are not allowed to perform actions
    846                if(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_PARENT_LOST)
   \                     ??bdb_StartCommissioning_0:
   \   00001E   90....       MOV       DPTR,#bdbAttributes + 11
   \   000021   E0           MOVX      A,@DPTR
   \   000022   A2E5         MOV       C,0xE0 /* A   */.5
   \   000024   5003         JNC       $+5
   \   000026   02....       LJMP      ??bdb_StartCommissioning_2 & 0xFFFF
    847                {
    848                  return;
    849                }
    850              }
    851          #endif
    852          
    853              //If we are on the network and got requested to do nwk steering, we do not need to wait other process,
    854              // just send permit joining and report the application
    855              if((bdbAttributes.bdbNodeIsOnANetwork) && (mode & BDB_COMMISSIONING_MODE_NWK_STEERING))
   \   000029   90....       MOV       DPTR,#bdbAttributes + 14
   \   00002C   E0           MOVX      A,@DPTR
   \   00002D   6010         JZ        ??bdb_StartCommissioning_3
   \   00002F   E5..         MOV       A,?V0
   \   000031   A2E1         MOV       C,0xE0 /* A   */.1
   \   000033   500A         JNC       ??bdb_StartCommissioning_3
    856              {
    857                bdb_nwkSteeringDeviceOnNwk();
    858                bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_STEERING_ON_NWK, TRUE);
   \   000035                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000035   7A01         MOV       R2,#0x1
   \   000037   7904         MOV       R1,#0x4
   \   000039   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
    859          
    860                //Clean nwk steering
    861                mode ^= BDB_COMMISSIONING_MODE_NWK_STEERING;
   \   00003C   63..02       XRL       ?V0,#0x2
    862              }
    863          
    864              //add the remaining valid commissioning modes requested, those will be process when bdb finish its current process
    865              bdbAttributes.bdbCommissioningMode |= mode & BDB_COMMISSIONING_MODES;
   \                     ??bdb_StartCommissioning_3:
   \   00003F   743F         MOV       A,#0x3f
   \   000041   55..         ANL       A,?V0
   \   000043   F8           MOV       R0,A
   \   000044   90....       MOV       DPTR,#bdbAttributes + 11
   \   000047   E0           MOVX      A,@DPTR
   \   000048   48           ORL       A,R0
   \   000049   F0           MOVX      @DPTR,A
    866              return;
   \   00004A   02....       LJMP      ??bdb_StartCommissioning_2 & 0xFFFF
    867            }
    868          
    869            //Save the commissioning modes valid requested
    870            bdbAttributes.bdbCommissioningMode |= mode & BDB_COMMISSIONING_MODES;
   \                     ??bdb_StartCommissioning_1:
   \   00004D   743F         MOV       A,#0x3f
   \   00004F   55..         ANL       A,?V0
   \   000051   FE           MOV       R6,A
   \   000052   90....       MOV       DPTR,#bdbAttributes + 11
   \   000055   E0           MOVX      A,@DPTR
   \   000056   4E           ORL       A,R6
   \   000057   F0           MOVX      @DPTR,A
    871          
    872          
    873            //Start processing the initialization, once per power cycle.
    874            if(!bdb_initialization)
   \   000058   90....       MOV       DPTR,#bdb_initialization
   \   00005B   E0           MOVX      A,@DPTR
   \   00005C   6003         JZ        $+5
   \   00005E   02....       LJMP      ??bdb_StartCommissioning_4 & 0xFFFF
    875            {
    876              bdb_initialization = TRUE;
   \   000061   7401         MOV       A,#0x1
   \   000063   F0           MOVX      @DPTR,A
    877          
    878          #ifdef BDB_REPORTING
    879              //Delete NV data if startup was with factory reset
    880              if(ZDO_INITDEV_NEW_NETWORK_STATE == ZDApp_ReadNetworkRestoreState())
   \   000064                ; Setup parameters for call to function ZDApp_ReadNetworkRestoreState
   \   000064   12....       LCALL     `??ZDApp_ReadNetworkRestoreState::?relay`; Banked call to: ZDApp_ReadNetworkRestoreState
   \   000067   E9           MOV       A,R1
   \   000068   6401         XRL       A,#0x1
   \   00006A   701A         JNZ       ??bdb_StartCommissioning_5
    881              {
    882                //Factory reset bdb reporting NV data
    883                uint16 attrRepNvLen = osal_nv_item_len( ZCD_NV_BDBREPORTINGCONFIG );
   \   00006C                ; Setup parameters for call to function osal_nv_item_len
   \   00006C   7A56         MOV       R2,#0x56
   \   00006E   7B00         MOV       R3,#0x0
   \   000070   12....       LCALL     `??osal_nv_item_len::?relay`; Banked call to: osal_nv_item_len
   \   000073   8A..         MOV       ?V2,R2
   \   000075   8B..         MOV       ?V3,R3
   \   000077   AC..         MOV       R4,?V2
   \   000079   AD..         MOV       R5,?V3
    884                if ( attrRepNvLen > 0 )
   \   00007B   EA           MOV       A,R2
   \   00007C   4D           ORL       A,R5
   \   00007D   6007         JZ        ??bdb_StartCommissioning_5
    885                {
    886                  osal_nv_delete( ZCD_NV_BDBREPORTINGCONFIG, attrRepNvLen );
   \   00007F                ; Setup parameters for call to function osal_nv_delete
   \   00007F   7A56         MOV       R2,#0x56
   \   000081   7B00         MOV       R3,#0x0
   \   000083   12....       LCALL     `??osal_nv_delete::?relay`; Banked call to: osal_nv_delete
    887                }
    888              }
    889          
    890              //Construct the Endpoint-cluster array
    891              bdb_RepConstructReportingData();
   \                     ??bdb_StartCommissioning_5:
   \   000086                ; Setup parameters for call to function bdb_RepConstructReportingData
   \   000086   12....       LCALL     `??bdb_RepConstructReportingData::?relay`; Banked call to: bdb_RepConstructReportingData
    892          #endif //BDB_REPORTING
    893          
    894              osal_nv_read(ZCD_NV_BDBNODEISONANETWORK,0,sizeof(bdbAttributes.bdbNodeIsOnANetwork),&bdbAttributes.bdbNodeIsOnANetwork);
   \   000089                ; Setup parameters for call to function osal_nv_read
   \   000089   75....       MOV       ?V2,#(bdbAttributes + 14) & 0xff
   \   00008C   75....       MOV       ?V3,#((bdbAttributes + 14) >> 8) & 0xff
   \   00008F   78..         MOV       R0,#?V2
   \   000091   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000094   75..01       MOV       ?V2,#0x1
   \   000097   75..00       MOV       ?V3,#0x0
   \   00009A   78..         MOV       R0,#?V2
   \   00009C   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00009F   7C00         MOV       R4,#0x0
   \   0000A1   7D00         MOV       R5,#0x0
   \   0000A3   7A55         MOV       R2,#0x55
   \   0000A5   7B00         MOV       R3,#0x0
   \   0000A7   12....       LCALL     `??osal_nv_read::?relay`; Banked call to: osal_nv_read
   \   0000AA   7404         MOV       A,#0x4
   \   0000AC   12....       LCALL     ?DEALLOC_XSTACK8
    895          
    896              //Are we on a network
    897              if(bdbAttributes.bdbNodeIsOnANetwork == TRUE)
   \   0000AF   90....       MOV       DPTR,#bdbAttributes + 14
   \   0000B2   E0           MOVX      A,@DPTR
   \   0000B3   6401         XRL       A,#0x1
   \   0000B5   6003         JZ        $+5
   \   0000B7   02....       LJMP      ??bdb_StartCommissioning_4 & 0xFFFF
    898              {
    899          #ifdef ZG_BUILD_JOINING_TYPE
    900                //Only for joining devices validate the joining procedure
    901                if(ZG_DEVICE_JOINING_TYPE)
   \   0000BA   90....       MOV       DPTR,#zgDeviceLogicalType
   \   0000BD   E0           MOVX      A,@DPTR
   \   0000BE   6401         XRL       A,#0x1
   \   0000C0   6008         JZ        ??bdb_StartCommissioning_6
   \   0000C2   E0           MOVX      A,@DPTR
   \   0000C3   6402         XRL       A,#0x2
   \   0000C5   6003         JZ        $+5
   \   0000C7   02....       LJMP      ??bdb_StartCommissioning_7 & 0xFFFF
    902                {
    903                  //If we got into a network
    904                  if(!osal_isbufset( AIB_apsTrustCenterAddress, 0x00, Z_EXTADDR_LEN ))
   \                     ??bdb_StartCommissioning_6:
   \   0000CA                ; Setup parameters for call to function osal_isbufset
   \   0000CA   7C08         MOV       R4,#0x8
   \   0000CC   7900         MOV       R1,#0x0
   \   0000CE   90....       MOV       DPTR,#AIB_apsTrustCenterAddress
   \   0000D1   12....       LCALL     ??Subroutine61_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_142:
   \   0000D4   12....       LCALL     `??osal_isbufset::?relay`; Banked call to: osal_isbufset
   \   0000D7   E9           MOV       A,R1
   \   0000D8   6003         JZ        $+5
   \   0000DA   02....       LJMP      ??bdb_StartCommissioning_7 & 0xFFFF
    905                  {
    906                    //Which is not distributed
    907                    if(!APSME_IsDistributedSecurity())
   \   0000DD                ; Setup parameters for call to function APSME_IsDistributedSecurity
   \   0000DD   12....       LCALL     `??APSME_IsDistributedSecurity::?relay`; Banked call to: APSME_IsDistributedSecurity
   \   0000E0   E9           MOV       A,R1
   \   0000E1   6003         JZ        $+5
   \   0000E3   02....       LJMP      ??bdb_StartCommissioning_7 & 0xFFFF
    908                    {
    909                      uint8 keyAttributes;
    910                      osal_nv_read(ZCD_NV_TCLK_TABLE_START, osal_offsetof(APSME_TCLKDevEntry_t,keyAttributes), sizeof(uint8), &keyAttributes);
   \   0000E6                ; Setup parameters for call to function osal_nv_read
   \   0000E6   A8..         MOV       R0,?XSP + 0
   \   0000E8   A9..         MOV       R1,?XSP + 1
   \   0000EA   88..         MOV       ?V2,R0
   \   0000EC   89..         MOV       ?V3,R1
   \   0000EE   78..         MOV       R0,#?V2
   \   0000F0   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000F3   75..01       MOV       ?V2,#0x1
   \   0000F6   75..00       MOV       ?V3,#0x0
   \   0000F9   78..         MOV       R0,#?V2
   \   0000FB   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000FE   7C10         MOV       R4,#0x10
   \   000100   7D00         MOV       R5,#0x0
   \   000102   7A11         MOV       R2,#0x11
   \   000104   7B01         MOV       R3,#0x1
   \   000106   12....       LCALL     `??osal_nv_read::?relay`; Banked call to: osal_nv_read
   \   000109   7404         MOV       A,#0x4
   \   00010B   12....       LCALL     ?DEALLOC_XSTACK8
    911                      //If we must perform the TCLK exchange and we didn't complete it, then reset to FN
    912                      if(requestNewTrustCenterLinkKey && (keyAttributes != ZG_NON_R21_NWK_JOINED) && (keyAttributes != ZG_VERIFIED_KEY))
   \   00010E   90....       MOV       DPTR,#requestNewTrustCenterLinkKey
   \   000111   E0           MOVX      A,@DPTR
   \   000112   7003         JNZ       $+5
   \   000114   02....       LJMP      ??bdb_StartCommissioning_7 & 0xFFFF
   \   000117   85..82       MOV       DPL,?XSP + 0
   \   00011A   85..83       MOV       DPH,?XSP + 1
   \   00011D   E0           MOVX      A,@DPTR
   \   00011E   64FD         XRL       A,#0xfd
   \   000120   607E         JZ        ??bdb_StartCommissioning_7
   \   000122   E0           MOVX      A,@DPTR
   \   000123   6402         XRL       A,#0x2
   \   000125   6079         JZ        ??bdb_StartCommissioning_7
    913                      {
    914                        //Force to initialize the entry
    915                        APSME_TCLKDevEntry_t APSME_TCLKDevEntry;
    916          
    917                        osal_memset(&APSME_TCLKDevEntry,0,sizeof(APSME_TCLKDevEntry_t));
   \   000127                ; Setup parameters for call to function osal_memset
   \   000127   7C13         MOV       R4,#0x13
   \   000129   7D00         MOV       R5,#0x0
   \   00012B   7900         MOV       R1,#0x0
   \   00012D   7401         MOV       A,#0x1
   \   00012F   12....       LCALL     ?XSTACK_DISP101_8
   \   000132   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
    918                        APSME_TCLKDevEntry.keyAttributes = ZG_DEFAULT_KEY;
   \   000135   7411         MOV       A,#0x11
   \   000137   12....       LCALL     ?XSTACK_DISP0_8
   \   00013A   74FF         MOV       A,#-0x1
   \   00013C   F0           MOVX      @DPTR,A
    919                        osal_nv_write(ZCD_NV_TCLK_TABLE_START, 0, sizeof(APSME_TCLKDevEntry_t), &APSME_TCLKDevEntry);
   \   00013D                ; Setup parameters for call to function osal_nv_write
   \   00013D   7401         MOV       A,#0x1
   \   00013F   12....       LCALL     ?XSTACK_DISP100_8
   \   000142   88..         MOV       ?V2,R0
   \   000144   89..         MOV       ?V3,R1
   \   000146   78..         MOV       R0,#?V2
   \   000148   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00014B   75..13       MOV       ?V2,#0x13
   \   00014E   75..00       MOV       ?V3,#0x0
   \   000151   78..         MOV       R0,#?V2
   \   000153   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000156   7C00         MOV       R4,#0x0
   \   000158   7D00         MOV       R5,#0x0
   \   00015A   7A11         MOV       R2,#0x11
   \   00015C   7B01         MOV       R3,#0x1
   \   00015E   12....       LCALL     ??Subroutine45_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_63:
   \   000161   12....       LCALL     ?DEALLOC_XSTACK8
    920                        TCLinkKeyFrmCntr[0].txFrmCntr = 0;
   \   000164   90....       MOV       DPTR,#TCLinkKeyFrmCntr
   \   000167   E4           CLR       A
   \   000168   F0           MOVX      @DPTR,A
   \   000169   A3           INC       DPTR
   \   00016A   F0           MOVX      @DPTR,A
   \   00016B   A3           INC       DPTR
   \   00016C   F0           MOVX      @DPTR,A
   \   00016D   A3           INC       DPTR
   \   00016E   F0           MOVX      @DPTR,A
    921                        TCLinkKeyFrmCntr[0].rxFrmCntr = 0;
   \   00016F   A3           INC       DPTR
   \   000170   F0           MOVX      @DPTR,A
   \   000171   A3           INC       DPTR
   \   000172   F0           MOVX      @DPTR,A
   \   000173   A3           INC       DPTR
   \   000174   F0           MOVX      @DPTR,A
   \   000175   A3           INC       DPTR
   \   000176   F0           MOVX      @DPTR,A
    922          
    923          
    924                        //reset the device parameters to FN
    925                        bdbAttributes.bdbNodeIsOnANetwork = FALSE;
   \   000177   90....       MOV       DPTR,#bdbAttributes + 14
   \   00017A   F0           MOVX      @DPTR,A
    926                        osal_nv_write(ZCD_NV_BDBNODEISONANETWORK,0,sizeof(bdbAttributes.bdbNodeIsOnANetwork),&bdbAttributes.bdbNodeIsOnANetwork);
   \   00017B                ; Setup parameters for call to function osal_nv_write
   \   00017B   75....       MOV       ?V2,#(bdbAttributes + 14) & 0xff
   \   00017E   75....       MOV       ?V3,#((bdbAttributes + 14) >> 8) & 0xff
   \   000181   78..         MOV       R0,#?V2
   \   000183   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000186   75..01       MOV       ?V2,#0x1
   \   000189   75..00       MOV       ?V3,#0x0
   \   00018C   78..         MOV       R0,#?V2
   \   00018E   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000191   12....       LCALL     ?Subroutine30 & 0xFFFF
   \                     ??CrossCallReturnLabel_60:
   \   000194   12....       LCALL     ?DEALLOC_XSTACK8
    927                        zgWriteStartupOptions(ZG_STARTUP_SET, ZCD_STARTOPT_DEFAULT_CONFIG_STATE | ZCD_STARTOPT_DEFAULT_NETWORK_STATE);
   \   000197                ; Setup parameters for call to function zgWriteStartupOptions
   \   000197   7A03         MOV       R2,#0x3
   \   000199   79FF         MOV       R1,#-0x1
   \   00019B   12....       LCALL     `??zgWriteStartupOptions::?relay`; Banked call to: zgWriteStartupOptions
    928          
    929                        //Then start the commissioning process requested
    930                        bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \   00019E   8040         SJMP      ??bdb_StartCommissioning_8
    931                        osal_set_event( bdb_TaskID, BDB_CHANGE_COMMISSIONING_STATE );
    932                        return;
    933                      }
    934                    }
    935                  }
    936                }
    937          #endif //ZG_BUILD_JOINING_TYPE
    938          
    939                //Set the initialization
    940                bdbAttributes.bdbCommissioningMode |= BDB_COMMISSIONING_MODE_INITIALIZATION;
    941                bdbCommissioningProcedureState.bdbCommissioningState = BDB_INITIALIZATION;
   \                     ??bdb_StartCommissioning_7:
   \   0001A0   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   0001A3   7407         MOV       A,#0x7
   \   0001A5   F0           MOVX      @DPTR,A
    942                bdbAttributes.bdbCommissioningMode |= mode & BDB_COMMISSIONING_MODES;
   \   0001A6   7410         MOV       A,#0x10
   \   0001A8   4E           ORL       A,R6
   \   0001A9   F8           MOV       R0,A
   \   0001AA   90....       MOV       DPTR,#bdbAttributes + 11
   \   0001AD   E0           MOVX      A,@DPTR
   \   0001AE   48           ORL       A,R0
   \   0001AF   F0           MOVX      @DPTR,A
    943          
    944                if(ZDOInitDevice(0) == ZDO_INITDEV_RESTORED_NETWORK_STATE)
   \   0001B0                ; Setup parameters for call to function ZDOInitDeviceEx
   \   0001B0   7900         MOV       R1,#0x0
   \   0001B2   7A00         MOV       R2,#0x0
   \   0001B4   7B00         MOV       R3,#0x0
   \   0001B6   12....       LCALL     `??ZDOInitDeviceEx::?relay`; Banked call to: ZDOInitDeviceEx
   \   0001B9   E9           MOV       A,R1
   \   0001BA   7005         JNZ       ??bdb_StartCommissioning_9
    945                {
    946          #ifdef BDB_REPORTING
    947                  //Mark the clusterEndpoint entries that have binding, starts reporting if at least one entry was marked
    948                  bdb_RepUpdateMarkBindings();
   \   0001BC                ; Setup parameters for call to function bdb_RepUpdateMarkBindings
   \   0001BC   12....       LCALL     `??bdb_RepUpdateMarkBindings::?relay`; Banked call to: bdb_RepUpdateMarkBindings
    949          #endif
    950                  return;
   \   0001BF   802F         SJMP      ??bdb_StartCommissioning_2
    951                }
    952                bdb_setNodeIsOnANetwork(FALSE);
   \                     ??bdb_StartCommissioning_9:
   \   0001C1                ; Setup parameters for call to function bdb_setNodeIsOnANetwork
   \   0001C1   7900         MOV       R1,#0x0
   \   0001C3   12....       LCALL     `??bdb_setNodeIsOnANetwork::?relay`; Banked call to: bdb_setNodeIsOnANetwork
    953                //Not in the network
    954                bdb_reportCommissioningState(BDB_INITIALIZATION,FALSE);
   \   0001C6                ; Setup parameters for call to function bdb_reportCommissioningState
   \   0001C6   7A00         MOV       R2,#0x0
   \   0001C8   7907         MOV       R1,#0x7
   \   0001CA   800F         SJMP      ??bdb_StartCommissioning_10
    955                return;
    956              }
    957            }
    958          
    959            //Got requested only to initialize, if so, report that it failed
    960            if(bdbAttributes.bdbCommissioningMode == 0)
   \                     ??bdb_StartCommissioning_4:
   \   0001CC   90....       MOV       DPTR,#bdbAttributes + 11
   \   0001CF   E0           MOVX      A,@DPTR
   \   0001D0   700E         JNZ       ??bdb_StartCommissioning_8
    961            {
    962              //Set the initialization state and report it to fail
    963              bdbCommissioningProcedureState.bdbCommissioningState = BDB_INITIALIZATION;
   \   0001D2   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   0001D5   7407         MOV       A,#0x7
   \   0001D7   F0           MOVX      @DPTR,A
    964              bdb_reportCommissioningState(BDB_INITIALIZATION,FALSE);
   \   0001D8                ; Setup parameters for call to function bdb_reportCommissioningState
   \   0001D8   7A00         MOV       R2,#0x0
   \   0001DA   F9           MOV       R1,A
   \                     ??bdb_StartCommissioning_10:
   \   0001DB   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
    965              return;
   \   0001DE   8010         SJMP      ??bdb_StartCommissioning_2
    966            }
    967          
    968          
    969            //Start the commissioning process
    970            bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \                     ??bdb_StartCommissioning_8:
   \   0001E0   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   0001E3   E4           CLR       A
   \   0001E4   F0           MOVX      @DPTR,A
    971            osal_set_event( bdb_TaskID, BDB_CHANGE_COMMISSIONING_STATE );
   \   0001E5                ; Setup parameters for call to function osal_set_event
   \   0001E5   7A04         MOV       R2,#0x4
   \   0001E7   FB           MOV       R3,A
   \   0001E8   90....       MOV       DPTR,#bdb_TaskID
   \   0001EB   E0           MOVX      A,@DPTR
   \   0001EC   F9           MOV       R1,A
   \   0001ED   12....       LCALL     `??osal_set_event::?relay`; Banked call to: osal_set_event
    972          }
   \                     ??bdb_StartCommissioning_2:
   \   0001F0   7414         MOV       A,#0x14
   \   0001F2   02....       LJMP      ??Subroutine49_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine43_0:
   \   000000   90....       MOV       DPTR,#bdb_TaskID
   \   000003   E0           MOVX      A,@DPTR
   \   000004   F9           MOV       R1,A
   \   000005   12....       LCALL     `??osal_get_timeoutEx::?relay`; Banked call to: osal_get_timeoutEx
   \   000008   EA           MOV       A,R2
   \   000009   4B           ORL       A,R3
   \   00000A   4C           ORL       A,R4
   \   00000B   4D           ORL       A,R5
   \   00000C   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine30:
   \   000000   7C00         MOV       R4,#0x0
   \   000002   7D00         MOV       R5,#0x0
   \   000004   7A55         MOV       R2,#0x55
   \   000006                REQUIRE ??Subroutine44_0
   \   000006                ; // Fall through to label ??Subroutine44_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine44_0:
   \   000000   7B00         MOV       R3,#0x0
   \   000002                REQUIRE ??Subroutine45_0
   \   000002                ; // Fall through to label ??Subroutine45_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine45_0:
   \   000000   12....       LCALL     `??osal_nv_write::?relay`; Banked call to: osal_nv_write
   \   000003   7404         MOV       A,#0x4
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine46_0:
   \   000000   E0           MOVX      A,@DPTR
   \   000001   FA           MOV       R2,A
   \   000002   A3           INC       DPTR
   \   000003   E0           MOVX      A,@DPTR
   \   000004   FB           MOV       R3,A
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine61_0:
   \   000000   12....       LCALL     ??Subroutine46_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_153:
   \   000003   22           RET
    973          
    974          
    975           /*********************************************************************
    976           * @fn          bdb_NotifyCommissioningModeStart
    977           *
    978           * @brief       Notify the user about a commissioning method just started
    979           *
    980           * @param       commissioningMode
    981           *
    982           * @return      none
    983           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    984          void bdb_NotifyCommissioningModeStart(uint8 commissioningMode)
   \                     bdb_NotifyCommissioningModeStart:
    985          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 3
   \   000005   74FD         MOV       A,#-0x3
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
    986            bdbCommissioningModeMsg_t bdbCommissioningModeMsg;
    987          
    988            bdbCommissioningModeMsg.bdbCommissioningMode = commissioningMode;
   \   00000A   7401         MOV       A,#0x1
   \   00000C   12....       LCALL     ?XSTACK_DISP0_8
   \   00000F   E9           MOV       A,R1
   \   000010   12....       LCALL     ?Subroutine9 & 0xFFFF
    989            bdbCommissioningModeMsg.bdbCommissioningStatus = BDB_COMMISSIONING_IN_PROGRESS;
   \                     ??CrossCallReturnLabel_8:
   \   000013   12....       LCALL     ?Subroutine5 & 0xFFFF
    990            //Remaining commissioning modes are set just before the call to the application to avoid race conditions
    991          
    992            bdb_NotifyApp((uint8*)&bdbCommissioningModeMsg);
   \                     ??CrossCallReturnLabel_0:
   \   000016   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000019   12....       LCALL     ?Subroutine15 & 0xFFFF
   \                     ??CrossCallReturnLabel_74:
   \   00001C   12....       LCALL     ?DEALLOC_XSTACK8
    993          }
   \   00001F   7403         MOV       A,#0x3
   \   000021   02....       LJMP      ??Subroutine59_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine5:
   \   000000   F0           MOVX      @DPTR,A
   \   000001                ; Setup parameters for call to function bdb_SendMsg
   \   000001                ; Setup parameters for call to function bdb_SendMsg
   \   000001                ; Setup parameters for call to function bdb_SendMsg
   \   000001                ; Setup parameters for call to function bdb_SendMsg
   \   000001   A8..         MOV       R0,?XSP + 0
   \   000003   A9..         MOV       R1,?XSP + 1
   \   000005   88..         MOV       ?V0,R0
   \   000007   89..         MOV       ?V1,R1
   \   000009   78..         MOV       R0,#?V0
   \   00000B   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine9:
   \   000000   F0           MOVX      @DPTR,A
   \   000001   85..82       MOV       DPL,?XSP + 0
   \   000004   85..83       MOV       DPH,?XSP + 1
   \   000007   7401         MOV       A,#0x1
   \   000009   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine15:
   \   000000   7C03         MOV       R4,#0x3
   \   000002   7B00         MOV       R3,#0x0
   \   000004   7A0A         MOV       R2,#0xa
   \   000006                REQUIRE ??Subroutine48_0
   \   000006                ; // Fall through to label ??Subroutine48_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine48_0:
   \   000000   90....       MOV       DPTR,#bdb_TaskID
   \   000003   E0           MOVX      A,@DPTR
   \   000004   F9           MOV       R1,A
   \   000005   12....       LCALL     `??bdb_SendMsg::?relay`; Banked call to: bdb_SendMsg
   \   000008   7402         MOV       A,#0x2
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine59_0:
   \   000000   12....       LCALL     ?DEALLOC_XSTACK8
   \   000003                REQUIRE ??Subroutine60_0
   \   000003                ; // Fall through to label ??Subroutine60_0
    994          
    995          
    996          
    997          #if (ZG_BUILD_JOINING_TYPE)
    998           /*********************************************************************
    999           * @fn          bdb_setNodeJoinLinkKeyType
   1000           *
   1001           * @brief       Set the key type in use in the network joined. Global centralized key is used by default
   1002           *
   1003           * @param       none
   1004           *
   1005           * @return      none
   1006           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1007          void bdb_setNodeJoinLinkKeyType(uint8 KeyType)
   \                     bdb_setNodeJoinLinkKeyType:
   1008          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1009            bdbAttributes.bdbNodeJoinLinkKeyType = KeyType;
   \   000004   E9           MOV       A,R1
   \   000005   90....       MOV       DPTR,#bdbAttributes + 15
   \   000008   02....       LJMP      ??Subroutine41_0 & 0xFFFF
   1010          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine41_0:
   \   000000   F0           MOVX      @DPTR,A
   \   000001                REQUIRE ??Subroutine42_0
   \   000001                ; // Fall through to label ??Subroutine42_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine42_0:
   \   000000   D083         POP       DPH
   \   000002   D082         POP       DPL
   \   000004   02....       LJMP      ?BRET
   1011          #endif
   1012          
   1013           /*********************************************************************
   1014           * @fn          bdb_setFN
   1015           *
   1016           * @brief       Set configuration for FN. This FN configuration will be perfome
   1017           *              upon call to ZDOInitDevice
   1018           *
   1019           * @param       none
   1020           *
   1021           * @return      none
   1022           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1023          void bdb_setFN(void)
   \                     bdb_setFN:
   1024          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1025            bdb_setNodeIsOnANetwork(FALSE);
   \   000004                ; Setup parameters for call to function bdb_setNodeIsOnANetwork
   \   000004   7900         MOV       R1,#0x0
   \   000006   12....       LCALL     `??bdb_setNodeIsOnANetwork::?relay`; Banked call to: bdb_setNodeIsOnANetwork
   1026          
   1027          #if defined ( INTER_PAN ) && defined ( BDB_TL_INITIATOR )
   1028              touchLink_InitFreeRanges( TRUE );
   1029              touchLink_UpdateNV( TOUCHLINK_UPDATE_NV_RANGES );
   1030          #endif
   1031          #if defined ( INTER_PAN ) && defined ( BDB_TL_TARGET )
   1032              touchLink_InitFreeRanges( FALSE );
   1033              touchLink_UpdateNV( TOUCHLINK_UPDATE_NV_RANGES );
   1034          #endif
   1035          
   1036            //Set the device as factory new
   1037            zgWriteStartupOptions(ZG_STARTUP_SET, ZCD_STARTOPT_DEFAULT_CONFIG_STATE | ZCD_STARTOPT_DEFAULT_NETWORK_STATE);
   \   000009                ; Setup parameters for call to function zgWriteStartupOptions
   \   000009   7A03         MOV       R2,#0x3
   \   00000B   79FF         MOV       R1,#-0x1
   \   00000D   12....       LCALL     `??zgWriteStartupOptions::?relay`; Banked call to: zgWriteStartupOptions
   1038          }
   \   000010   02....       LJMP      ??Subroutine42_0 & 0xFFFF
   1039          
   1040           /*********************************************************************
   1041           * @fn          bdb_resetLocalAction
   1042           *
   1043           * @brief       Application interface to perform BDB Reset to FN.
   1044           *
   1045           * @param       none
   1046           *
   1047           * @return      none
   1048           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1049          void bdb_resetLocalAction(void)
   \                     bdb_resetLocalAction:
   1050          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 5
   \   000004   74FB         MOV       A,#-0x5
   \   000006   12....       LCALL     ?ALLOC_XSTACK8
   1051            //Process reset as nwk leave if the device is on the network and is able to process it
   1052            if((ZG_BUILD_JOINING_TYPE) && (bdbAttributes.bdbNodeIsOnANetwork) && (!(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_PARENT_LOST)))
   \   000009   90....       MOV       DPTR,#bdbAttributes + 14
   \   00000C   E0           MOVX      A,@DPTR
   \   00000D   6021         JZ        ??bdb_resetLocalAction_0
   \   00000F   90....       MOV       DPTR,#bdbAttributes + 11
   \   000012   E0           MOVX      A,@DPTR
   \   000013   A2E5         MOV       C,0xE0 /* A   */.5
   \   000015   4019         JC        ??bdb_resetLocalAction_0
   1053            {
   1054              NLME_LeaveReq_t leaveReq;
   1055              // Set every field to 0
   1056              osal_memset( &leaveReq, 0, sizeof( NLME_LeaveReq_t ) );
   \   000017                ; Setup parameters for call to function osal_memset
   \   000017   7C05         MOV       R4,#0x5
   \   000019   7D00         MOV       R5,#0x0
   \   00001B   7900         MOV       R1,#0x0
   \   00001D   AA..         MOV       R2,?XSP + 0
   \   00001F   AB..         MOV       R3,?XSP + 1
   \   000021   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
   1057          
   1058              bdb_setFN();
   \   000024                ; Setup parameters for call to function bdb_setFN
   \   000024   12....       LCALL     `??bdb_setFN::?relay`; Banked call to: bdb_setFN
   1059          
   1060              NLME_LeaveReq( &leaveReq );
   \   000027                ; Setup parameters for call to function NLME_LeaveReq
   \   000027   AA..         MOV       R2,?XSP + 0
   \   000029   AB..         MOV       R3,?XSP + 1
   \   00002B   12....       LCALL     `??NLME_LeaveReq::?relay`; Banked call to: NLME_LeaveReq
   1061          
   1062              return;
   \   00002E   800A         SJMP      ??bdb_resetLocalAction_1
   1063            }
   1064            else
   1065            {
   1066              bdb_setFN();
   \                     ??bdb_resetLocalAction_0:
   \   000030                ; Setup parameters for call to function bdb_setFN
   \   000030   12....       LCALL     `??bdb_setFN::?relay`; Banked call to: bdb_setFN
   1067          
   1068              ZDApp_ResetTimerStart( 500 );
   \   000033                ; Setup parameters for call to function ZDApp_ResetTimerStart
   \   000033   7AF4         MOV       R2,#-0xc
   \   000035   7B01         MOV       R3,#0x1
   \   000037   12....       LCALL     `??ZDApp_ResetTimerStart::?relay`; Banked call to: ZDApp_ResetTimerStart
   1069            }
   1070          }
   \                     ??bdb_resetLocalAction_1:
   \   00003A   7405         MOV       A,#0x5
   \   00003C                REQUIRE ?Subroutine4
   \   00003C                ; // Fall through to label ?Subroutine4

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   12....       LCALL     ?DEALLOC_XSTACK8
   \   000003   02....       LJMP      ??Subroutine42_0 & 0xFFFF
   1071          
   1072          
   1073           /*********************************************************************
   1074           * @fn          bdb_parentLost
   1075           *
   1076           * @brief       Notify bdb that connection with parent is lost
   1077           *
   1078           * @return      none
   1079           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1080          void bdb_parentLost(void)
   \                     bdb_parentLost:
   1081          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 1
   \   000004   74FF         MOV       A,#-0x1
   \   000006   12....       LCALL     ?ALLOC_XSTACK8
   1082          #if ZG_BUILD_ENDDEVICE_TYPE
   1083            if(ZG_DEVICE_ENDDEVICE_TYPE)
   \   000009   8003         SJMP      ??CrossCallReturnLabel_14
   1084            {
   1085              while(pBDBListNwk)
   1086              {
   1087                bdb_nwkDescFree(pBDBListNwk);
   \                     ??bdb_parentLost_0:
   \   00000B                ; Setup parameters for call to function bdb_nwkDescFree
   \   00000B   12....       LCALL     ?Subroutine18 & 0xFFFF
   1088              }
   \                     ??CrossCallReturnLabel_14:
   \   00000E   90....       MOV       DPTR,#pBDBListNwk
   \   000011   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_94:
   \   000014   70F5         JNZ       ??bdb_parentLost_0
   1089          
   1090              nwk_desc_list_free();
   \   000016                ; Setup parameters for call to function nwk_desc_list_free
   \   000016   12....       LCALL     `??nwk_desc_list_free::?relay`; Banked call to: nwk_desc_list_free
   1091              if(bdbCommissioningProcedureState.bdbCommissioningState != BDB_PARENT_LOST)
   \   000019   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   00001C   E0           MOVX      A,@DPTR
   \   00001D   6408         XRL       A,#0x8
   \   00001F   6010         JZ        ??bdb_parentLost_1
   1092              {
   1093                //If parent lost during TCLK exchange, then report TCLK exchange fail
   1094                if(bdbCommissioningProcedureState.bdbCommissioningState == BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE)
   \   000021   E0           MOVX      A,@DPTR
   \   000022   6401         XRL       A,#0x1
   \   000024   7006         JNZ       ??bdb_parentLost_2
   1095                {
   1096                  bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE, FALSE);
   \   000026                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000026   7A00         MOV       R2,#0x0
   \   000028   7901         MOV       R1,#0x1
   \   00002A   8021         SJMP      ??bdb_parentLost_3
   1097                  return;
   1098                }
   1099                bdbCommissioningProcedureState.bdb_ParentLostSavedState = bdbCommissioningProcedureState.bdbCommissioningState;
   \                     ??bdb_parentLost_2:
   \   00002C   E0           MOVX      A,@DPTR
   \   00002D   90....       MOV       DPTR,#bdbCommissioningProcedureState + 3
   \   000030   F0           MOVX      @DPTR,A
   1100          
   1101              }
   1102              bdbCommissioningProcedureState.bdbCommissioningState = BDB_PARENT_LOST;
   \                     ??bdb_parentLost_1:
   \   000031   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000034   7408         MOV       A,#0x8
   \   000036   F0           MOVX      @DPTR,A
   1103              NLME_OrphanStateSet();
   \   000037                ; Setup parameters for call to function NLME_OrphanStateSet
   \   000037   12....       LCALL     `??NLME_OrphanStateSet::?relay`; Banked call to: NLME_OrphanStateSet
   1104              ZDApp_ChangeState( DEV_NWK_ORPHAN );
   \   00003A                ; Setup parameters for call to function ZDApp_ChangeState
   \   00003A   790A         MOV       R1,#0xa
   \   00003C   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1105          
   1106              // turn receiver off while in orphan state
   1107              byte temp = FALSE;
   \   00003F   85..82       MOV       DPL,?XSP + 0
   \   000042   85..83       MOV       DPH,?XSP + 1
   \   000045   E4           CLR       A
   \   000046   12....       LCALL     ?Subroutine6 & 0xFFFF
   1108              ZMacSetReq(ZMacRxOnIdle, &temp);
   1109          
   1110              bdb_reportCommissioningState(BDB_PARENT_LOST,FALSE);
   \                     ??CrossCallReturnLabel_4:
   \   000049                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000049   7A00         MOV       R2,#0x0
   \   00004B   7908         MOV       R1,#0x8
   \                     ??bdb_parentLost_3:
   \   00004D   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   1111            }
   1112          #endif
   1113          }
   \   000050   7401         MOV       A,#0x1
   \   000052   80..         SJMP      ?Subroutine4

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine18:
   \   000000   12....       LCALL     ?Subroutine36 & 0xFFFF
   \                     ??CrossCallReturnLabel_151:
   \   000003   12....       LCALL     `??bdb_nwkDescFree::?relay`; Banked call to: bdb_nwkDescFree
   \   000006   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine6:
   \   000000   F0           MOVX      @DPTR,A
   \   000001                ; Setup parameters for call to function ZMacSetReq
   \   000001                ; Setup parameters for call to function ZMacSetReq
   \   000001   AA..         MOV       R2,?XSP + 0
   \   000003   AB..         MOV       R3,?XSP + 1
   \   000005   7952         MOV       R1,#0x52
   \   000007   12....       LCALL     `??ZMacSetReq::?relay`; Banked call to: ZMacSetReq
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine36:
   \   000000   90....       MOV       DPTR,#pBDBListNwk
   \   000003                REQUIRE ??Subroutine46_0
   \   000003                ; // Fall through to label ??Subroutine46_0
   1114          
   1115          
   1116          
   1117          
   1118          
   1119           /*********************************************************************
   1120           * @fn          bdb_NetworkRestoredResumeState
   1121           *
   1122           * @brief       Restore the state of child device after parent lost
   1123           *
   1124           * @return      none
   1125           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1126          void bdb_NetworkRestoredResumeState(void)
   \                     bdb_NetworkRestoredResumeState:
   1127          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1128          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
   1129          #if ZG_BUILD_ENDDEVICE_TYPE
   1130            if(ZG_DEVICE_ENDDEVICE_TYPE)
   1131            {
   1132              uint8 restoreSimpleDesc = FALSE;
   \   000004   7A00         MOV       R2,#0x0
   1133              //If restored when F&B still enabled, then restore the simple descriptors attempts
   1134              if(bdbCommissioningProcedureState.bdbCommissioningState == BDB_COMMISSIONING_STATE_FINDING_BINDING)
   \   000006   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000009   E0           MOVX      A,@DPTR
   \   00000A   6406         XRL       A,#0x6
   \   00000C   703F         JNZ       ??bdb_NetworkRestoredResumeState_0
   1135              {
   1136                bdbFindingBindingRespondent_t  *pRespondentTemp = NULL;
   1137          
   1138                pRespondentTemp = pRespondentHead;
   \   00000E   90....       MOV       DPTR,#pRespondentHead
   \   000011   12....       LCALL     ?Subroutine27 & 0xFFFF
   \                     ??CrossCallReturnLabel_27:
   \   000014   EC           MOV       A,R4
   \   000015   F8           MOV       R0,A
   \   000016   ED           MOV       A,R5
   \   000017   801A         SJMP      ??CrossCallReturnLabel_107
   1139          
   1140                while(pRespondentTemp != NULL)
   1141                {
   1142                  if(pRespondentTemp->attempts & FINDING_AND_BINDING_PARENT_LOST)
   \                     ??bdb_NetworkRestoredResumeState_1:
   \   000019   E8           MOV       A,R0
   \   00001A   240C         ADD       A,#0xc
   \   00001C   F582         MOV       DPL,A
   \   00001E   E4           CLR       A
   \   00001F   39           ADDC      A,R1
   \   000020   F583         MOV       DPH,A
   \   000022   E0           MOVX      A,@DPTR
   \   000023   A2E6         MOV       C,0xE0 /* A   */.6
   \   000025   5005         JNC       ??bdb_NetworkRestoredResumeState_2
   1143                  {
   1144                    pRespondentTemp->attempts &= ~FINDING_AND_BINDING_PARENT_LOST;
   \   000027   C2E6         CLR       0xE0 /* A   */.6
   \   000029   F0           MOVX      @DPTR,A
   1145                    restoreSimpleDesc = TRUE;
   \   00002A   7A01         MOV       R2,#0x1
   1146                  }
   1147                  pRespondentTemp = pRespondentTemp->pNext;
   \                     ??bdb_NetworkRestoredResumeState_2:
   \   00002C   E8           MOV       A,R0
   \   00002D   12....       LCALL     ?Subroutine40 & 0xFFFF
   1148                }
   \                     ??CrossCallReturnLabel_55:
   \   000030   12....       LCALL     ?Subroutine38 & 0xFFFF
   \                     ??CrossCallReturnLabel_107:
   \   000033   F9           MOV       R1,A
   \   000034   E8           MOV       A,R0
   \   000035   49           ORL       A,R1
   \   000036   70E1         JNZ       ??bdb_NetworkRestoredResumeState_1
   1149              }
   1150              if(restoreSimpleDesc)
   \   000038   EA           MOV       A,R2
   \   000039   A2E0         MOV       C,0xE0 /* A   */.0
   \   00003B   5010         JNC       ??bdb_NetworkRestoredResumeState_0
   1151              {
   1152                //Restore the simple Descriptor sending after 1 second of restoring the network
   1153                osal_start_timerEx(bdb_TaskID,BDB_RESPONDENT_PROCESS_TIMEOUT, 1000);
   \   00003D                ; Setup parameters for call to function osal_start_timerEx
   \   00003D   90....       MOV       DPTR,#__Constant_3e8
   \   000040   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000043   7A00         MOV       R2,#0x0
   \   000045   7B40         MOV       R3,#0x40
   \   000047   12....       LCALL     ??Subroutine56_0 & 0xFFFF
   1154              }
   1155            }
   \                     ??CrossCallReturnLabel_132:
   \   00004A   12....       LCALL     ?DEALLOC_XSTACK8
   1156          #endif
   1157          #endif
   1158          }
   \                     ??bdb_NetworkRestoredResumeState_0:
   \   00004D   80..         SJMP      ??Subroutine42_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine40:
   \   000000   240F         ADD       A,#0xf
   \   000002   F582         MOV       DPL,A
   \   000004   E4           CLR       A
   \   000005   39           ADDC      A,R1
   \   000006   F583         MOV       DPH,A
   \   000008   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine27:
   \   000000   E0           MOVX      A,@DPTR
   \   000001   FC           MOV       R4,A
   \   000002   A3           INC       DPTR
   \   000003   E0           MOVX      A,@DPTR
   \   000004   FD           MOV       R5,A
   \   000005   22           RET
   1159          
   1160          #if ZG_BUILD_ENDDEVICE_TYPE
   1161           /*********************************************************************
   1162           * @fn          bdb_ZedAttemptRecoverNwk
   1163           *
   1164           * @brief       Instruct the ZED to try to rejoin its previews network
   1165           *
   1166           * @return      success if the attempt is being excecuted
   1167           *              False if device do not have nwk parameters to perform this action
   1168           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1169          uint8 bdb_ZedAttemptRecoverNwk(void)
   \                     bdb_ZedAttemptRecoverNwk:
   1170          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1171            if(ZG_DEVICE_ENDDEVICE_TYPE)
   1172            {
   1173              if(bdbAttributes.bdbNodeIsOnANetwork)
   \   000004   90....       MOV       DPTR,#bdbAttributes + 14
   \   000007   E0           MOVX      A,@DPTR
   \   000008   6018         JZ        ??bdb_ZedAttemptRecoverNwk_0
   1174              {
   1175                if(bdbCommissioningProcedureState.bdbCommissioningState == BDB_PARENT_LOST)
   \   00000A   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   00000D   E0           MOVX      A,@DPTR
   \   00000E   6408         XRL       A,#0x8
   \   000010   7010         JNZ       ??bdb_ZedAttemptRecoverNwk_0
   1176                {
   1177                  if(ZDOInitDevice(0) == ZDO_INITDEV_RESTORED_NETWORK_STATE)
   \   000012                ; Setup parameters for call to function ZDOInitDeviceEx
   \   000012   7900         MOV       R1,#0x0
   \   000014   7A00         MOV       R2,#0x0
   \   000016   7B00         MOV       R3,#0x0
   \   000018   12....       LCALL     `??ZDOInitDeviceEx::?relay`; Banked call to: ZDOInitDeviceEx
   \   00001B   E9           MOV       A,R1
   \   00001C   7004         JNZ       ??bdb_ZedAttemptRecoverNwk_0
   1178                  {
   1179                    return ZSuccess;
   \   00001E   7900         MOV       R1,#0x0
   \   000020   8002         SJMP      ??bdb_ZedAttemptRecoverNwk_1
   1180                  }
   1181                }
   1182              }
   1183            }
   1184            return ZFailure;
   \                     ??bdb_ZedAttemptRecoverNwk_0:
   \   000022   7901         MOV       R1,#0x1
   \                     ??bdb_ZedAttemptRecoverNwk_1:
   \   000024   80..         SJMP      ??Subroutine42_0
   1185          }
   1186          
   1187          #endif
   1188          
   1189           /*********************************************************************
   1190           * @fn          bdb_reportCommissioningState
   1191           *
   1192           * @brief       Process the result of a BDB main state attempt.
   1193           *
   1194           * @param       bdbCommissioningState - MainState that is issuing fail
   1195           * @param       didSuccess - TRUE if the main state were success, FALSE otherwise
   1196           *
   1197           * @return      none
   1198           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1199          void bdb_reportCommissioningState(uint8 bdbCommissioningState,bool didSuccess)
   \                     bdb_reportCommissioningState:
   1200          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 4
   \   000005   74FC         MOV       A,#-0x4
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   E9           MOV       A,R1
   \   00000B   FE           MOV       R6,A
   \   00000C   EA           MOV       A,R2
   \   00000D   FF           MOV       R7,A
   1201            bdbCommissioningModeMsg_t bdbCommissioningModeMsg;
   1202            //Process only if we are in that state, or if we are on parent lost and processing F&B
   1203            if((bdbCommissioningProcedureState.bdbCommissioningState == bdbCommissioningState)
   1204               || ((bdbCommissioningProcedureState.bdbCommissioningState == BDB_PARENT_LOST) && (bdbCommissioningProcedureState.bdb_ParentLostSavedState == BDB_COMMISSIONING_STATE_FINDING_BINDING)))
   \   00000E   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000011   E0           MOVX      A,@DPTR
   \   000012   6E           XRL       A,R6
   \   000013   6013         JZ        ??bdb_reportCommissioningState_0
   \   000015   E0           MOVX      A,@DPTR
   \   000016   6408         XRL       A,#0x8
   \   000018   6003         JZ        $+5
   \   00001A   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   \   00001D   90....       MOV       DPTR,#bdbCommissioningProcedureState + 3
   \   000020   E0           MOVX      A,@DPTR
   \   000021   6406         XRL       A,#0x6
   \   000023   6003         JZ        $+5
   \   000025   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   1205            {
   1206              switch(bdbCommissioningState)
   \                     ??bdb_reportCommissioningState_0:
   \   000028   E9           MOV       A,R1
   \   000029   14           DEC       A
   \   00002A   7003         JNZ       $+5
   \   00002C   02....       LJMP      ??bdb_reportCommissioningState_2 & 0xFFFF
   \   00002F   14           DEC       A
   \   000030   7003         JNZ       $+5
   \   000032   02....       LJMP      ??bdb_reportCommissioningState_3 & 0xFFFF
   \   000035   14           DEC       A
   \   000036   6021         JZ        ??bdb_reportCommissioningState_4
   \   000038   14           DEC       A
   \   000039   7003         JNZ       $+5
   \   00003B   02....       LJMP      ??bdb_reportCommissioningState_5 & 0xFFFF
   \   00003E   14           DEC       A
   \   00003F   7003         JNZ       $+5
   \   000041   02....       LJMP      ??bdb_reportCommissioningState_6 & 0xFFFF
   \   000044   14           DEC       A
   \   000045   7003         JNZ       $+5
   \   000047   02....       LJMP      ??bdb_reportCommissioningState_7 & 0xFFFF
   \   00004A   14           DEC       A
   \   00004B   7003         JNZ       $+5
   \   00004D   02....       LJMP      ??bdb_reportCommissioningState_8 & 0xFFFF
   \   000050   14           DEC       A
   \   000051   7003         JNZ       $+5
   \   000053   02....       LJMP      ??bdb_reportCommissioningState_9 & 0xFFFF
   \   000056   02....       LJMP      ??bdb_reportCommissioningState_10 & 0xFFFF
   1207              {
   1208          #if (ZG_BUILD_JOINING_TYPE)
   1209                case BDB_COMMISSIONING_STATE_JOINING:
   1210                  if(ZG_DEVICE_JOINING_TYPE)
   \                     ??bdb_reportCommissioningState_4:
   \   000059   90....       MOV       DPTR,#zgDeviceLogicalType
   \   00005C   E0           MOVX      A,@DPTR
   \   00005D   6401         XRL       A,#0x1
   \   00005F   6008         JZ        ??bdb_reportCommissioningState_11
   \   000061   E0           MOVX      A,@DPTR
   \   000062   6402         XRL       A,#0x2
   \   000064   6003         JZ        $+5
   \   000066   02....       LJMP      ??bdb_reportCommissioningState_10 & 0xFFFF
   1211                  {
   1212                    //Prepare for the next state or commissioning mode to be excecuted
   1213                    osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,50);
   \                     ??bdb_reportCommissioningState_11:
   \   000069                ; Setup parameters for call to function osal_start_timerEx
   \   000069   90....       MOV       DPTR,#__Constant_32
   \   00006C   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   00006F   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_120:
   \   000072   12....       LCALL     ?DEALLOC_XSTACK8
   1214          
   1215                    if(didSuccess)
   \   000075   EF           MOV       A,R7
   \   000076   601F         JZ        ??bdb_reportCommissioningState_12
   1216                    {
   1217                      //Next state is TC link key exchange
   1218                      bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE;
   \   000078   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   00007B   7401         MOV       A,#0x1
   \   00007D   F0           MOVX      @DPTR,A
   \   00007E   8003         SJMP      ??CrossCallReturnLabel_15
   1219                      //Free the list of nwk discovered
   1220                      while(pBDBListNwk)
   1221                      {
   1222                        bdb_nwkDescFree(pBDBListNwk);
   \                     ??bdb_reportCommissioningState_13:
   \   000080                ; Setup parameters for call to function bdb_nwkDescFree
   \   000080   12....       LCALL     ?Subroutine18 & 0xFFFF
   1223                      }
   \                     ??CrossCallReturnLabel_15:
   \   000083   90....       MOV       DPTR,#pBDBListNwk
   \   000086   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_95:
   \   000089   70F5         JNZ       ??bdb_reportCommissioningState_13
   1224          
   1225                      //Set the poll rate of the ZED joining device to 1 second to allow TCLK
   1226                      //exchange be perfomed successfully in cases in which application has a
   1227                      //slow pollrate
   1228                      NLME_SetPollRate(TCLK_POLL_RATE);
   \   00008B                ; Setup parameters for call to function NLME_SetPollRate
   \   00008B   90....       MOV       DPTR,#__Constant_3e8
   \   00008E   12....       LCALL     ?XLOAD_R2345
   \   000091   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1229          
   1230                      //No notification in this step
   1231                      return;
   \   000094   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   1232                    }
   1233                    else
   1234                    {
   1235                    	AT_ERROR(AT_NO_NETWORK);
   \                     ??bdb_reportCommissioningState_12:
   \   000097                ; Setup parameters for call to function AT_UARTWriteErrMsg
   \   000097   7A01         MOV       R2,#0x1
   \   000099   7927         MOV       R1,#0x27
   \   00009B   12....       LCALL     `??AT_UARTWriteErrMsg::?relay`; Banked call to: AT_UARTWriteErrMsg
   1236                      uint8 temp = FALSE;
   \   00009E   7403         MOV       A,#0x3
   \   0000A0   12....       LCALL     ?XSTACK_DISP0_8
   \   0000A3   E4           CLR       A
   \   0000A4   F0           MOVX      @DPTR,A
   1237                      //If fail, then restore poll rate
   1238                      NLME_SetPollRate(POLL_RATE);
   \   0000A5                ; Setup parameters for call to function NLME_SetPollRate
   \   0000A5   90....       MOV       DPTR,#__Constant_12c
   \   0000A8   12....       LCALL     ?XLOAD_R2345
   \   0000AB   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1239                      bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_NO_NETWORK;
   \   0000AE   90....       MOV       DPTR,#bdbAttributes + 10
   \   0000B1   7402         MOV       A,#0x2
   \   0000B3   F0           MOVX      @DPTR,A
   1240                      bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_NWK_STEERING;
   \   0000B4   14           DEC       A
   \   0000B5   12....       LCALL     ?XSTACK_DISP0_8
   \   0000B8   7401         MOV       A,#0x1
   \   0000BA   F0           MOVX      @DPTR,A
   1241                      bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \   0000BB   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   0000BE   E4           CLR       A
   \   0000BF   F0           MOVX      @DPTR,A
   1242                      bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_NWK_STEERING;
   \   0000C0   90....       MOV       DPTR,#bdbAttributes + 11
   \   0000C3   E0           MOVX      A,@DPTR
   \   0000C4   C2E1         CLR       0xE0 /* A   */.1
   \   0000C6   F0           MOVX      @DPTR,A
   1243          
   1244                      //Turn off the radio
   1245                      ZMacSetReq(ZMacRxOnIdle, &temp);
   \   0000C7                ; Setup parameters for call to function ZMacSetReq
   \   0000C7   7403         MOV       A,#0x3
   \   0000C9   12....       LCALL     ?XSTACK_DISP101_8
   \   0000CC   7952         MOV       R1,#0x52
   \   0000CE   12....       LCALL     `??ZMacSetReq::?relay`; Banked call to: ZMacSetReq
   1246                      //Set the device to FN, to start as new for subsequent attempts
   1247                      bdb_setFN();
   \   0000D1                ; Setup parameters for call to function bdb_setFN
   \   0000D1   12....       LCALL     `??bdb_setFN::?relay`; Banked call to: bdb_setFN
   1248                      NLME_ResetRequest();
   \   0000D4                ; Setup parameters for call to function NLME_ResetRequest
   \   0000D4   12....       LCALL     `??NLME_ResetRequest::?relay`; Banked call to: NLME_ResetRequest
   1249                      ZDApp_ChangeState( DEV_HOLD );
   \   0000D7                ; Setup parameters for call to function ZDApp_ChangeState
   \   0000D7   7900         MOV       R1,#0x0
   \   0000D9   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1250          
   1251                      //Free the list of nwk discovered
   1252                      while(pBDBListNwk)
   \                     ??bdb_reportCommissioningState_14:
   \   0000DC   90....       MOV       DPTR,#pBDBListNwk
   \   0000DF   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_96:
   \   0000E2   7003         JNZ       $+5
   \   0000E4   02....       LJMP      ??bdb_reportCommissioningState_10 & 0xFFFF
   1253                      {
   1254                        bdb_nwkDescFree(pBDBListNwk);
   \   0000E7                ; Setup parameters for call to function bdb_nwkDescFree
   \   0000E7   12....       LCALL     ?Subroutine18 & 0xFFFF
   1255                      }
   1256                    }
   1257                  }
   \                     ??CrossCallReturnLabel_16:
   \   0000EA   80F0         SJMP      ??bdb_reportCommissioningState_14
   1258                break;
   1259          
   1260                case BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE:
   1261                  if(ZG_DEVICE_JOINING_TYPE)
   \                     ??bdb_reportCommissioningState_2:
   \   0000EC   90....       MOV       DPTR,#zgDeviceLogicalType
   \   0000EF   E0           MOVX      A,@DPTR
   \   0000F0   6401         XRL       A,#0x1
   \   0000F2   6008         JZ        ??bdb_reportCommissioningState_15
   \   0000F4   E0           MOVX      A,@DPTR
   \   0000F5   6402         XRL       A,#0x2
   \   0000F7   6003         JZ        $+5
   \   0000F9   02....       LJMP      ??bdb_reportCommissioningState_10 & 0xFFFF
   1262                  {
   1263                    if(didSuccess)
   \                     ??bdb_reportCommissioningState_15:
   \   0000FC   EA           MOV       A,R2
   \   0000FD   6027         JZ        ??bdb_reportCommissioningState_16
   1264                    {
   1265                      //Clear any setting that would set the device as FN
   1266                      zgWriteStartupOptions(ZG_STARTUP_CLEAR, ZCD_STARTOPT_DEFAULT_CONFIG_STATE | ZCD_STARTOPT_DEFAULT_NETWORK_STATE);
   \   0000FF                ; Setup parameters for call to function zgWriteStartupOptions
   \   0000FF   7A03         MOV       R2,#0x3
   \   000101   7900         MOV       R1,#0x0
   \   000103   12....       LCALL     `??zgWriteStartupOptions::?relay`; Banked call to: zgWriteStartupOptions
   1267          
   1268                      //Next state is nwk steering on the nwk (permit joining)
   1269                      bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_STEERING_ON_NWK;
   \   000106   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000109   7404         MOV       A,#0x4
   \   00010B   12....       LCALL     ??Subroutine58_0 & 0xFFFF
   1270                      osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE, 50);
   \                     ??CrossCallReturnLabel_140:
   \   00010E   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000111   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_121:
   \   000114   12....       LCALL     ?DEALLOC_XSTACK8
   1271          
   1272                      //Set the poll rate to the application default after TCLK success
   1273                      NLME_SetPollRate(POLL_RATE);
   \   000117                ; Setup parameters for call to function NLME_SetPollRate
   \   000117   90....       MOV       DPTR,#__Constant_12c
   \   00011A   12....       LCALL     ?XLOAD_R2345
   \   00011D   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1274          
   1275                      osal_stop_timerEx( bdb_TaskID, BDB_PROCESS_TIMEOUT );
   \   000120                ; Setup parameters for call to function osal_stop_timerEx
   \   000120   12....       LCALL     ?Subroutine17 & 0xFFFF
   1276                      //No notification to the user is needed
   1277                      return;
   \                     ??CrossCallReturnLabel_65:
   \   000123   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   1278                    }
   1279                    else
   1280                    {
   1281                      bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_NWK_STEERING;
   \                     ??bdb_reportCommissioningState_16:
   \   000126   7401         MOV       A,#0x1
   \   000128   12....       LCALL     ?XSTACK_DISP0_8
   \   00012B   7401         MOV       A,#0x1
   \   00012D   F0           MOVX      @DPTR,A
   1282                      bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_TCLK_EX_FAILURE;
   \   00012E   90....       MOV       DPTR,#bdbAttributes + 10
   \   000131   7407         MOV       A,#0x7
   \   000133   F0           MOVX      @DPTR,A
   1283          
   1284                      osal_stop_timerEx( bdb_TaskID, BDB_PROCESS_TIMEOUT);
   \   000134                ; Setup parameters for call to function osal_stop_timerEx
   \   000134   12....       LCALL     ?Subroutine17 & 0xFFFF
   1285          
   1286                      //No process shall be attempted after this fail
   1287                      bdbAttributes.bdbCommissioningMode = 0;
   \                     ??CrossCallReturnLabel_66:
   \   000137   90....       MOV       DPTR,#bdbAttributes + 11
   \   00013A   E4           CLR       A
   \   00013B   F0           MOVX      @DPTR,A
   1288          
   1289                      //Fill the context for the user notification
   1290                      osal_start_timerEx(bdb_TaskID,BDB_TC_LINK_KEY_EXCHANGE_FAIL,BDB_TC_LINK_KEY_EXCHANGE_FAIL_LEAVE_TIMEOUT);
   \   00013C                ; Setup parameters for call to function osal_start_timerEx
   \   00013C   90....       MOV       DPTR,#__Constant_1388
   \   00013F   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000142   7A02         MOV       R2,#0x2
   \   000144   12....       LCALL     ??Subroutine55_0 & 0xFFFF
   1291                    }
   1292                  }
   \                     ??CrossCallReturnLabel_128:
   \   000147   12....       LCALL     ?DEALLOC_XSTACK8
   \   00014A   02....       LJMP      ??bdb_reportCommissioningState_10 & 0xFFFF
   1293                break;
   1294          #endif
   1295          
   1296                case BDB_COMMISSIONING_STATE_STEERING_ON_NWK:
   1297                  bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_NWK_STEERING;
   \                     ??bdb_reportCommissioningState_5:
   \   00014D   7401         MOV       A,#0x1
   \   00014F   12....       LCALL     ?XSTACK_DISP0_8
   \   000152   7401         MOV       A,#0x1
   \   000154   F0           MOVX      @DPTR,A
   1298                  if(didSuccess)
   \   000155   EA           MOV       A,R2
   \   000156   600A         JZ        ??bdb_reportCommissioningState_17
   1299                  {
   1300                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_SUCCESS;
   \   000158   90....       MOV       DPTR,#bdbAttributes + 10
   \   00015B   E4           CLR       A
   \   00015C   F0           MOVX      @DPTR,A
   1301          
   1302          #if (ZG_BUILD_RTR_TYPE)
   1303                    //Update ZDApp state
   1304                    if(ZG_DEVICE_RTRONLY_TYPE)
   1305                    {
   1306                      ZDApp_ChangeState( DEV_ROUTER );
   1307                    }
   1308          #endif
   1309          #if (ZG_BUILD_ENDDEVICE_TYPE)
   1310                    if(ZG_DEVICE_ENDDEVICE_TYPE)
   1311                    {
   1312                      ZDApp_ChangeState( DEV_END_DEVICE );
   \   00015D                ; Setup parameters for call to function ZDApp_ChangeState
   \   00015D   7906         MOV       R1,#0x6
   \   00015F   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1313                    }
   1314          #endif
   1315                  }
   1316          #if (ZG_BUILD_COORDINATOR_TYPE)
   1317                  else
   1318                  {
   1319                    if(ZG_DEVICE_COORDINATOR_TYPE)
   1320                    {
   1321                      bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_NO_NETWORK;
   1322                    }
   1323                  }
   1324          #endif
   1325          
   1326                  bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \                     ??bdb_reportCommissioningState_17:
   \   000162   12....       LCALL     ?Subroutine12 & 0xFFFF
   1327                  osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,50);
   \                     ??CrossCallReturnLabel_136:
   \   000165   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000168   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_122:
   \   00016B   12....       LCALL     ?DEALLOC_XSTACK8
   1328                  bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_NWK_STEERING;
   \   00016E   90....       MOV       DPTR,#bdbAttributes + 11
   \   000171   E0           MOVX      A,@DPTR
   \   000172   C2E1         CLR       0xE0 /* A   */.1
   \   000174   02....       LJMP      ??bdb_reportCommissioningState_18 & 0xFFFF
   1329                break;
   1330          
   1331                case BDB_COMMISSIONING_STATE_FORMATION:
   1332                  bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_FORMATION;
   \                     ??bdb_reportCommissioningState_6:
   \   000177   7401         MOV       A,#0x1
   \   000179   12....       LCALL     ?XSTACK_DISP0_8
   \   00017C   7402         MOV       A,#0x2
   \   00017E   F0           MOVX      @DPTR,A
   1333          
   1334                  if(didSuccess)
   \   00017F   EA           MOV       A,R2
   \   000180   90....       MOV       DPTR,#bdbAttributes + 10
   \   000183   600A         JZ        ??bdb_reportCommissioningState_19
   1335                  {
   1336                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_SUCCESS;
   \   000185   E4           CLR       A
   \   000186   F0           MOVX      @DPTR,A
   1337          
   1338                    //Clear any setting that would set the device as FN
   1339                    zgWriteStartupOptions(ZG_STARTUP_CLEAR, ZCD_STARTOPT_DEFAULT_CONFIG_STATE | ZCD_STARTOPT_DEFAULT_NETWORK_STATE);
   \   000187                ; Setup parameters for call to function zgWriteStartupOptions
   \   000187   7A03         MOV       R2,#0x3
   \   000189   F9           MOV       R1,A
   \   00018A   12....       LCALL     `??zgWriteStartupOptions::?relay`; Banked call to: zgWriteStartupOptions
   \   00018D   8003         SJMP      ??bdb_reportCommissioningState_20
   1340          
   1341                     //Update ZDApp State
   1342          #if (ZG_BUILD_RTR_TYPE)
   1343                    if(ZG_DEVICE_RTRONLY_TYPE)
   1344                    {
   1345                      ZDApp_ChangeState( DEV_ROUTER );
   1346                    }
   1347          #endif
   1348          #if (ZG_BUILD_COORDINATOR_TYPE)
   1349                    if(ZG_DEVICE_COORDINATOR_TYPE)
   1350                    {
   1351                      ZDApp_ChangeState( DEV_ZB_COORD );
   1352                    }
   1353          #endif
   1354                  }
   1355                  else
   1356                  {
   1357                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_FORMATION_FAILURE;
   \                     ??bdb_reportCommissioningState_19:
   \   00018F   7408         MOV       A,#0x8
   \   000191   F0           MOVX      @DPTR,A
   1358                    //If not on the nwk, then restart the nwk parameters
   1359          #if (ZG_BUILD_RTR_TYPE)
   1360                    if(ZG_DEVICE_RTR_TYPE)
   1361                    {
   1362                      if (!notdoFNCmd) {
   1363                        AT_ERROR(AT_FORM_NWK_FAIL);
   1364                      }
   1365                      if(!bdbAttributes.bdbNodeIsOnANetwork)
   1366                      {
   1367                        uint8 temp = FALSE;
   1368                        //Turn off the radio
   1369                        ZMacSetReq(ZMacRxOnIdle, &temp);
   1370                        //Set the device to FN, to start as new for subsequent attempts
   1371                        bdb_setFN();
   1372                        NLME_ResetRequest();
   1373                        ZDApp_ChangeState( DEV_HOLD );
   1374                      }
   1375                    }
   1376          #endif
   1377                  }
   1378                  bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \                     ??bdb_reportCommissioningState_20:
   \   000192   12....       LCALL     ?Subroutine12 & 0xFFFF
   1379                  osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,50);
   \                     ??CrossCallReturnLabel_137:
   \   000195   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000198   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_123:
   \   00019B   12....       LCALL     ?DEALLOC_XSTACK8
   1380                  bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_NWK_FORMATION;
   \   00019E   90....       MOV       DPTR,#bdbAttributes + 11
   \   0001A1   E0           MOVX      A,@DPTR
   \   0001A2   C2E2         CLR       0xE0 /* A   */.2
   \   0001A4   02....       LJMP      ??bdb_reportCommissioningState_18 & 0xFFFF
   1381                break;
   1382          
   1383          
   1384                case BDB_COMMISSIONING_STATE_FINDING_BINDING:
   1385          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
   1386                  bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_FINDING_BINDING;
   \                     ??bdb_reportCommissioningState_7:
   \   0001A7   7401         MOV       A,#0x1
   \   0001A9   12....       LCALL     ?XSTACK_DISP0_8
   \   0001AC   7403         MOV       A,#0x3
   \   0001AE   F0           MOVX      @DPTR,A
   1387          
   1388                  //Do not notify the status if we have another identify to send
   1389                  if(bdbAttributes.bdbCommissioningStatus == BDB_COMMISSIONING_SUCCESS)
   \   0001AF   90....       MOV       DPTR,#bdbAttributes + 10
   \   0001B2   E0           MOVX      A,@DPTR
   \   0001B3   7006         JNZ       ??bdb_reportCommissioningState_21
   1390                  {
   1391                    //Success at least once during F&B as initiator, mark it
   1392                    bdb_FBStateSuccessLatch = TRUE;
   \   0001B5   90....       MOV       DPTR,#bdb_FBStateSuccessLatch
   \   0001B8   7401         MOV       A,#0x1
   \   0001BA   F0           MOVX      @DPTR,A
   1393                  }
   1394          
   1395                  //Will we process another indentify?
   1396                  if(((FINDING_AND_BINDING_PERIODIC_ENABLE == FALSE) || (bdb_FB_InitiatorCurrentCyclesNumber == 0)) && (bdb_getRespondentRetry(pRespondentHead) == NULL) && (osal_get_timeoutEx( bdb_TaskID, BDB_RESPONDENT_PROCESS_TIMEOUT) == 0))
   \                     ??bdb_reportCommissioningState_21:
   \   0001BB   90....       MOV       DPTR,#bdb_FB_InitiatorCurrentCyclesNumber
   \   0001BE   E0           MOVX      A,@DPTR
   \   0001BF   6003         JZ        $+5
   \   0001C1   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   \   0001C4                ; Setup parameters for call to function bdb_getRespondentRetry
   \   0001C4   12....       LCALL     ?Subroutine24 & 0xFFFF
   \                     ??CrossCallReturnLabel_23:
   \   0001C7   6003         JZ        $+5
   \   0001C9   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   \   0001CC                ; Setup parameters for call to function osal_get_timeoutEx
   \   0001CC   12....       LCALL     ?Subroutine19 & 0xFFFF
   \                     ??CrossCallReturnLabel_57:
   \   0001CF   6003         JZ        $+5
   \   0001D1   02....       LJMP      ??bdb_reportCommissioningState_1 & 0xFFFF
   1397                  {
   1398                    // Dealocate respondent list and clean all the F&B process
   1399                    pRespondentCurr = NULL;
   \   0001D4   90....       MOV       DPTR,#pRespondentCurr
   \   0001D7   E4           CLR       A
   \   0001D8   F0           MOVX      @DPTR,A
   \   0001D9   A3           INC       DPTR
   \   0001DA   F0           MOVX      @DPTR,A
   1400                    pRespondentNext = NULL;
   \   0001DB   90....       MOV       DPTR,#pRespondentNext
   \   0001DE   F0           MOVX      @DPTR,A
   \   0001DF   A3           INC       DPTR
   \   0001E0   F0           MOVX      @DPTR,A
   1401                    bdb_zclRespondentListClean( &pRespondentHead );
   \   0001E1                ; Setup parameters for call to function bdb_zclRespondentListClean
   \   0001E1   7A..         MOV       R2,#pRespondentHead & 0xff
   \   0001E3   7B..         MOV       R3,#(pRespondentHead >> 8) & 0xff
   \   0001E5   12....       LCALL     `??bdb_zclRespondentListClean::?relay`; Banked call to: bdb_zclRespondentListClean
   1402                    osal_stop_timerEx( bdb_TaskID, BDB_RESPONDENT_PROCESS_TIMEOUT );
   \   0001E8                ; Setup parameters for call to function osal_stop_timerEx
   \   0001E8   7A00         MOV       R2,#0x0
   \   0001EA   7B40         MOV       R3,#0x40
   \   0001EC   12....       LCALL     ??Subroutine47_0 & 0xFFFF
   1403          
   1404                    //Report success if in any of the attempts we got success, regardless that we did receive no rsp on the last attempt
   1405                    if(bdb_FBStateSuccessLatch && (bdbAttributes.bdbCommissioningStatus == BDB_COMMISSIONING_FB_NO_IDENTIFY_QUERY_RESPONSE))
   \                     ??CrossCallReturnLabel_72:
   \   0001EF   90....       MOV       DPTR,#bdb_FBStateSuccessLatch
   \   0001F2   E0           MOVX      A,@DPTR
   \   0001F3   600A         JZ        ??bdb_reportCommissioningState_22
   \   0001F5   90....       MOV       DPTR,#bdbAttributes + 10
   \   0001F8   E0           MOVX      A,@DPTR
   \   0001F9   640B         XRL       A,#0xb
   \   0001FB   7002         JNZ       ??bdb_reportCommissioningState_22
   1406                    {
   1407                      bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_SUCCESS;
   \   0001FD   E4           CLR       A
   \   0001FE   F0           MOVX      @DPTR,A
   1408                    }
   1409          
   1410                    //Set default state
   1411                    bdb_FBStateSuccessLatch = FALSE;
   \                     ??bdb_reportCommissioningState_22:
   \   0001FF   90....       MOV       DPTR,#bdb_FBStateSuccessLatch
   \   000202   E4           CLR       A
   \   000203   F0           MOVX      @DPTR,A
   1412          
   1413                    //Resume BDB machine state only if we were in F&B, if we were on parent lost, only clean the commissioning mode and remove from bdb_ParentLostSavedState
   1414                    if(bdbCommissioningProcedureState.bdbCommissioningState == BDB_COMMISSIONING_STATE_FINDING_BINDING)
   \   000204   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000207   E0           MOVX      A,@DPTR
   \   000208   6406         XRL       A,#0x6
   \   00020A   700E         JNZ       ??bdb_reportCommissioningState_23
   1415                    {
   1416                      bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \   00020C   12....       LCALL     ??Subroutine57_0 & 0xFFFF
   1417                      osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,50);
   1418                    }
   \                     ??CrossCallReturnLabel_139:
   \   00020F   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000212   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_124:
   \   000215   12....       LCALL     ?DEALLOC_XSTACK8
   \   000218   800A         SJMP      ??bdb_reportCommissioningState_24
   1419                    else if(bdbCommissioningProcedureState.bdb_ParentLostSavedState == BDB_COMMISSIONING_STATE_FINDING_BINDING)
   \                     ??bdb_reportCommissioningState_23:
   \   00021A   90....       MOV       DPTR,#bdbCommissioningProcedureState + 3
   \   00021D   E0           MOVX      A,@DPTR
   \   00021E   6406         XRL       A,#0x6
   \   000220   7002         JNZ       ??bdb_reportCommissioningState_24
   1420                    {
   1421                      bdbCommissioningProcedureState.bdb_ParentLostSavedState = BDB_COMMISSIONING_STATE_START_RESUME;
   \   000222   E4           CLR       A
   \   000223   F0           MOVX      @DPTR,A
   1422                    }
   1423          
   1424                    bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_FINDING_BINDING;
   \                     ??bdb_reportCommissioningState_24:
   \   000224   90....       MOV       DPTR,#bdbAttributes + 11
   \   000227   E0           MOVX      A,@DPTR
   \   000228   C2E3         CLR       0xE0 /* A   */.3
   \   00022A   02....       LJMP      ??bdb_reportCommissioningState_18 & 0xFFFF
   1425                  }
   1426                  else
   1427                  {
   1428                    return;
   1429                  }
   1430          
   1431          #endif
   1432                break;
   1433                case BDB_COMMISSIONING_STATE_TL:
   1434                  // Set NWK task to run
   1435                  nwk_setStateIdle( FALSE );
   \                     ??bdb_reportCommissioningState_3:
   \   00022D                ; Setup parameters for call to function nwk_setStateIdle
   \   00022D   7900         MOV       R1,#0x0
   \   00022F   12....       LCALL     `??nwk_setStateIdle::?relay`; Banked call to: nwk_setStateIdle
   1436                  bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_TOUCHLINK;
   \   000232   7401         MOV       A,#0x1
   \   000234   12....       LCALL     ?XSTACK_DISP0_8
   \   000237   7404         MOV       A,#0x4
   \   000239   F0           MOVX      @DPTR,A
   1437                  if(didSuccess)
   \   00023A   EF           MOV       A,R7
   \   00023B   600C         JZ        ??bdb_reportCommissioningState_25
   1438                  {
   1439                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_SUCCESS;
   \   00023D   90....       MOV       DPTR,#bdbAttributes + 10
   \   000240   E4           CLR       A
   \   000241   F0           MOVX      @DPTR,A
   1440                    bdbAttributes.bdbCommissioningMode = BDB_COMMISSIONING_MODE_IDDLE;
   \   000242   A3           INC       DPTR
   \   000243   F0           MOVX      @DPTR,A
   1441          
   1442                    //Update ZDApp state
   1443          #if (ZG_BUILD_RTR_TYPE)
   1444                    if(ZG_DEVICE_RTRONLY_TYPE)
   1445                    {
   1446                      ZDApp_ChangeState( DEV_ROUTER );
   1447                    }
   1448          #endif
   1449          #if (ZG_BUILD_ENDDEVICE_TYPE)
   1450                    if(ZG_DEVICE_ENDDEVICE_TYPE)
   1451                    {
   1452                      ZDApp_ChangeState( DEV_END_DEVICE );
   \   000244                ; Setup parameters for call to function ZDApp_ChangeState
   \   000244   7906         MOV       R1,#0x6
   \   000246   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1453                    }
   1454          #endif
   1455                  }
   1456                  //The fail status is already set from the calling function to report commissioning process
   1457          
   1458                  // The commissioning FAIL status is set before calling the bdb_reportCommissioningState
   1459                  bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \                     ??bdb_reportCommissioningState_25:
   \   000249   12....       LCALL     ?Subroutine12 & 0xFFFF
   1460                  osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,50);
   \                     ??CrossCallReturnLabel_138:
   \   00024C   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   00024F   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_125:
   \   000252   12....       LCALL     ?DEALLOC_XSTACK8
   1461                  //Clear the event
   1462                  bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_INITIATOR_TL;
   \   000255   90....       MOV       DPTR,#bdbAttributes + 11
   \   000258   E0           MOVX      A,@DPTR
   \   000259   C2E0         CLR       0xE0 /* A   */.0
   \   00025B   805A         SJMP      ??bdb_reportCommissioningState_18
   1463          
   1464                break;
   1465          
   1466                case BDB_INITIALIZATION:
   1467                  //Notify user about successfull initialization
   1468                  bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_INITIALIZATION;
   \                     ??bdb_reportCommissioningState_8:
   \   00025D   7401         MOV       A,#0x1
   \   00025F   12....       LCALL     ?XSTACK_DISP0_8
   \   000262   E4           CLR       A
   \   000263   F0           MOVX      @DPTR,A
   1469                  if(didSuccess)
   \   000264   EA           MOV       A,R2
   \   000265   602A         JZ        ??bdb_reportCommissioningState_26
   1470                  {
   1471                    //Update ZDApp state
   1472          #if (ZG_BUILD_COORDINATOR_TYPE)
   1473                    if(ZG_DEVICE_COORDINATOR_TYPE)
   1474                    {
   1475                      ZDApp_ChangeState( DEV_ZB_COORD );
   1476                    }
   1477          #endif
   1478          #if (ZG_BUILD_ENDDEVICE_TYPE)
   1479                    if(ZG_DEVICE_ENDDEVICE_TYPE)
   1480                    {
   1481                      uint32 pollrate = POLL_RATE;
   1482                      NLME_SetPollRate(pollrate);
   \   000267                ; Setup parameters for call to function NLME_SetPollRate
   \   000267   90....       MOV       DPTR,#__Constant_12c
   \   00026A   12....       LCALL     ?XLOAD_R2345
   \   00026D   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1483                      ZDApp_ChangeState( DEV_NWK_SEC_REJOIN_CURR_CHANNEL );
   \   000270                ; Setup parameters for call to function ZDApp_ChangeState
   \   000270   7904         MOV       R1,#0x4
   \   000272   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1484          
   1485                    }
   1486          #endif
   1487                    ZDApp_RestoreNwkSecMaterial();
   \   000275                ; Setup parameters for call to function ZDApp_RestoreNwkSecMaterial
   \   000275   12....       LCALL     `??ZDApp_RestoreNwkSecMaterial::?relay`; Banked call to: ZDApp_RestoreNwkSecMaterial
   1488                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_NETWORK_RESTORED;
   \   000278   90....       MOV       DPTR,#bdbAttributes + 10
   \   00027B   740D         MOV       A,#0xd
   \   00027D   F0           MOVX      @DPTR,A
   1489                    bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \   00027E   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000281   E4           CLR       A
   \   000282   F0           MOVX      @DPTR,A
   1490                    osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,200);
   \   000283                ; Setup parameters for call to function osal_start_timerEx
   \   000283   90....       MOV       DPTR,#__Constant_c8
   \   000286   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000289   12....       LCALL     ?Subroutine14 & 0xFFFF
   1491                  }
   \                     ??CrossCallReturnLabel_126:
   \   00028C   12....       LCALL     ?DEALLOC_XSTACK8
   \   00028F   8020         SJMP      ??bdb_reportCommissioningState_27
   1492                  else
   1493                  {
   1494          #if (ZG_BUILD_ENDDEVICE_TYPE)
   1495                    if(ZG_DEVICE_ENDDEVICE_TYPE)
   1496                    {
   1497                      if(bdb_isDeviceNonFactoryNew())
   \                     ??bdb_reportCommissioningState_26:
   \   000291   90....       MOV       DPTR,#bdbAttributes + 14
   \   000294   E0           MOVX      A,@DPTR
   \   000295   6014         JZ        ??bdb_reportCommissioningState_28
   1498                      {
   1499                        //Notify the user about losing parent
   1500                        bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_PARENT_LOST;
   \   000297   7401         MOV       A,#0x1
   \   000299   12....       LCALL     ?XSTACK_DISP0_8
   \   00029C   7405         MOV       A,#0x5
   \   00029E   F0           MOVX      @DPTR,A
   1501                        bdbAttributes.bdbCommissioningMode |= BDB_COMMISSIONING_MODE_PARENT_LOST;
   \   00029F   90....       MOV       DPTR,#bdbAttributes + 11
   \   0002A2   E0           MOVX      A,@DPTR
   \   0002A3   D2E5         SETB      0xE0 /* A   */.5
   \   0002A5   F0           MOVX      @DPTR,A
   1502          
   1503                        //Update ZDApp state
   1504                        ZDApp_ChangeState( DEV_NWK_ORPHAN );
   \   0002A6                ; Setup parameters for call to function ZDApp_ChangeState
   \   0002A6   790A         MOV       R1,#0xa
   \   0002A8   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1505                      }
   1506                    }
   1507          #endif
   1508                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_NO_NETWORK;
   \                     ??bdb_reportCommissioningState_28:
   \   0002AB   90....       MOV       DPTR,#bdbAttributes + 10
   \   0002AE   7402         MOV       A,#0x2
   \   0002B0   F0           MOVX      @DPTR,A
   1509                  }
   1510                  bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_INITIALIZATION;
   \                     ??bdb_reportCommissioningState_27:
   \   0002B1   90....       MOV       DPTR,#bdbAttributes + 11
   \   0002B4   E0           MOVX      A,@DPTR
   \   0002B5   C2E4         CLR       0xE0 /* A   */.4
   \                     ??bdb_reportCommissioningState_18:
   \   0002B7   F0           MOVX      @DPTR,A
   1511          
   1512                break;
   \   0002B8   804E         SJMP      ??bdb_reportCommissioningState_10
   1513          #if (ZG_BUILD_ENDDEVICE_TYPE)
   1514                case BDB_PARENT_LOST:
   1515                  bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_PARENT_LOST;
   \                     ??bdb_reportCommissioningState_9:
   \   0002BA   7401         MOV       A,#0x1
   \   0002BC   12....       LCALL     ?XSTACK_DISP0_8
   \   0002BF   7405         MOV       A,#0x5
   \   0002C1   F0           MOVX      @DPTR,A
   1516                  if(ZG_DEVICE_ENDDEVICE_TYPE)
   1517                  {
   1518                    if(didSuccess)
   \   0002C2   EA           MOV       A,R2
   \   0002C3   602D         JZ        ??bdb_reportCommissioningState_29
   1519                    {
   1520                      uint32 pollrate = POLL_RATE;
   1521                      bdbCommissioningProcedureState.bdbCommissioningState = bdbCommissioningProcedureState.bdb_ParentLostSavedState;
   \   0002C5   90....       MOV       DPTR,#bdbCommissioningProcedureState + 3
   \   0002C8   E0           MOVX      A,@DPTR
   \   0002C9   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   0002CC   F0           MOVX      @DPTR,A
   1522                      bdbCommissioningProcedureState.bdb_ParentLostSavedState = 0;
   \   0002CD   90....       MOV       DPTR,#bdbCommissioningProcedureState + 3
   \   0002D0   E4           CLR       A
   \   0002D1   F0           MOVX      @DPTR,A
   1523                      NLME_SetPollRate(pollrate);
   \   0002D2                ; Setup parameters for call to function NLME_SetPollRate
   \   0002D2   90....       MOV       DPTR,#__Constant_12c
   \   0002D5   12....       LCALL     ?XLOAD_R2345
   \   0002D8   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1524                      bdbAttributes.bdbCommissioningMode &= ~BDB_COMMISSIONING_MODE_PARENT_LOST;
   \   0002DB   90....       MOV       DPTR,#bdbAttributes + 11
   \   0002DE   E0           MOVX      A,@DPTR
   \   0002DF   C2E5         CLR       0xE0 /* A   */.5
   \   0002E1   F0           MOVX      @DPTR,A
   1525                      bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_NETWORK_RESTORED;
   \   0002E2   90....       MOV       DPTR,#bdbAttributes + 10
   \   0002E5   740D         MOV       A,#0xd
   \   0002E7   F0           MOVX      @DPTR,A
   1526                      //Update ZDApp state
   1527                      ZDApp_ChangeState( DEV_NWK_SEC_REJOIN_CURR_CHANNEL );
   \   0002E8                ; Setup parameters for call to function ZDApp_ChangeState
   \   0002E8   7904         MOV       R1,#0x4
   \   0002EA   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1528          
   1529                      bdb_NetworkRestoredResumeState();
   \   0002ED                ; Setup parameters for call to function bdb_NetworkRestoredResumeState
   \   0002ED   12....       LCALL     `??bdb_NetworkRestoredResumeState::?relay`; Banked call to: bdb_NetworkRestoredResumeState
   \   0002F0   8016         SJMP      ??bdb_reportCommissioningState_10
   1530                    }
   1531                    else
   1532                    {
   1533                      bdbAttributes.bdbCommissioningMode |= BDB_COMMISSIONING_MODE_PARENT_LOST;
   \                     ??bdb_reportCommissioningState_29:
   \   0002F2   90....       MOV       DPTR,#bdbAttributes + 11
   \   0002F5   E0           MOVX      A,@DPTR
   \   0002F6   D2E5         SETB      0xE0 /* A   */.5
   \   0002F8   F0           MOVX      @DPTR,A
   1534                      bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_NO_NETWORK;
   \   0002F9   90....       MOV       DPTR,#bdbAttributes + 10
   \   0002FC   7402         MOV       A,#0x2
   \   0002FE   F0           MOVX      @DPTR,A
   1535          
   1536                      NLME_SetPollRate(0);
   \   0002FF                ; Setup parameters for call to function NLME_SetPollRate
   \   0002FF   90....       MOV       DPTR,#__Constant_0
   \   000302   12....       LCALL     ?XLOAD_R2345
   \   000305   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1537          
   1538                    }
   1539                  }
   1540                break;
   1541          #endif
   1542              }
   1543          #ifdef MT_APP_CNF_FUNC
   1544              //Notify the user about the status, the main state which has failed
   1545              bdbCommissioningModeMsg.bdbCommissioningStatus = bdbAttributes.bdbCommissioningStatus;
   1546          
   1547              bdb_NotifyApp((uint8*)&bdbCommissioningModeMsg);
   1548          #else
   1549              if(pfnCommissioningStatusCB)
   \                     ??bdb_reportCommissioningState_10:
   \   000308   90....       MOV       DPTR,#pfnCommissioningStatusCB
   \   00030B   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_97:
   \   00030E   6016         JZ        ??bdb_reportCommissioningState_1
   1550              {
   1551                //Notify the user about the status, the main state which has failed
   1552                bdbCommissioningModeMsg.bdbCommissioningStatus = bdbAttributes.bdbCommissioningStatus;
   \   000310   90....       MOV       DPTR,#bdbAttributes + 10
   \   000313   E0           MOVX      A,@DPTR
   \   000314   85..82       MOV       DPL,?XSP + 0
   \   000317   85..83       MOV       DPH,?XSP + 1
   \   00031A   12....       LCALL     ?Subroutine5 & 0xFFFF
   1553          
   1554                bdb_NotifyApp((uint8*)&bdbCommissioningModeMsg);
   1555              }
   1556          #endif
   1557            }
   \                     ??CrossCallReturnLabel_1:
   \   00031D   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000320   12....       LCALL     ?Subroutine15 & 0xFFFF
   \                     ??CrossCallReturnLabel_75:
   \   000323   12....       LCALL     ?DEALLOC_XSTACK8
   1558          }
   \                     ??bdb_reportCommissioningState_1:
   \   000326   7404         MOV       A,#0x4
   \   000328   02....       LJMP      ??Subroutine59_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine19:
   \   000000   7A00         MOV       R2,#0x0
   \   000002   7B40         MOV       R3,#0x40
   \   000004                REQUIRE ??Subroutine43_0
   \   000004                ; // Fall through to label ??Subroutine43_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine17:
   \   000000   7A00         MOV       R2,#0x0
   \   000002   7B10         MOV       R3,#0x10
   \   000004                REQUIRE ??Subroutine47_0
   \   000004                ; // Fall through to label ??Subroutine47_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine24:
   \   000000   90....       MOV       DPTR,#pRespondentHead
   \   000003   12....       LCALL     ??Subroutine46_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_149:
   \   000006   12....       LCALL     `??bdb_getRespondentRetry::?relay`; Banked call to: bdb_getRespondentRetry
   \   000009   EA           MOV       A,R2
   \   00000A   4B           ORL       A,R3
   \   00000B   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine14:
   \   000000   7A04         MOV       R2,#0x4
   \   000002                REQUIRE ??Subroutine55_0
   \   000002                ; // Fall through to label ??Subroutine55_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine55_0:
   \   000000   7B00         MOV       R3,#0x0
   \   000002                REQUIRE ??Subroutine56_0
   \   000002                ; // Fall through to label ??Subroutine56_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine12:
   \   000000   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000003                REQUIRE ??Subroutine57_0
   \   000003                ; // Fall through to label ??Subroutine57_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine57_0:
   \   000000   E4           CLR       A
   \   000001                REQUIRE ??Subroutine58_0
   \   000001                ; // Fall through to label ??Subroutine58_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine58_0:
   \   000000   F0           MOVX      @DPTR,A
   \   000001                ; Setup parameters for call to function osal_start_timerEx
   \   000001                ; Setup parameters for call to function osal_start_timerEx
   \   000001                ; Setup parameters for call to function osal_start_timerEx
   \   000001                ; Setup parameters for call to function osal_start_timerEx
   \   000001                ; Setup parameters for call to function osal_start_timerEx
   \   000001                ; Setup parameters for call to function osal_start_timerEx
   \   000001   90....       MOV       DPTR,#__Constant_32
   \   000004   22           RET
   1559          
   1560          
   1561           /*********************************************************************
   1562           * @fn          bdb_nwkFormationAttempt
   1563           *
   1564           * @brief       Process a nwk formation attempt.
   1565           *
   1566           * @param       didSuccess - TRUE if the nwk formation was success, FALSE
   1567           *                         otherwise and try secondary channel
   1568           *
   1569           * @return      none
   1570           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1571          void bdb_nwkFormationAttempt(bool didSuccess)
   \                     bdb_nwkFormationAttempt:
   1572          {
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   1573            if(didSuccess)
   \   000006   6004         JZ        ??bdb_nwkFormationAttempt_0
   1574            {
   1575              bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_FORMATION,TRUE);
   \   000008                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000008   7A01         MOV       R2,#0x1
   \   00000A   801F         SJMP      ??bdb_nwkFormationAttempt_1
   1576            }
   1577            else
   1578            {
   1579              //Can we try the secondary channel set?
   1580              if((vDoPrimaryScan) && (bdbAttributes.bdbSecondaryChannelSet))
   \                     ??bdb_nwkFormationAttempt_0:
   \   00000C   90....       MOV       DPTR,#vDoPrimaryScan
   \   00000F   E0           MOVX      A,@DPTR
   \   000010   6017         JZ        ??bdb_nwkFormationAttempt_2
   \   000012   90....       MOV       DPTR,#bdbAttributes
   \   000015   12....       LCALL     ?XLOAD_R0123
   \   000018   E8           MOV       A,R0
   \   000019   49           ORL       A,R1
   \   00001A   4A           ORL       A,R2
   \   00001B   4B           ORL       A,R3
   \   00001C   600B         JZ        ??bdb_nwkFormationAttempt_2
   1581              {
   1582                vDoPrimaryScan = FALSE;
   \   00001E   90....       MOV       DPTR,#vDoPrimaryScan
   \   000021   E4           CLR       A
   \   000022   F0           MOVX      @DPTR,A
   1583                bdb_nwkJoiningFormation(FALSE);
   \   000023                ; Setup parameters for call to function bdb_nwkJoiningFormation
   \   000023   F9           MOV       R1,A
   \   000024   12....       LCALL     `??bdb_nwkJoiningFormation::?relay`; Banked call to: bdb_nwkJoiningFormation
   \   000027   8007         SJMP      ??bdb_nwkFormationAttempt_3
   1584              }
   1585              else
   1586              {
   1587                bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_FORMATION, FALSE);
   \                     ??bdb_nwkFormationAttempt_2:
   \   000029                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000029   7A00         MOV       R2,#0x0
   \                     ??bdb_nwkFormationAttempt_1:
   \   00002B   7905         MOV       R1,#0x5
   \   00002D   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   1588              }
   1589            }
   1590          }
   \                     ??bdb_nwkFormationAttempt_3:
   \   000030                REQUIRE ?Subroutine0
   \   000030                ; // Fall through to label ?Subroutine0
   1591          
   1592          
   1593          
   1594          /*********************************************************************
   1595           * @fn          bdb_isDeviceNonFactoryNew
   1596           *
   1597           * @brief       Returns the state of bdbNodeIsOnANetwork attribute
   1598           *
   1599           * @param       none
   1600           *
   1601           * @return      bdbNodeIsOnANetwork
   1602           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1603          bool bdb_isDeviceNonFactoryNew(void)
   \                     bdb_isDeviceNonFactoryNew:
   1604          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1605            return bdbAttributes.bdbNodeIsOnANetwork;
   \   000004   90....       MOV       DPTR,#bdbAttributes + 14
   \   000007   E0           MOVX      A,@DPTR
   \   000008   F9           MOV       R1,A
   \   000009   02....       LJMP      ??Subroutine42_0 & 0xFFFF
   1606          }
   1607          
   1608          
   1609          /*********************************************************************
   1610           * @fn          bdb_doTrustCenterRequireKeyExchange
   1611           *
   1612           * @brief       Returns the state of bdbTrustCenterRequireKeyExchange attribute
   1613           *
   1614           * @param       none
   1615           *
   1616           * @return      bdbTrustCenterRequireKeyExchange
   1617           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1618          bool bdb_doTrustCenterRequireKeyExchange(void)
   \                     bdb_doTrustCenterRequireKeyExchange:
   1619          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
   1620          #if (ZG_BUILD_COORDINATOR_TYPE)
   1621            return bdbAttributes.bdbTrustCenterRequireKeyExchange;
   1622          #else
   1623            return 0;
   \   000000   7900         MOV       R1,#0x0
   \   000002   02....       LJMP      ?BRET
   1624          #endif
   1625          }
   1626          
   1627          /*********************************************************************
   1628           * @fn      bdb_rejoinNwk
   1629           *
   1630           * @brief   Attempt to rejoin/resume a nwk from nv parameters
   1631           *
   1632           * @param   none
   1633           *
   1634           * @return  ZStatus_t
   1635           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1636          ZStatus_t bdb_rejoinNwk(void)
   \                     bdb_rejoinNwk:
   1637          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV       A,#-0x1
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   1638            ZStatus_t rejoinStatus = ZSuccess;
   \   00000A   7E00         MOV       R6,#0x0
   1639          
   1640            //Update the seq number
   1641            _NIB.SequenceNum ++;
   \   00000C   90....       MOV       DPTR,#_NIB
   \   00000F   E0           MOVX      A,@DPTR
   \   000010   04           INC       A
   \   000011   F0           MOVX      @DPTR,A
   1642          
   1643            osal_nv_write(ZCD_NV_NIB,osal_offsetof( nwkIB_t, SequenceNum ), sizeof( uint8), &_NIB.SequenceNum );
   \   000012                ; Setup parameters for call to function osal_nv_write
   \   000012   75....       MOV       ?V0,#_NIB & 0xff
   \   000015   75....       MOV       ?V1,#(_NIB >> 8) & 0xff
   \   000018   78..         MOV       R0,#?V0
   \   00001A   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00001D   75..01       MOV       ?V0,#0x1
   \   000020   8E..         MOV       ?V1,R6
   \   000022   78..         MOV       R0,#?V0
   \   000024   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000027   7C00         MOV       R4,#0x0
   \   000029   7D00         MOV       R5,#0x0
   \   00002B   7A21         MOV       R2,#0x21
   \   00002D   12....       LCALL     ??Subroutine44_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_62:
   \   000030   12....       LCALL     ?DEALLOC_XSTACK8
   1644          
   1645            // Transition state machine to correct rejoin state based on nwk key
   1646            if ( ZDApp_RestoreNwkKey( FALSE )== TRUE )
   \   000033                ; Setup parameters for call to function ZDApp_RestoreNwkKey
   \   000033   7900         MOV       R1,#0x0
   \   000035   12....       LCALL     `??ZDApp_RestoreNwkKey::?relay`; Banked call to: ZDApp_RestoreNwkKey
   \   000038   E9           MOV       A,R1
   \   000039   6401         XRL       A,#0x1
   \   00003B   7004         JNZ       ??bdb_rejoinNwk_0
   1647            {
   1648              ZDApp_ChangeState( DEV_NWK_SEC_REJOIN_CURR_CHANNEL );
   \   00003D                ; Setup parameters for call to function ZDApp_ChangeState
   \   00003D   7904         MOV       R1,#0x4
   \   00003F   8002         SJMP      ??bdb_rejoinNwk_1
   1649            }
   1650            else
   1651            {
   1652              ZDApp_ChangeState( DEV_NWK_TC_REJOIN_CURR_CHANNEL );
   \                     ??bdb_rejoinNwk_0:
   \   000041                ; Setup parameters for call to function ZDApp_ChangeState
   \   000041   790E         MOV       R1,#0xe
   \                     ??bdb_rejoinNwk_1:
   \   000043   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1653            }
   1654          
   1655            // Before trying to do rejoin, check if the device has a valid short address
   1656            // If not, generate a random short address for itself
   1657            if ( _NIB.nwkDevAddress == INVALID_NODE_ADDR )
   \   000046   90....       MOV       DPTR,#_NIB + 20
   \   000049   E0           MOVX      A,@DPTR
   \   00004A   64FE         XRL       A,#0xfe
   \   00004C   7003         JNZ       ??bdb_rejoinNwk_2
   \   00004E   A3           INC       DPTR
   \   00004F   E0           MOVX      A,@DPTR
   \   000050   F4           CPL       A
   \                     ??bdb_rejoinNwk_2:
   \   000051   7002         JNZ       ??bdb_rejoinNwk_3
   1658            {
   1659              rejoinStatus = ZFailure;
   \   000053   7E01         MOV       R6,#0x1
   1660            }
   1661          
   1662            // Check if the device has a valid PanID, if not, set it to the discovered Pan
   1663            if ( _NIB.nwkPanId == 0xFFFF )
   \                     ??bdb_rejoinNwk_3:
   \   000055   90....       MOV       DPTR,#_NIB + 33
   \   000058   E0           MOVX      A,@DPTR
   \   000059   F4           CPL       A
   \   00005A   7003         JNZ       ??bdb_rejoinNwk_4
   \   00005C   A3           INC       DPTR
   \   00005D   E0           MOVX      A,@DPTR
   \   00005E   F4           CPL       A
   \                     ??bdb_rejoinNwk_4:
   \   00005F   7004         JNZ       ??bdb_rejoinNwk_5
   1664            {
   1665              rejoinStatus = ZFailure;
   \   000061   7E01         MOV       R6,#0x1
   \   000063   8033         SJMP      ??bdb_rejoinNwk_6
   1666            }
   1667          
   1668            if(rejoinStatus == ZSuccess)
   \                     ??bdb_rejoinNwk_5:
   \   000065   EE           MOV       A,R6
   \   000066   A2E0         MOV       C,0xE0 /* A   */.0
   \   000068   402E         JC        ??bdb_rejoinNwk_6
   1669            {
   1670              uint8 tmp = true;
   \   00006A   85..82       MOV       DPL,?XSP + 0
   \   00006D   85..83       MOV       DPH,?XSP + 1
   \   000070   7401         MOV       A,#0x1
   \   000072   12....       LCALL     ?Subroutine6 & 0xFFFF
   1671              ZMacSetReq( ZMacRxOnIdle, &tmp ); // Set receiver always on during rejoin
   1672          
   1673              // Perform Secure or Unsecure Rejoin depending on available configuration
   1674              if ( ZG_SECURE_ENABLED && ( ZDApp_RestoreNwkKey( TRUE ) == TRUE ) )
   \                     ??CrossCallReturnLabel_5:
   \   000075                ; Setup parameters for call to function ZDApp_RestoreNwkKey
   \   000075   7901         MOV       R1,#0x1
   \   000077   12....       LCALL     `??ZDApp_RestoreNwkKey::?relay`; Banked call to: ZDApp_RestoreNwkKey
   \   00007A   E9           MOV       A,R1
   \   00007B   6401         XRL       A,#0x1
   \   00007D   90....       MOV       DPTR,#_NIB + 22
   \   000080   700B         JNZ       ??bdb_rejoinNwk_7
   1675              {
   1676                rejoinStatus = NLME_ReJoinRequest( ZDO_UseExtendedPANID, _NIB.nwkLogicalChannel);
   \   000082                ; Setup parameters for call to function NLME_ReJoinRequest
   \   000082   E0           MOVX      A,@DPTR
   \   000083   F9           MOV       R1,A
   \   000084   7A..         MOV       R2,#ZDO_UseExtendedPANID & 0xff
   \   000086   7B..         MOV       R3,#(ZDO_UseExtendedPANID >> 8) & 0xff
   \   000088   12....       LCALL     `??NLME_ReJoinRequest::?relay`; Banked call to: NLME_ReJoinRequest
   \   00008B   8009         SJMP      ??bdb_rejoinNwk_8
   1677              }
   1678              else
   1679              {
   1680                rejoinStatus = NLME_ReJoinRequestUnsecure( ZDO_UseExtendedPANID, _NIB.nwkLogicalChannel);
   \                     ??bdb_rejoinNwk_7:
   \   00008D                ; Setup parameters for call to function NLME_ReJoinRequestUnsecure
   \   00008D   E0           MOVX      A,@DPTR
   \   00008E   F9           MOV       R1,A
   \   00008F   7A..         MOV       R2,#ZDO_UseExtendedPANID & 0xff
   \   000091   7B..         MOV       R3,#(ZDO_UseExtendedPANID >> 8) & 0xff
   \   000093   12....       LCALL     `??NLME_ReJoinRequestUnsecure::?relay`; Banked call to: NLME_ReJoinRequestUnsecure
   \                     ??bdb_rejoinNwk_8:
   \   000096   E9           MOV       A,R1
   \   000097   FE           MOV       R6,A
   1681              }
   1682            }
   1683          
   1684            return rejoinStatus;
   \                     ??bdb_rejoinNwk_6:
   \   000098   EE           MOV       A,R6
   \   000099   F9           MOV       R1,A
   \   00009A   02....       LJMP      ?Subroutine1 & 0xFFFF
   1685          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   7401         MOV       A,#0x1
   \   000002                REQUIRE ??Subroutine59_0
   \   000002                ; // Fall through to label ??Subroutine59_0
   1686          
   1687          #if (ZG_BUILD_JOINING_TYPE)
   1688           /*********************************************************************
   1689           * @fn          bdb_nwkDiscoveryAttempt
   1690           *
   1691           * @brief       Process a nwk discovery attempt
   1692           *
   1693           * @param       didSuccess - TRUE we found nwk in the scanned channels, FALSE if
   1694           *                           no suitable nwks were found, try secondary channel
   1695           *
   1696           * @return      none
   1697           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1698          void bdb_nwkDiscoveryAttempt(bool didSuccess)
   \                     bdb_nwkDiscoveryAttempt:
   1699          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV       A,#-0x1
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   1700            uint8 bdbJoinEvent = BDB_JOIN_EVENT_NWK_DISCOVERY;
   \   00000A   85..82       MOV       DPL,?XSP + 0
   \   00000D   85..83       MOV       DPH,?XSP + 1
   \   000010   E4           CLR       A
   \   000011   F0           MOVX      @DPTR,A
   1701          
   1702            if(didSuccess)
   \   000012   E9           MOV       A,R1
   \   000013   601B         JZ        ??bdb_nwkDiscoveryAttempt_0
   1703            {
   1704              bdb_SendMsg(bdb_TaskID, BDB_COMMISSIONING_STATE_JOINING, BDB_MSG_EVENT_SUCCESS,sizeof(bdbJoinEvent),(uint8*)&bdbJoinEvent);
   \   000015                ; Setup parameters for call to function bdb_SendMsg
   \   000015   A8..         MOV       R0,?XSP + 0
   \   000017   A9..         MOV       R1,?XSP + 1
   \   000019   88..         MOV       ?V0,R0
   \   00001B   89..         MOV       ?V1,R1
   \   00001D   78..         MOV       R0,#?V0
   \   00001F   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000022   7C01         MOV       R4,#0x1
   \   000024   7B00         MOV       R3,#0x0
   \   000026   7A03         MOV       R2,#0x3
   \   000028   12....       LCALL     ??Subroutine48_0 & 0xFFFF
   1705            }
   \                     ??CrossCallReturnLabel_78:
   \   00002B   12....       LCALL     ?DEALLOC_XSTACK8
   \   00002E   8030         SJMP      ??bdb_nwkDiscoveryAttempt_1
   1706            else
   1707            {
   1708              //Can we try the secondary channel set?
   1709              if((vDoPrimaryScan) && (bdbAttributes.bdbSecondaryChannelSet))
   \                     ??bdb_nwkDiscoveryAttempt_0:
   \   000030   90....       MOV       DPTR,#vDoPrimaryScan
   \   000033   E0           MOVX      A,@DPTR
   \   000034   6023         JZ        ??bdb_nwkDiscoveryAttempt_2
   \   000036   90....       MOV       DPTR,#bdbAttributes
   \   000039   12....       LCALL     ?XLOAD_R0123
   \   00003C   E8           MOV       A,R0
   \   00003D   49           ORL       A,R1
   \   00003E   4A           ORL       A,R2
   \   00003F   4B           ORL       A,R3
   \   000040   6017         JZ        ??bdb_nwkDiscoveryAttempt_2
   1710              {
   1711                vDoPrimaryScan = FALSE;
   \   000042   90....       MOV       DPTR,#vDoPrimaryScan
   \   000045   E4           CLR       A
   \   000046   F0           MOVX      @DPTR,A
   1712                bdb_setChannel(bdbAttributes.bdbSecondaryChannelSet);
   \   000047                ; Setup parameters for call to function bdb_setChannel
   \   000047   90....       MOV       DPTR,#bdbAttributes
   \   00004A   12....       LCALL     ?XLOAD_R2345
   \   00004D   12....       LCALL     `??bdb_setChannel::?relay`; Banked call to: bdb_setChannel
   1713          
   1714                ZDApp_NetworkInit( 50 );
   \   000050                ; Setup parameters for call to function ZDApp_NetworkInit
   \   000050   7A32         MOV       R2,#0x32
   \   000052   7B00         MOV       R3,#0x0
   \   000054   12....       LCALL     `??ZDApp_NetworkInit::?relay`; Banked call to: ZDApp_NetworkInit
   \   000057   8007         SJMP      ??bdb_nwkDiscoveryAttempt_1
   1715              }
   1716              else
   1717              {
   1718                bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_JOINING, FALSE);
   \                     ??bdb_nwkDiscoveryAttempt_2:
   \   000059                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000059   7A00         MOV       R2,#0x0
   \   00005B   7903         MOV       R1,#0x3
   \   00005D   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   1719              }
   1720            }
   1721          }
   \                     ??bdb_nwkDiscoveryAttempt_1:
   \   000060   02....       LJMP      ?Subroutine1 & 0xFFFF
   1722          
   1723           /*********************************************************************
   1724           * @fn          bdb_filterNwkDisc
   1725           *
   1726           * @brief       Filter the nwks found and attempt to join the suitable nwks
   1727           *              Here the application can include nwk filters
   1728           *
   1729           * @param       none
   1730           *
   1731           * @return      none
   1732           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1733          void bdb_filterNwkDisc(void)
   \                     bdb_filterNwkDisc:
   1734          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000   74F5         MOV       A,#-0xb
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 11
   \   000005                ; Auto size: 0
   1735            networkDesc_t* pNwkDesc;
   1736            uint8 i = 0;
   1737            uint8 ResultCount = 0;
   \   000005   75..00       MOV       ?V0,#0x0
   1738            uint8 stackProfile = 0;
   \   000008   75..00       MOV       ?V1,#0x0
   1739            uint8 stackProfilePro = 0;
   1740          
   1741            pBDBListNwk  = nwk_getNwkDescList();
   \   00000B                ; Setup parameters for call to function nwk_getNwkDescList
   \   00000B   12....       LCALL     `??nwk_getNwkDescList::?relay`; Banked call to: nwk_getNwkDescList
   \   00000E   90....       MOV       DPTR,#pBDBListNwk
   \   000011   12....       LCALL     ??Subroutine62_0 & 0xFFFF
   1742            nwk_desc_list_release();
   \                     ??CrossCallReturnLabel_156:
   \   000014                ; Setup parameters for call to function nwk_desc_list_release
   \   000014   12....       LCALL     `??nwk_desc_list_release::?relay`; Banked call to: nwk_desc_list_release
   1743          
   1744            pNwkDesc = pBDBListNwk;
   \   000017   90....       MOV       DPTR,#pBDBListNwk
   \   00001A   8005         SJMP      ??CrossCallReturnLabel_39
   1745            while (pNwkDesc)
   1746            {
   1747              ResultCount++;
   \                     ??bdb_filterNwkDisc_0:
   \   00001C   05..         INC       ?V0
   1748              pNwkDesc = pNwkDesc->nextDesc;
   \   00001E   12....       LCALL     ?Subroutine32 & 0xFFFF
   1749            }
   \                     ??CrossCallReturnLabel_39:
   \   000021   12....       LCALL     ?Subroutine37 & 0xFFFF
   \                     ??CrossCallReturnLabel_47:
   \   000024   EE           MOV       A,R6
   \   000025   4F           ORL       A,R7
   \   000026   70F4         JNZ       ??bdb_filterNwkDisc_0
   1750          
   1751            if(pBDBListNwk)
   \   000028   90....       MOV       DPTR,#pBDBListNwk
   \   00002B   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_98:
   \   00002E   7003         JNZ       $+5
   \   000030   02....       LJMP      ??bdb_filterNwkDisc_1 & 0xFFFF
   1752            {
   1753              if(pfnFilterNwkDesc)
   \   000033   90....       MOV       DPTR,#pfnFilterNwkDesc
   \   000036   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_99:
   \   000039   600E         JZ        ??bdb_filterNwkDisc_2
   1754              {
   1755                pfnFilterNwkDesc(pBDBListNwk, ResultCount);
   \   00003B                ; Setup parameters for indirect call
   \   00003B   A9..         MOV       R1,?V0
   \   00003D   12....       LCALL     ?Subroutine25 & 0xFFFF
   1756              }
   \                     ??CrossCallReturnLabel_147:
   \   000040   90....       MOV       DPTR,#pfnFilterNwkDesc + 1
   \   000043   12....       LCALL     ??Subroutine51_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_83:
   \   000046   12....       LCALL     ?CALL_IND
   1757          
   1758              for ( stackProfile = 0; stackProfile < STACK_PROFILE_MAX; stackProfile++ )
   1759              {
   1760                pNwkDesc = pBDBListNwk;
   \                     ??bdb_filterNwkDisc_2:
   \   000049   90....       MOV       DPTR,#pBDBListNwk
   \   00004C   12....       LCALL     ?Subroutine37 & 0xFFFF
   1761          
   1762                if(pNwkDesc)
   \                     ??CrossCallReturnLabel_48:
   \   00004F   EE           MOV       A,R6
   \   000050   4F           ORL       A,R7
   \   000051   7003         JNZ       $+5
   \   000053   02....       LJMP      ??bdb_filterNwkDisc_3 & 0xFFFF
   1763                {
   1764                  for ( i = 0; i < ResultCount; i++, pNwkDesc = pNwkDesc->nextDesc )
   \   000056   75..00       MOV       ?V2,#0x0
   \   000059   02....       LJMP      ??CrossCallReturnLabel_49 & 0xFFFF
   1765                  {
   1766                    if ( nwk_ExtPANIDValid( ZDO_UseExtendedPANID ) == true )
   1767                    {
   1768                      // If the extended Pan ID is commissioned to a non zero value
   1769                      // Only join the Pan that has match EPID
   1770                      if ( osal_ExtAddrEqual( ZDO_UseExtendedPANID, pNwkDesc->extendedPANID) == false )
   1771                      {
   1772                        //Remove from the list
   1773                        bdb_nwkDescFree(pNwkDesc);
   1774                        ResultCount--;
   1775                        continue;
   1776                      }
   1777                    }
   1778                    else if ( zgConfigPANID != 0xFFFF )
   \                     ??bdb_filterNwkDisc_4:
   \   00005C   90....       MOV       DPTR,#zgConfigPANID
   \   00005F   E0           MOVX      A,@DPTR
   \   000060   F4           CPL       A
   \   000061   7003         JNZ       ??bdb_filterNwkDisc_5
   \   000063   A3           INC       DPTR
   \   000064   E0           MOVX      A,@DPTR
   \   000065   F4           CPL       A
   \                     ??bdb_filterNwkDisc_5:
   \   000066   6013         JZ        ??bdb_filterNwkDisc_6
   1779                    {
   1780                      // PAN Id is preconfigured. check if it matches
   1781                      if ( pNwkDesc->panId != zgConfigPANID )
   \   000068   8E82         MOV       DPL,R6
   \   00006A   8F83         MOV       DPH,R7
   \   00006C   12....       LCALL     ?Subroutine28 & 0xFFFF
   1782                      {
   1783                        //Remove from the list
   1784                        bdb_nwkDescFree(pNwkDesc);
   1785                        ResultCount--;
   1786                        continue;
   1787                      }
   1788                    }
   \                     ??CrossCallReturnLabel_31:
   \   00006F   90....       MOV       DPTR,#zgConfigPANID
   \   000072   E0           MOVX      A,@DPTR
   \   000073   68           XRL       A,R0
   \   000074   7003         JNZ       ??bdb_filterNwkDisc_7
   \   000076   A3           INC       DPTR
   \   000077   E0           MOVX      A,@DPTR
   \   000078   69           XRL       A,R1
   \                     ??bdb_filterNwkDisc_7:
   \   000079   7058         JNZ       ??bdb_filterNwkDisc_8
   1789          
   1790                    if ( pNwkDesc->chosenRouter != _NIB.nwkCoordAddress || _NIB.nwkCoordAddress == INVALID_NODE_ADDR )
   \                     ??bdb_filterNwkDisc_6:
   \   00007B   90....       MOV       DPTR,#_NIB + 23
   \   00007E   12....       LCALL     ?Subroutine28 & 0xFFFF
   \                     ??CrossCallReturnLabel_32:
   \   000081   8E82         MOV       DPL,R6
   \   000083   8F83         MOV       DPH,R7
   \   000085   A3           INC       DPTR
   \   000086   A3           INC       DPTR
   \   000087   A3           INC       DPTR
   \   000088   A3           INC       DPTR
   \   000089   A3           INC       DPTR
   \   00008A   A3           INC       DPTR
   \   00008B   A3           INC       DPTR
   \   00008C   E0           MOVX      A,@DPTR
   \   00008D   68           XRL       A,R0
   \   00008E   7003         JNZ       ??bdb_filterNwkDisc_9
   \   000090   A3           INC       DPTR
   \   000091   E0           MOVX      A,@DPTR
   \   000092   69           XRL       A,R1
   \                     ??bdb_filterNwkDisc_9:
   \   000093   700A         JNZ       ??bdb_filterNwkDisc_10
   \   000095   74FE         MOV       A,#-0x2
   \   000097   68           XRL       A,R0
   \   000098   7003         JNZ       ??bdb_filterNwkDisc_11
   \   00009A   74FF         MOV       A,#-0x1
   \   00009C   69           XRL       A,R1
   \                     ??bdb_filterNwkDisc_11:
   \   00009D   700B         JNZ       ??bdb_filterNwkDisc_12
   1791                    {
   1792                      // check that network is allowing joining
   1793                      if ( ZSTACK_ROUTER_BUILD )
   1794                      {
   1795                        if ( stackProfilePro == FALSE )
   1796                        {
   1797                          if ( !pNwkDesc->routerCapacity )
   1798                          {
   1799                            //Remove from the list
   1800                            bdb_nwkDescFree(pNwkDesc);
   1801                            ResultCount--;
   1802                            continue;
   1803                          }
   1804                        }
   1805                        else
   1806                        {
   1807                          if ( !pNwkDesc->deviceCapacity )
   1808                          {
   1809                            //Remove from the list
   1810                            bdb_nwkDescFree(pNwkDesc);
   1811                            ResultCount--;
   1812                            continue;
   1813                          }
   1814                        }
   1815                      }
   1816                      else if ( ZSTACK_END_DEVICE_BUILD )
   1817                      {
   1818                        if ( !pNwkDesc->deviceCapacity )
   \                     ??bdb_filterNwkDisc_10:
   \   00009F   8E82         MOV       DPL,R6
   \   0000A1   8F83         MOV       DPH,R7
   \   0000A3   A3           INC       DPTR
   \   0000A4   A3           INC       DPTR
   \   0000A5   A3           INC       DPTR
   \   0000A6   A3           INC       DPTR
   \   0000A7   E0           MOVX      A,@DPTR
   \   0000A8   6029         JZ        ??bdb_filterNwkDisc_8
   1819                        {
   1820                          //Remove from the list
   1821                          bdb_nwkDescFree(pNwkDesc);
   1822                          ResultCount--;
   1823                          continue;
   1824                        }
   1825                      }
   1826                    }
   1827          
   1828                    // check version of zigbee protocol
   1829                    if ( pNwkDesc->version != _NIB.nwkProtocolVersion )
   \                     ??bdb_filterNwkDisc_12:
   \   0000AA   8E82         MOV       DPL,R6
   \   0000AC   8F83         MOV       DPH,R7
   \   0000AE   A3           INC       DPTR
   \   0000AF   A3           INC       DPTR
   \   0000B0   A3           INC       DPTR
   \   0000B1   A3           INC       DPTR
   \   0000B2   A3           INC       DPTR
   \   0000B3   E0           MOVX      A,@DPTR
   \   0000B4   F8           MOV       R0,A
   \   0000B5   90....       MOV       DPTR,#_NIB + 17
   \   0000B8   E0           MOVX      A,@DPTR
   \   0000B9   68           XRL       A,R0
   \   0000BA   7020         JNZ       ??bdb_filterNwkDisc_13
   1830                      continue;
   1831          
   1832                    // check version of stack profile
   1833                    if ( pNwkDesc->stackProfile != zgStackProfile  )
   \   0000BC   8E82         MOV       DPL,R6
   \   0000BE   8F83         MOV       DPH,R7
   \   0000C0   A3           INC       DPTR
   \   0000C1   A3           INC       DPTR
   \   0000C2   A3           INC       DPTR
   \   0000C3   A3           INC       DPTR
   \   0000C4   A3           INC       DPTR
   \   0000C5   A3           INC       DPTR
   \   0000C6   E0           MOVX      A,@DPTR
   \   0000C7   F8           MOV       R0,A
   \   0000C8   90....       MOV       DPTR,#zgStackProfile
   \   0000CB   E0           MOVX      A,@DPTR
   \   0000CC   68           XRL       A,R0
   \   0000CD   600D         JZ        ??bdb_filterNwkDisc_13
   1834                    {
   1835                      if ( ((zgStackProfile == HOME_CONTROLS) && (pNwkDesc->stackProfile == ZIGBEEPRO_PROFILE))
   1836                          || ((zgStackProfile == ZIGBEEPRO_PROFILE) && (pNwkDesc->stackProfile == HOME_CONTROLS))  )
   1837                      {
   1838                        stackProfilePro = TRUE;
   1839                      }
   1840          
   1841                      if ( stackProfile == 0 )
   \   0000CF   E5..         MOV       A,?V1
   \   0000D1   7009         JNZ       ??bdb_filterNwkDisc_13
   1842                      {
   1843                        //Remove from the list
   1844                        bdb_nwkDescFree(pNwkDesc);
   \                     ??bdb_filterNwkDisc_8:
   \   0000D3                ; Setup parameters for call to function bdb_nwkDescFree
   \   0000D3   EE           MOV       A,R6
   \   0000D4   FA           MOV       R2,A
   \   0000D5   EF           MOV       A,R7
   \   0000D6   FB           MOV       R3,A
   \   0000D7   12....       LCALL     `??bdb_nwkDescFree::?relay`; Banked call to: bdb_nwkDescFree
   1845                        ResultCount--;
   \   0000DA   15..         DEC       ?V0
   1846                        continue;
   1847                      }
   1848                    }
   \                     ??bdb_filterNwkDisc_13:
   \   0000DC   05..         INC       ?V2
   \   0000DE   12....       LCALL     ?Subroutine32 & 0xFFFF
   \                     ??CrossCallReturnLabel_40:
   \   0000E1   12....       LCALL     ?Subroutine37 & 0xFFFF
   \                     ??CrossCallReturnLabel_49:
   \   0000E4   E5..         MOV       A,?V2
   \   0000E6   C3           CLR       C
   \   0000E7   95..         SUBB      A,?V0
   \   0000E9   5025         JNC       ??bdb_filterNwkDisc_3
   \   0000EB                ; Setup parameters for call to function nwk_ExtPANIDValid
   \   0000EB   7A..         MOV       R2,#ZDO_UseExtendedPANID & 0xff
   \   0000ED   7B..         MOV       R3,#(ZDO_UseExtendedPANID >> 8) & 0xff
   \   0000EF   12....       LCALL     `??nwk_ExtPANIDValid::?relay`; Banked call to: nwk_ExtPANIDValid
   \   0000F2   E9           MOV       A,R1
   \   0000F3   6401         XRL       A,#0x1
   \   0000F5   6003         JZ        $+5
   \   0000F7   02....       LJMP      ??bdb_filterNwkDisc_4 & 0xFFFF
   \   0000FA                ; Setup parameters for call to function sAddrExtCmp
   \   0000FA   EE           MOV       A,R6
   \   0000FB   240B         ADD       A,#0xb
   \   0000FD   FC           MOV       R4,A
   \   0000FE   E4           CLR       A
   \   0000FF   3F           ADDC      A,R7
   \   000100   FD           MOV       R5,A
   \   000101   7A..         MOV       R2,#ZDO_UseExtendedPANID & 0xff
   \   000103   7B..         MOV       R3,#(ZDO_UseExtendedPANID >> 8) & 0xff
   \   000105   12....       LCALL     `??sAddrExtCmp::?relay`; Banked call to: sAddrExtCmp
   \   000108   E9           MOV       A,R1
   \   000109   6003         JZ        $+5
   \   00010B   02....       LJMP      ??bdb_filterNwkDisc_6 & 0xFFFF
   \   00010E   80C3         SJMP      ??bdb_filterNwkDisc_8
   1849                  }
   1850                }
   1851              }
   \                     ??bdb_filterNwkDisc_3:
   \   000110   05..         INC       ?V1
   \   000112   E5..         MOV       A,?V1
   \   000114   C3           CLR       C
   \   000115   9402         SUBB      A,#0x2
   \   000117   5003         JNC       $+5
   \   000119   02....       LJMP      ??bdb_filterNwkDisc_2 & 0xFFFF
   1852            }
   1853          }
   \                     ??bdb_filterNwkDisc_1:
   \   00011C   7F03         MOV       R7,#0x3
   \   00011E   02....       LJMP      ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine32:
   \   000000   EE           MOV       A,R6
   \   000001   12....       LCALL     ?Subroutine39 & 0xFFFF
   \                     ??CrossCallReturnLabel_53:
   \   000004   3F           ADDC      A,R7
   \   000005   F583         MOV       DPH,A
   \   000007   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine39:
   \   000000   2414         ADD       A,#0x14
   \   000002   F582         MOV       DPL,A
   \   000004   E4           CLR       A
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine28:
   \   000000   12....       LCALL     ?Subroutine38 & 0xFFFF
   \                     ??CrossCallReturnLabel_111:
   \   000003   F9           MOV       R1,A
   \   000004   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine37:
   \   000000   E0           MOVX      A,@DPTR
   \   000001   FE           MOV       R6,A
   \   000002   A3           INC       DPTR
   \   000003   E0           MOVX      A,@DPTR
   \   000004   FF           MOV       R7,A
   \   000005   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine25:
   \   000000   90....       MOV       DPTR,#pBDBListNwk
   \   000003                REQUIRE ??Subroutine61_0
   \   000003                ; // Fall through to label ??Subroutine61_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine62_0:
   \   000000   EA           MOV       A,R2
   \   000001   F0           MOVX      @DPTR,A
   \   000002   A3           INC       DPTR
   \   000003   EB           MOV       A,R3
   \   000004   F0           MOVX      @DPTR,A
   \   000005   22           RET
   1854          
   1855           /*********************************************************************
   1856           * @fn          bdb_tryNwkAssoc
   1857           *
   1858           * @brief       Try to associate to the first network in the network descriptor list
   1859           *
   1860           * @param       none
   1861           *
   1862           * @return      none
   1863           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1864          static void bdb_tryNwkAssoc(void)
   \                     bdb_tryNwkAssoc:
   1865          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV       A,#-0x1
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   1866            if(pBDBListNwk)
   \   00000A   90....       MOV       DPTR,#pBDBListNwk
   \   00000D   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_100:
   \   000010   90....       MOV       DPTR,#bdbCommissioningProcedureState + 2
   \   000013   6017         JZ        ??bdb_tryNwkAssoc_0
   1867            {
   1868              bdbCommissioningProcedureState.bdbJoinState = BDB_JOIN_STATE_ASSOC;
   \   000015   12....       LCALL     ?Subroutine11 & 0xFFFF
   1869          
   1870              //Try the first in the list after the filtering
   1871              if(ZSuccess != bdb_joinProcess(pBDBListNwk))
   \                     ??CrossCallReturnLabel_10:
   \   000018   12....       LCALL     `??bdb_joinProcess::?relay`; Banked call to: bdb_joinProcess
   \   00001B   E9           MOV       A,R1
   \   00001C   602C         JZ        ??bdb_tryNwkAssoc_1
   1872              {
   1873                //If fail, free the first in the list and prepare for futher processing, either next nwk or discover again
   1874                uint8 bdbJoinEvent = BDB_JOIN_EVENT_ASSOCIATION;
   \   00001E   85..82       MOV       DPL,?XSP + 0
   \   000021   85..83       MOV       DPH,?XSP + 1
   \   000024   12....       LCALL     ?Subroutine11 & 0xFFFF
   1875                bdb_nwkDescFree(pBDBListNwk);
   \                     ??CrossCallReturnLabel_11:
   \   000027   12....       LCALL     `??bdb_nwkDescFree::?relay`; Banked call to: bdb_nwkDescFree
   1876                bdb_SendMsg(bdb_TaskID,BDB_COMMISSIONING_STATE_JOINING,BDB_MSG_EVENT_FAIL,sizeof(uint8),&bdbJoinEvent);
   \   00002A                ; Setup parameters for call to function bdb_SendMsg
   \   00002A   8005         SJMP      ??bdb_tryNwkAssoc_2
   1877              }
   1878            }
   1879            else
   1880            {
   1881              bdbCommissioningProcedureState.bdbJoinState = BDB_JOIN_STATE_NWK_DISC;
   \                     ??bdb_tryNwkAssoc_0:
   \   00002C   E4           CLR       A
   \   00002D   12....       LCALL     ??Subroutine53_0 & 0xFFFF
   1882              uint8 bdbJoinEvent = BDB_JOIN_EVENT_NWK_DISCOVERY;
   \                     ??CrossCallReturnLabel_115:
   \   000030   F0           MOVX      @DPTR,A
   1883          
   1884              bdb_SendMsg(bdb_TaskID,BDB_COMMISSIONING_STATE_JOINING,BDB_MSG_EVENT_FAIL,sizeof(uint8),&bdbJoinEvent);
   \   000031                ; Setup parameters for call to function bdb_SendMsg
   \                     ??bdb_tryNwkAssoc_2:
   \   000031   A8..         MOV       R0,?XSP + 0
   \   000033   A9..         MOV       R1,?XSP + 1
   \   000035   88..         MOV       ?V0,R0
   \   000037   89..         MOV       ?V1,R1
   \   000039   78..         MOV       R0,#?V0
   \   00003B   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00003E   7C01         MOV       R4,#0x1
   \   000040   7B01         MOV       R3,#0x1
   \   000042   7A03         MOV       R2,#0x3
   1885            }
   \   000044   12....       LCALL     ??Subroutine48_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_79:
   \   000047   12....       LCALL     ?DEALLOC_XSTACK8
   1886          }
   \                     ??bdb_tryNwkAssoc_1:
   \   00004A   02....       LJMP      ?Subroutine1 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine11:
   \   000000   7401         MOV       A,#0x1
   \   000002   F0           MOVX      @DPTR,A
   \   000003                ; Setup parameters for call to function bdb_joinProcess
   \   000003                ; Setup parameters for call to function bdb_nwkDescFree
   \   000003   12....       LCALL     ?Subroutine36 & 0xFFFF
   \                     ??CrossCallReturnLabel_150:
   \   000006   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine53_0:
   \   000000   F0           MOVX      @DPTR,A
   \   000001   85..82       MOV       DPL,?XSP + 0
   \   000004   85..83       MOV       DPH,?XSP + 1
   \   000007   22           RET
   1887          
   1888          
   1889          
   1890           /*********************************************************************
   1891           * @fn          bdb_nwkAssocAttemt
   1892           *
   1893           * @brief       Process the result of an attempt to associate to a network
   1894           *
   1895           * @param       didSuccess - bool
   1896           *
   1897           * @return      none
   1898           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1899          void bdb_nwkAssocAttemt(bool didSuccess)
   \                     bdb_nwkAssocAttemt:
   1900          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV       A,#-0x1
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   1901            bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_STATE_JOINING;
   \   00000A   90....       MOV       DPTR,#bdbAttributes + 10
   \   00000D   7403         MOV       A,#0x3
   \   00000F   12....       LCALL     ?Subroutine9 & 0xFFFF
   1902            uint8 bdbJoinEvent = BDB_JOIN_EVENT_ASSOCIATION;
   \                     ??CrossCallReturnLabel_9:
   \   000012   F0           MOVX      @DPTR,A
   1903            uint8 status;
   1904          
   1905            if(didSuccess)
   \   000013   E9           MOV       A,R1
   \   000014   6004         JZ        ??bdb_nwkAssocAttemt_0
   1906            {
   1907              status = BDB_MSG_EVENT_SUCCESS;
   \   000016   7B00         MOV       R3,#0x0
   \   000018   8017         SJMP      ??bdb_nwkAssocAttemt_1
   1908            }
   1909            else
   1910            {
   1911              if(bdb_nwkAssocRetriesCount < BDBC_REC_SAME_NETWORK_RETRY_ATTEMPS)
   \                     ??bdb_nwkAssocAttemt_0:
   \   00001A   90....       MOV       DPTR,#bdb_nwkAssocRetriesCount
   \   00001D   E0           MOVX      A,@DPTR
   \   00001E   C3           CLR       C
   \   00001F   9403         SUBB      A,#0x3
   \   000021   5004         JNC       ??bdb_nwkAssocAttemt_2
   1912              {
   1913                bdb_nwkAssocRetriesCount++;
   \   000023   E0           MOVX      A,@DPTR
   \   000024   04           INC       A
   \   000025   8007         SJMP      ??bdb_nwkAssocAttemt_3
   1914              }
   1915              else
   1916              {
   1917                //Free the first in the list and prepare for futher processing
   1918                bdb_nwkDescFree(pBDBListNwk);
   \                     ??bdb_nwkAssocAttemt_2:
   \   000027                ; Setup parameters for call to function bdb_nwkDescFree
   \   000027   12....       LCALL     ?Subroutine18 & 0xFFFF
   1919                bdb_nwkAssocRetriesCount = 0;
   \                     ??CrossCallReturnLabel_17:
   \   00002A   90....       MOV       DPTR,#bdb_nwkAssocRetriesCount
   \   00002D   E4           CLR       A
   \                     ??bdb_nwkAssocAttemt_3:
   \   00002E   F0           MOVX      @DPTR,A
   1920              }
   1921              status = BDB_MSG_EVENT_FAIL;
   \   00002F   7B01         MOV       R3,#0x1
   1922            }
   1923            bdb_SendMsg(bdb_TaskID,BDB_COMMISSIONING_STATE_JOINING,status,sizeof(uint8),&bdbJoinEvent);
   \                     ??bdb_nwkAssocAttemt_1:
   \   000031                ; Setup parameters for call to function bdb_SendMsg
   \   000031   A8..         MOV       R0,?XSP + 0
   \   000033   A9..         MOV       R1,?XSP + 1
   \   000035   88..         MOV       ?V0,R0
   \   000037   89..         MOV       ?V1,R1
   \   000039   78..         MOV       R0,#?V0
   \   00003B   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00003E   7C01         MOV       R4,#0x1
   \   000040   7A03         MOV       R2,#0x3
   \   000042   12....       LCALL     ??Subroutine48_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_80:
   \   000045   12....       LCALL     ?DEALLOC_XSTACK8
   1924          }
   \   000048   02....       LJMP      ?Subroutine1 & 0xFFFF
   1925          
   1926          
   1927          /****************************************************************************
   1928           * @fn          bdb_nwkDescFree
   1929           *
   1930           * @brief       This function frees one network discovery data.
   1931           *
   1932           * @param       ZSuccess - If the device was found and erased
   1933           * @param       ZInvalidParameter - Not found
   1934           *
   1935           * @return      none
   1936           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1937          ZStatus_t bdb_nwkDescFree(networkDesc_t* nodeDescToRemove)
   \                     bdb_nwkDescFree:
   1938          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1939            networkDesc_t* current_desc;
   1940            networkDesc_t* prev_desc;
   1941          
   1942            current_desc = pBDBListNwk;
   \   000004   90....       MOV       DPTR,#pBDBListNwk
   \   000007   8007         SJMP      ??CrossCallReturnLabel_41
   1943          
   1944            while(current_desc != NULL)
   1945            {
   1946              if(current_desc == nodeDescToRemove)
   1947              {
   1948                if (current_desc == pBDBListNwk)
   1949                {
   1950                  pBDBListNwk = pBDBListNwk->nextDesc;
   1951                }
   1952                else
   1953                {
   1954                  prev_desc->nextDesc = current_desc->nextDesc;
   1955                }
   1956          
   1957                osal_mem_free( current_desc );
   1958          
   1959                return ZSuccess;
   1960              }
   1961          
   1962              prev_desc = current_desc;
   \                     ??bdb_nwkDescFree_0:
   \   000009   E8           MOV       A,R0
   \   00000A   FC           MOV       R4,A
   \   00000B   E9           MOV       A,R1
   \   00000C   FD           MOV       R5,A
   1963              current_desc = current_desc->nextDesc;
   \   00000D   12....       LCALL     ?Subroutine33 & 0xFFFF
   \                     ??CrossCallReturnLabel_41:
   \   000010   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_92:
   \   000013   603D         JZ        ??bdb_nwkDescFree_1
   \   000015   EA           MOV       A,R2
   \   000016   68           XRL       A,R0
   \   000017   7002         JNZ       ??bdb_nwkDescFree_2
   \   000019   EB           MOV       A,R3
   \   00001A   69           XRL       A,R1
   \                     ??bdb_nwkDescFree_2:
   \   00001B   70EC         JNZ       ??bdb_nwkDescFree_0
   \   00001D   12....       LCALL     ?Subroutine25 & 0xFFFF
   \                     ??CrossCallReturnLabel_148:
   \   000020   E8           MOV       A,R0
   \   000021   6A           XRL       A,R2
   \   000022   7002         JNZ       ??bdb_nwkDescFree_3
   \   000024   E9           MOV       A,R1
   \   000025   6B           XRL       A,R3
   \                     ??bdb_nwkDescFree_3:
   \   000026   700F         JNZ       ??bdb_nwkDescFree_4
   \   000028   EA           MOV       A,R2
   \   000029   12....       LCALL     ?Subroutine39 & 0xFFFF
   \                     ??CrossCallReturnLabel_51:
   \   00002C   3B           ADDC      A,R3
   \   00002D   F583         MOV       DPH,A
   \   00002F   12....       LCALL     ??Subroutine61_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_143:
   \   000032   90....       MOV       DPTR,#pBDBListNwk
   \   000035   800D         SJMP      ??bdb_nwkDescFree_5
   \                     ??bdb_nwkDescFree_4:
   \   000037   12....       LCALL     ?Subroutine33 & 0xFFFF
   \                     ??CrossCallReturnLabel_42:
   \   00003A   12....       LCALL     ??Subroutine61_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_144:
   \   00003D   EC           MOV       A,R4
   \   00003E   12....       LCALL     ?Subroutine39 & 0xFFFF
   \                     ??CrossCallReturnLabel_52:
   \   000041   3D           ADDC      A,R5
   \   000042   F583         MOV       DPH,A
   \                     ??bdb_nwkDescFree_5:
   \   000044   12....       LCALL     ??Subroutine62_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_157:
   \   000047                ; Setup parameters for call to function osal_mem_free
   \   000047   E8           MOV       A,R0
   \   000048   FA           MOV       R2,A
   \   000049   E9           MOV       A,R1
   \   00004A   FB           MOV       R3,A
   \   00004B   12....       LCALL     `??osal_mem_free::?relay`; Banked call to: osal_mem_free
   \   00004E   7900         MOV       R1,#0x0
   \   000050   8002         SJMP      ??bdb_nwkDescFree_6
   1964            }
   1965          
   1966            return ZInvalidParameter;
   \                     ??bdb_nwkDescFree_1:
   \   000052   7902         MOV       R1,#0x2
   \                     ??bdb_nwkDescFree_6:
   \   000054   02....       LJMP      ??Subroutine42_0 & 0xFFFF
   1967          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine33:
   \   000000   E8           MOV       A,R0
   \   000001   12....       LCALL     ?Subroutine39 & 0xFFFF
   \                     ??CrossCallReturnLabel_54:
   \   000004   39           ADDC      A,R1
   \   000005   F583         MOV       DPH,A
   \   000007   22           RET
   1968          
   1969          /*********************************************************************
   1970          * @fn          bdb_joinProcess
   1971          *
   1972          * @brief       Start the joining process for the selected nwk
   1973          *
   1974          * @return      ZStatus_t
   1975          */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1976          ZStatus_t bdb_joinProcess(networkDesc_t *pChosenNwk)
   \                     bdb_joinProcess:
   1977          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   EA           MOV       A,R2
   \   000006   FE           MOV       R6,A
   \   000007   EB           MOV       A,R3
   \   000008   FF           MOV       R7,A
   1978            ZStatus_t status;
   1979          
   1980            ZDApp_ChangeState( DEV_NWK_JOINING );
   \   000009                ; Setup parameters for call to function ZDApp_ChangeState
   \   000009   7903         MOV       R1,#0x3
   \   00000B   12....       LCALL     `??ZDApp_ChangeState::?relay`; Banked call to: ZDApp_ChangeState
   1981            ZDApp_NodeProfileSync( pChosenNwk->stackProfile);
   \   00000E                ; Setup parameters for call to function ZDApp_NodeProfileSync
   \   00000E   8E82         MOV       DPL,R6
   \   000010   8F83         MOV       DPH,R7
   \   000012   A3           INC       DPTR
   \   000013   A3           INC       DPTR
   \   000014   A3           INC       DPTR
   \   000015   A3           INC       DPTR
   \   000016   A3           INC       DPTR
   \   000017   A3           INC       DPTR
   \   000018   E0           MOVX      A,@DPTR
   \   000019   F9           MOV       R1,A
   \   00001A   12....       LCALL     `??ZDApp_NodeProfileSync::?relay`; Banked call to: ZDApp_NodeProfileSync
   1982          
   1983            status =  NLME_JoinRequest( pChosenNwk->extendedPANID, pChosenNwk->panId,
   1984                                  pChosenNwk->logicalChannel,
   1985                                  ZDO_Config_Node_Descriptor.CapabilityFlags,
   1986                                  pChosenNwk->chosenRouter, pChosenNwk->chosenRouterDepth );
   \   00001D                ; Setup parameters for call to function NLME_JoinRequest
   \   00001D   8E82         MOV       DPL,R6
   \   00001F   8F83         MOV       DPH,R7
   \   000021   A3           INC       DPTR
   \   000022   A3           INC       DPTR
   \   000023   A3           INC       DPTR
   \   000024   A3           INC       DPTR
   \   000025   A3           INC       DPTR
   \   000026   A3           INC       DPTR
   \   000027   A3           INC       DPTR
   \   000028   A3           INC       DPTR
   \   000029   A3           INC       DPTR
   \   00002A   A3           INC       DPTR
   \   00002B   E0           MOVX      A,@DPTR
   \   00002C   F5..         MOV       ?V0,A
   \   00002E   78..         MOV       R0,#?V0
   \   000030   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000033   8E82         MOV       DPL,R6
   \   000035   8F83         MOV       DPH,R7
   \   000037   A3           INC       DPTR
   \   000038   A3           INC       DPTR
   \   000039   A3           INC       DPTR
   \   00003A   A3           INC       DPTR
   \   00003B   A3           INC       DPTR
   \   00003C   A3           INC       DPTR
   \   00003D   A3           INC       DPTR
   \   00003E   12....       LCALL     ?PUSH_XSTACK8_X_TWO
   \   000041   90....       MOV       DPTR,#ZDO_Config_Node_Descriptor + 2
   \   000044   E0           MOVX      A,@DPTR
   \   000045   F5..         MOV       ?V0,A
   \   000047   78..         MOV       R0,#?V0
   \   000049   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   00004C   8E82         MOV       DPL,R6
   \   00004E   8F83         MOV       DPH,R7
   \   000050   A3           INC       DPTR
   \   000051   A3           INC       DPTR
   \   000052   E0           MOVX      A,@DPTR
   \   000053   F9           MOV       R1,A
   \   000054   8E82         MOV       DPL,R6
   \   000056   8F83         MOV       DPH,R7
   \   000058   12....       LCALL     ?Subroutine27 & 0xFFFF
   \                     ??CrossCallReturnLabel_28:
   \   00005B   EE           MOV       A,R6
   \   00005C   240B         ADD       A,#0xb
   \   00005E   FA           MOV       R2,A
   \   00005F   E4           CLR       A
   \   000060   3F           ADDC      A,R7
   \   000061   FB           MOV       R3,A
   \   000062   12....       LCALL     `??NLME_JoinRequest::?relay`; Banked call to: NLME_JoinRequest
   \   000065   7404         MOV       A,#0x4
   \   000067   12....       LCALL     ?DEALLOC_XSTACK8
   \   00006A   E9           MOV       A,R1
   \   00006B   FE           MOV       R6,A
   1987          
   1988            if(status == ZSuccess)
   \   00006C   7054         JNZ       ??bdb_joinProcess_0
   1989            {
   1990              // The receiver is on, turn network layer polling off.
   1991              if ( ZDO_Config_Node_Descriptor.CapabilityFlags & CAPINFO_RCVR_ON_IDLE )
   \   00006E   90....       MOV       DPTR,#ZDO_Config_Node_Descriptor + 2
   \   000071   E0           MOVX      A,@DPTR
   \   000072   A2E3         MOV       C,0xE0 /* A   */.3
   \   000074   5029         JNC       ??bdb_joinProcess_1
   1992              {
   1993                // for an End Device with NO Child Table Management process or for a Router
   1994                if ( ( ZG_DEVICE_RTR_TYPE )  ||
   1995                     ( (ZG_DEVICE_ENDDEVICE_TYPE) && ( zgChildAgingEnable == FALSE ) ) )
   \   000076   90....       MOV       DPTR,#zgDeviceLogicalType
   \   000079   E0           MOVX      A,@DPTR
   \   00007A   600A         JZ        ??bdb_joinProcess_2
   \   00007C   6401         XRL       A,#0x1
   \   00007E   6006         JZ        ??bdb_joinProcess_2
   \   000080   90....       MOV       DPTR,#zgChildAgingEnable
   \   000083   E0           MOVX      A,@DPTR
   \   000084   703C         JNZ       ??bdb_joinProcess_0
   1996                {
   1997                  NLME_SetPollRate( 0 );
   \                     ??bdb_joinProcess_2:
   \   000086                ; Setup parameters for call to function NLME_SetPollRate
   \   000086   90....       MOV       DPTR,#__Constant_0
   \   000089   12....       LCALL     ?XLOAD_R2345
   \   00008C   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   1998                  NLME_SetQueuedPollRate( 0 );
   \   00008F                ; Setup parameters for call to function NLME_SetQueuedPollRate
   \   00008F   7A00         MOV       R2,#0x0
   \   000091   7B00         MOV       R3,#0x0
   \   000093   12....       LCALL     `??NLME_SetQueuedPollRate::?relay`; Banked call to: NLME_SetQueuedPollRate
   1999                  NLME_SetResponseRate( 0 );
   \   000096                ; Setup parameters for call to function NLME_SetResponseRate
   \   000096   7A00         MOV       R2,#0x0
   \   000098   7B00         MOV       R3,#0x0
   \   00009A   12....       LCALL     `??NLME_SetResponseRate::?relay`; Banked call to: NLME_SetResponseRate
   \   00009D   8023         SJMP      ??bdb_joinProcess_0
   2000                }
   2001              }
   2002              else
   2003              {
   2004                if ( (ZG_SECURE_ENABLED) && (devStartMode == MODE_JOIN) )
   \                     ??bdb_joinProcess_1:
   \   00009F   90....       MOV       DPTR,#devStartMode
   \   0000A2   E0           MOVX      A,@DPTR
   \   0000A3   701D         JNZ       ??bdb_joinProcess_0
   2005                {
   2006                  ZDApp_SavedPollRate = zgPollRate;
   \   0000A5   90....       MOV       DPTR,#zgPollRate
   \   0000A8   12....       LCALL     ?XLOAD_R0123
   \   0000AB   90....       MOV       DPTR,#ZDApp_SavedPollRate
   \   0000AE   12....       LCALL     ?XSTORE_R0123
   2007                  NLME_SetPollRate( zgRejoinPollRate );
   \   0000B1                ; Setup parameters for call to function NLME_SetPollRate
   \   0000B1   90....       MOV       DPTR,#zgRejoinPollRate
   \   0000B4   E0           MOVX      A,@DPTR
   \   0000B5   F5..         MOV       ?V0,A
   \   0000B7   A3           INC       DPTR
   \   0000B8   E0           MOVX      A,@DPTR
   \   0000B9   AA..         MOV       R2,?V0
   \   0000BB   FB           MOV       R3,A
   \   0000BC   E4           CLR       A
   \   0000BD   FC           MOV       R4,A
   \   0000BE   FD           MOV       R5,A
   \   0000BF   12....       LCALL     `??NLME_SetPollRate::?relay`; Banked call to: NLME_SetPollRate
   2008                }
   2009              }
   2010            }
   2011            return status;
   \                     ??bdb_joinProcess_0:
   \   0000C2   EE           MOV       A,R6
   \   0000C3   F9           MOV       R1,A
   \   0000C4   02....       LJMP      ??Subroutine60_0 & 0xFFFF
   2012          }
   2013          #endif
   2014          
   2015          
   2016           /*********************************************************************
   2017           * @fn          bdb_setChannelAttribute
   2018           *
   2019           * @brief       Set the primary or seconday channel for discovery or formation procedure
   2020           *
   2021           * @param       isPrimaryChannel - True if channel to set is primary,
   2022           *                                 False if the channel to set is secondary
   2023           *
   2024           * @param       channel - Channel mask
   2025           *
   2026           * @return      none
   2027           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2028          void bdb_setChannelAttribute(bool isPrimaryChannel, uint32 channel)
   \                     bdb_setChannelAttribute:
   2029          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV       ?V0,R2
   \   000007   8B..         MOV       ?V1,R3
   \   000009   8C..         MOV       ?V2,R4
   \   00000B   8D..         MOV       ?V3,R5
   2030            if(isPrimaryChannel)
   \   00000D   E9           MOV       A,R1
   \   00000E   6005         JZ        ??bdb_setChannelAttribute_0
   2031            {
   2032              bdbAttributes.bdbPrimaryChannelSet = channel;
   \   000010   90....       MOV       DPTR,#bdbAttributes + 4
   \   000013   8003         SJMP      ??bdb_setChannelAttribute_1
   2033            }
   2034            else
   2035            {
   2036              bdbAttributes.bdbSecondaryChannelSet = channel;
   \                     ??bdb_setChannelAttribute_0:
   \   000015   90....       MOV       DPTR,#bdbAttributes
   \                     ??bdb_setChannelAttribute_1:
   \   000018   78..         MOV       R0,#?V0
   \   00001A   12....       LCALL     ?L_MOV_TO_X
   2037            }
   2038          }
   \   00001D   02....       LJMP      ??Subroutine50_0 & 0xFFFF
   2039          
   2040           /*********************************************************************
   2041           * @fn          bdb_setChannel
   2042           *
   2043           * @brief       Set channel and save it in Nv for joining/formation operations
   2044           *
   2045           * @param       channel - Channel mask
   2046           *
   2047           * @return      none
   2048           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2049          void bdb_setChannel(uint32 channel)
   \                     bdb_setChannel:
   2050          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV       ?V0,R2
   \   000007   8B..         MOV       ?V1,R3
   \   000009   8C..         MOV       ?V2,R4
   \   00000B   8D..         MOV       ?V3,R5
   2051            //Assign the channel and save it into nv
   2052            vScanChannels = channel;
   \   00000D   90....       MOV       DPTR,#zgDefaultChannelList
   \   000010   78..         MOV       R0,#?V0
   \   000012   12....       LCALL     ?L_MOV_TO_X
   2053            runtimeChannel = channel;
   \   000015   90....       MOV       DPTR,#runtimeChannel
   \   000018   78..         MOV       R0,#?V0
   \   00001A   12....       LCALL     ?L_MOV_TO_X
   2054          
   2055            osal_nv_write(ZCD_NV_CHANLIST,0,sizeof(uint32),&vScanChannels);
   \   00001D                ; Setup parameters for call to function osal_nv_write
   \   00001D   75....       MOV       ?V0,#zgDefaultChannelList & 0xff
   \   000020   75....       MOV       ?V1,#(zgDefaultChannelList >> 8) & 0xff
   \   000023   78..         MOV       R0,#?V0
   \   000025   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000028   75..04       MOV       ?V0,#0x4
   \   00002B   75..00       MOV       ?V1,#0x0
   \   00002E   78..         MOV       R0,#?V0
   \   000030   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000033   7C00         MOV       R4,#0x0
   \   000035   7D00         MOV       R5,#0x0
   \   000037   7A84         MOV       R2,#-0x7c
   \   000039   7B00         MOV       R3,#0x0
   \   00003B   12....       LCALL     `??osal_nv_write::?relay`; Banked call to: osal_nv_write
   \   00003E   02....       LJMP      ?Subroutine2 & 0xFFFF
   2056          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   7404         MOV       A,#0x4
   \   000002                REQUIRE ??Subroutine49_0
   \   000002                ; // Fall through to label ??Subroutine49_0
   2057          
   2058          
   2059           /*********************************************************************
   2060           * @fn          bdb_nwkJoiningFormation
   2061           *
   2062           * @brief       Performs Joining/Formation operation on primary or secondary channel
   2063           *
   2064           * @param       isJoining - TRUE if the device is performing joining, FALSE is performing Formation
   2065           *
   2066           * @return      none
   2067           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2068          void bdb_nwkJoiningFormation(bool isJoining)
   \                     bdb_nwkJoiningFormation:
   2069          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   \   000006   FE           MOV       R6,A
   2070          
   2071            if((vDoPrimaryScan) && (bdbAttributes.bdbPrimaryChannelSet))
   \   000007   90....       MOV       DPTR,#vDoPrimaryScan
   \   00000A   E0           MOVX      A,@DPTR
   \   00000B   601C         JZ        ??bdb_nwkJoiningFormation_0
   \   00000D   90....       MOV       DPTR,#bdbAttributes + 4
   \   000010   78..         MOV       R0,#?V0
   \   000012   12....       LCALL     ?L_MOV_X
   \   000015   E5..         MOV       A,?V0
   \   000017   45..         ORL       A,?V1
   \   000019   45..         ORL       A,?V2
   \   00001B   45..         ORL       A,?V3
   \   00001D   600A         JZ        ??bdb_nwkJoiningFormation_0
   2072            {
   2073              bdb_setChannel(bdbAttributes.bdbPrimaryChannelSet);
   \   00001F                ; Setup parameters for call to function bdb_setChannel
   \   00001F   AA..         MOV       R2,?V0
   \   000021   AB..         MOV       R3,?V1
   \   000023   AC..         MOV       R4,?V2
   \   000025   AD..         MOV       R5,?V3
   \   000027   800B         SJMP      ??bdb_nwkJoiningFormation_1
   2074            }
   2075            else
   2076            {
   2077              vDoPrimaryScan = FALSE;
   \                     ??bdb_nwkJoiningFormation_0:
   \   000029   90....       MOV       DPTR,#vDoPrimaryScan
   \   00002C   E4           CLR       A
   \   00002D   F0           MOVX      @DPTR,A
   2078              bdb_setChannel(bdbAttributes.bdbSecondaryChannelSet);
   \   00002E                ; Setup parameters for call to function bdb_setChannel
   \   00002E   90....       MOV       DPTR,#bdbAttributes
   \   000031   12....       LCALL     ?XLOAD_R2345
   \                     ??bdb_nwkJoiningFormation_1:
   \   000034   12....       LCALL     `??bdb_setChannel::?relay`; Banked call to: bdb_setChannel
   2079            }
   2080          
   2081            if(vScanChannels)
   \   000037   90....       MOV       DPTR,#zgDefaultChannelList
   \   00003A   12....       LCALL     ?XLOAD_R0123
   \   00003D   E8           MOV       A,R0
   \   00003E   49           ORL       A,R1
   \   00003F   4A           ORL       A,R2
   \   000040   4B           ORL       A,R3
   \   000041   601A         JZ        ??bdb_nwkJoiningFormation_2
   2082            {
   2083              if(ZG_DEVICE_RTRONLY_TYPE)
   \   000043   90....       MOV       DPTR,#zgDeviceLogicalType
   \   000046   E0           MOVX      A,@DPTR
   \   000047   6401         XRL       A,#0x1
   \   000049   7007         JNZ       ??bdb_nwkJoiningFormation_3
   2084              {
   2085                if(isJoining)
   \   00004B   EE           MOV       A,R6
   \   00004C   7004         JNZ       ??bdb_nwkJoiningFormation_3
   2086                {
   2087                  ZDOInitDeviceEx(100,0);
   2088                }
   2089                else
   2090                {
   2091                  ZDOInitDeviceEx(100,1);
   \   00004E                ; Setup parameters for call to function ZDOInitDeviceEx
   \   00004E   7901         MOV       R1,#0x1
   \   000050   8002         SJMP      ??bdb_nwkJoiningFormation_4
   2092                }
   2093              }
   2094              //ZED can only join, and ZC can only create
   2095              else
   2096              {
   2097                ZDOInitDeviceEx(100,0);
   \                     ??bdb_nwkJoiningFormation_3:
   \   000052                ; Setup parameters for call to function ZDOInitDeviceEx
   \   000052   7900         MOV       R1,#0x0
   \                     ??bdb_nwkJoiningFormation_4:
   \   000054   7A64         MOV       R2,#0x64
   \   000056   7B00         MOV       R3,#0x0
   \   000058   12....       LCALL     `??ZDOInitDeviceEx::?relay`; Banked call to: ZDOInitDeviceEx
   \   00005B   800E         SJMP      ??bdb_nwkJoiningFormation_5
   2098              }
   2099            }
   2100            else
   2101            {
   2102              if(isJoining)
   \                     ??bdb_nwkJoiningFormation_2:
   \   00005D   EE           MOV       A,R6
   \   00005E   7A00         MOV       R2,#0x0
   \   000060   6004         JZ        ??bdb_nwkJoiningFormation_6
   2103              {
   2104                bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_JOINING, FALSE);
   \   000062                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000062   7903         MOV       R1,#0x3
   \   000064   8002         SJMP      ??bdb_nwkJoiningFormation_7
   2105              }
   2106              else
   2107              {
   2108                bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_FORMATION, FALSE);
   \                     ??bdb_nwkJoiningFormation_6:
   \   000066                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000066   7905         MOV       R1,#0x5
   \                     ??bdb_nwkJoiningFormation_7:
   \   000068   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   2109              }
   2110            }
   2111          }
   \                     ??bdb_nwkJoiningFormation_5:
   \   00006B   80..         SJMP      ??Subroutine50_0
   2112          
   2113          #if (ZG_BUILD_JOINING_TYPE)
   2114           /*********************************************************************
   2115           * @fn          bdb_tcLinkKeyExchangeAttempt
   2116           *
   2117           * @brief       Generic send msg for TC link key exchange process attempts
   2118           *
   2119           * @param       didSuccess - FALSE if the step failed/timeout, TRUE otherwise
   2120           * @param       bdbTCExchangeState - Step in which the attemp was done
   2121           *
   2122           * @return      none
   2123           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2124          void bdb_tcLinkKeyExchangeAttempt(bool didSuccess, uint8 bdbTCExchangeState)
   \                     bdb_tcLinkKeyExchangeAttempt:
   2125          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV       A,#-0x1
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   2126            bool bdbEventStatus = BDB_MSG_EVENT_SUCCESS;
   \   00000A   7E00         MOV       R6,#0x0
   2127            uint8 dummy;
   2128            bdbCommissioningProcedureState.bdbTCExchangeState = bdbTCExchangeState;
   \   00000C   EA           MOV       A,R2
   \   00000D   90....       MOV       DPTR,#bdbCommissioningProcedureState + 1
   \   000010   F0           MOVX      @DPTR,A
   2129            if(didSuccess)
   \   000011   E9           MOV       A,R1
   \   000012   600A         JZ        ??bdb_tcLinkKeyExchangeAttempt_0
   2130            {
   2131              //Allow try since we are performing a new step.
   2132              osal_stop_timerEx(bdb_TaskID, BDB_PROCESS_TIMEOUT);
   \   000014                ; Setup parameters for call to function osal_stop_timerEx
   \   000014   12....       LCALL     ?Subroutine17 & 0xFFFF
   2133              bdbAttributes.bdbTCLinkKeyExchangeAttempts = 0;
   \                     ??CrossCallReturnLabel_67:
   \   000017   90....       MOV       DPTR,#bdbAttributes + 16
   \   00001A   E4           CLR       A
   \   00001B   F0           MOVX      @DPTR,A
   \   00001C   8002         SJMP      ??bdb_tcLinkKeyExchangeAttempt_1
   2134            }
   2135            else
   2136            {
   2137              bdbEventStatus = BDB_MSG_EVENT_FAIL;
   \                     ??bdb_tcLinkKeyExchangeAttempt_0:
   \   00001E   7E01         MOV       R6,#0x1
   2138            }
   2139            bdb_SendMsg(bdb_TaskID,BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE,bdbEventStatus,1, &dummy);
   \                     ??bdb_tcLinkKeyExchangeAttempt_1:
   \   000020                ; Setup parameters for call to function bdb_SendMsg
   \   000020   A8..         MOV       R0,?XSP + 0
   \   000022   A9..         MOV       R1,?XSP + 1
   \   000024   88..         MOV       ?V2,R0
   \   000026   89..         MOV       ?V3,R1
   \   000028   78..         MOV       R0,#?V2
   \   00002A   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00002D   7C01         MOV       R4,#0x1
   \   00002F   EE           MOV       A,R6
   \   000030   FB           MOV       R3,A
   \   000031   7A01         MOV       R2,#0x1
   \   000033   12....       LCALL     ??Subroutine48_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_81:
   \   000036   12....       LCALL     ?DEALLOC_XSTACK8
   2140          }
   \   000039   7401         MOV       A,#0x1
   \   00003B   80..         SJMP      ??Subroutine49_0
   2141          
   2142          
   2143           /*********************************************************************
   2144           * @fn          bdb_requestVerifyTCLinkKey
   2145           *
   2146           * @brief       Attempt to verify the TC link key by sending Verify Key Request
   2147           *
   2148           * @param       none
   2149           *
   2150           * @return      none
   2151           */
   2152          void bdb_requestVerifyTCLinkKey(void)
   2153          {
   2154              uint8 TC_ExtAddr[Z_EXTADDR_LEN];
   2155              APSME_VerifyKeyReq_t vKey;
   2156          
   2157              APSME_GetRequest( apsTrustCenterAddress,0, TC_ExtAddr );
   2158          
   2159              vKey.tcExtAddr = TC_ExtAddr;
   2160              vKey.keyType = KEY_TYPE_TC_LINK;
   2161          
   2162              APSME_VerifyKeyReq( &vKey );
   2163          
   2164              osal_stop_timerEx(bdb_TaskID,BDB_PROCESS_TIMEOUT);
   2165              osal_start_timerEx(bdb_TaskID,BDB_PROCESS_TIMEOUT,BDBC_TC_LINK_KEY_EXANGE_TIMEOUT);
   2166          
   2167          }
   2168          
   2169          /*********************************************************************
   2170           * @fn          bdb_requestTCLinkKey
   2171           *
   2172           * @brief       Attempt to request a TC link key
   2173           *
   2174           * @param       none
   2175           *
   2176           * @return      none
   2177           */
   2178          void bdb_requestTCLinkKey(void)
   2179          {
   2180            zAddrType_t destAddr;
   2181            APSME_RequestKeyReq_t req;
   2182          
   2183            destAddr.addrMode = Addr16Bit;
   2184            destAddr.addr.shortAddr = 0x0000;
   2185          
   2186            req.dstAddr = destAddr.addr.shortAddr;
   2187            req.keyType = KEY_TYPE_TC_LINK;
   2188          
   2189            APSME_RequestKeyReq(&req);
   2190          
   2191            osal_stop_timerEx(bdb_TaskID,BDB_PROCESS_TIMEOUT);
   2192          
   2193            osal_start_timerEx(bdb_TaskID,BDB_PROCESS_TIMEOUT,(uint32)requestLinkKeyTimeout);
   2194          }
   2195          
   2196          
   2197          /*********************************************************************
   2198           * @fn          bdb_requestTCStackVersion
   2199           *
   2200           * @brief       Attempt to request the TC stack version using ZDP Node desc if
   2201           *              join a Centralized nwk
   2202           *
   2203           * @param       none
   2204           *
   2205           * @return      none
   2206           */
   2207          void bdb_requestTCStackVersion(void)
   2208          {
   2209            if(requestNewTrustCenterLinkKey)
   2210            {
   2211              if(!APSME_IsDistributedSecurity())
   2212              {
   2213                if(bdbAttributes.bdbTCLinkKeyExchangeMethod == BDB_TC_LINK_KEY_EXCHANGE_APS_KEY)
   2214                {
   2215                  zAddrType_t destAddr;
   2216          
   2217                  destAddr.addrMode = Addr16Bit;
   2218                  destAddr.addr.shortAddr = 0x0000;
   2219          
   2220                  ZDP_NodeDescReq( &destAddr, destAddr.addr.shortAddr, 0);
   2221          
   2222                  osal_stop_timerEx(bdb_TaskID,BDB_PROCESS_TIMEOUT);
   2223                  osal_start_timerEx( bdb_TaskID, BDB_PROCESS_TIMEOUT, BDBC_TC_LINK_KEY_EXANGE_TIMEOUT );
   2224                  return;
   2225                }
   2226                else
   2227                {
   2228                  if(pfnCBKETCLinkKeyExchange)
   2229                  {
   2230                    pfnCBKETCLinkKeyExchange();
   2231                  }
   2232                  return;
   2233                }
   2234              }
   2235              else
   2236              {
   2237                bdb_setNodeJoinLinkKeyType(BDB_DISTRIBUTED_SECURITY_GLOBAL_LINK_KEY);
   2238              }
   2239            }
   2240            else
   2241            {
   2242              //Key not required, set default which is global
   2243              bdb_setNodeJoinLinkKeyType(BDB_DEFAULT_GLOBAL_TRUST_CENTER_LINK_KEY);
   2244            }
   2245            //TC link key not required or join distributed nwk
   2246            bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE,TRUE);
   2247          }
   2248          #endif
   2249          
   2250          
   2251          /*********************************************************************
   2252           * @fn          bdb_nwkSteeringDeviceOnNwk
   2253           *
   2254           * @brief       Send ZDP mgmt permit joining
   2255           *
   2256           * @param       none
   2257           *
   2258           * @return      none
   2259           */
   2260          void bdb_nwkSteeringDeviceOnNwk(void)
   2261          {
   2262            /*
   2263             * Zigbee HomeAutomation don't need to permit joining
   2264             */
   2265            // zAddrType_t dstAddr;
   2266            // dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR_DEVZCZR;
   2267            // dstAddr.addrMode = AddrBroadcast;
   2268            // // Trust Center significance is always true
   2269            // ZDP_MgmtPermitJoinReq( &dstAddr, BDBC_MIN_COMMISSIONING_TIME, TRUE, FALSE );
   2270          }
   2271          
   2272          
   2273          /*********************************************************************
   2274           * @fn          bdb_startResumeCommissioningProcess
   2275           *
   2276           * @brief       Starts or resume the commissioning operations sets in the
   2277           *              commissioningMode attribute
   2278           *
   2279           * @param       none
   2280           *
   2281           * @return      none
   2282           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2283          void bdb_startResumeCommissioningProcess(void)
   \                     bdb_startResumeCommissioningProcess:
   2284          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 11
   \   000005   74F5         MOV       A,#-0xb
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   2285          
   2286          #if ( defined ( BDB_TL_INITIATOR ) && (BDB_TOUCHLINK_CAPABILITY_ENABLED == TRUE) )
   2287            if(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_INITIATOR_TL)
   2288            {
   2289              uint16 nwkAddr;
   2290          
   2291              //Does the device supports this commissioning mode?
   2292              if(bdbAttributes.bdbNodeCommissioningCapability & BDB_TOUCHLINK_CAPABILITY)
   2293              {
   2294                //Clear previous state and substates
   2295                osal_memset(&bdbCommissioningProcedureState,0,sizeof(bdbCommissioningProcedureState));
   2296                bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_TL;
   2297          
   2298                // Get our short address
   2299                ZMacGetReq( ZMacShortAddress, (byte*)&nwkAddr );
   2300                if ( nwkAddr >= NWK_BROADCAST_SHORTADDR_DEVZCZR )
   2301                {
   2302                  initiatorSelectNwkParams();
   2303                }
   2304          
   2305                touchLinkInitiator_StartDevDisc( );
   2306          
   2307                bdb_NotifyCommissioningModeStart(BDB_COMMISSIONING_TOUCHLINK);
   2308              }
   2309              else
   2310              {
   2311                //Process the next commissioning mode
   2312                bdb_reportCommissioningState( BDB_COMMISSIONING_STATE_TL, FALSE );
   2313              }
   2314              return;
   2315            }
   2316          #endif // BDB_TOUCHLINK_CAPABILITY_ENABLED
   2317          
   2318          #if ZG_BUILD_ENDDEVICE_TYPE
   2319            if(ZG_DEVICE_ENDDEVICE_TYPE)
   2320            {
   2321              if(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_PARENT_LOST)
   \   00000A   90....       MOV       DPTR,#bdbAttributes + 11
   \   00000D   E0           MOVX      A,@DPTR
   \   00000E   A2E5         MOV       C,0xE0 /* A   */.5
   \   000010   5003         JNC       $+5
   \   000012   02....       LJMP      ??bdb_startResumeCommissioningProcess_0 & 0xFFFF
   2322              {
   2323                //No commissioning process can be performed if the ZED has lost its parent
   2324                return;
   2325              }
   2326            }
   2327          #endif
   2328          
   2329            if(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_NWK_STEERING)
   \   000015   A2E1         MOV       C,0xE0 /* A   */.1
   \   000017   5050         JNC       ??bdb_startResumeCommissioningProcess_1
   2330            {
   2331              bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_STEERING_ON_NWK;
   \   000019   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   00001C   7404         MOV       A,#0x4
   \   00001E   F0           MOVX      @DPTR,A
   2332          
   2333              if(bdbAttributes.bdbNodeCommissioningCapability & BDB_NETWORK_STEERING_CAPABILITY)
   \   00001F   90....       MOV       DPTR,#bdbAttributes + 12
   \   000022   E0           MOVX      A,@DPTR
   \   000023   A2E0         MOV       C,0xE0 /* A   */.0
   \   000025   503F         JNC       ??bdb_startResumeCommissioningProcess_2
   2334              {
   2335          #if (BDB_TOUCHLINK_CAPABILITY_ENABLED == TRUE)
   2336                bdb_ClearNetworkParams();
   2337          #endif
   2338                if(bdbAttributes.bdbNodeIsOnANetwork)
   \   000027   90....       MOV       DPTR,#bdbAttributes + 14
   \   00002A   E0           MOVX      A,@DPTR
   \   00002B   6009         JZ        ??bdb_startResumeCommissioningProcess_3
   2339                {
   2340                  bdb_nwkSteeringDeviceOnNwk();
   2341                  bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_STEERING_ON_NWK, TRUE);
   \   00002D                ; Setup parameters for call to function bdb_reportCommissioningState
   \   00002D   7A01         MOV       R2,#0x1
   \   00002F   7904         MOV       R1,#0x4
   \   000031   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   \   000034   8030         SJMP      ??bdb_startResumeCommissioningProcess_2
   2342                }
   2343          #if (ZG_BUILD_JOINING_TYPE)
   2344                else
   2345                {
   2346                  if(ZG_DEVICE_JOINING_TYPE)
   \                     ??bdb_startResumeCommissioningProcess_3:
   \   000036   90....       MOV       DPTR,#zgDeviceLogicalType
   \   000039   E0           MOVX      A,@DPTR
   \   00003A   6401         XRL       A,#0x1
   \   00003C   6005         JZ        ??bdb_startResumeCommissioningProcess_4
   \   00003E   E0           MOVX      A,@DPTR
   \   00003F   6402         XRL       A,#0x2
   \   000041   7023         JNZ       ??bdb_startResumeCommissioningProcess_2
   2347                  {
   2348                    vDoPrimaryScan = TRUE;
   \                     ??bdb_startResumeCommissioningProcess_4:
   \   000043   90....       MOV       DPTR,#vDoPrimaryScan
   \   000046   7401         MOV       A,#0x1
   \   000048   F0           MOVX      @DPTR,A
   2349          
   2350                    //Initialize the commissioning procedure state, bdbJoinState to nwk discovery and TCLinkKeyExchange to not active
   2351                    osal_memset(&bdbCommissioningProcedureState,0,sizeof(bdbCommissioningProcedureState_t));
   \   000049                ; Setup parameters for call to function osal_memset
   \   000049   7C04         MOV       R4,#0x4
   \   00004B   7D00         MOV       R5,#0x0
   \   00004D   7900         MOV       R1,#0x0
   \   00004F   7A..         MOV       R2,#bdbCommissioningProcedureState & 0xff
   \   000051   7B..         MOV       R3,#(bdbCommissioningProcedureState >> 8) & 0xff
   \   000053   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
   2352                    bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_JOINING;
   \   000056   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000059   7403         MOV       A,#0x3
   \   00005B   F0           MOVX      @DPTR,A
   2353                    bdb_nwkJoiningFormation(TRUE);
   \   00005C                ; Setup parameters for call to function bdb_nwkJoiningFormation
   \   00005C   7901         MOV       R1,#0x1
   \   00005E   12....       LCALL     `??bdb_nwkJoiningFormation::?relay`; Banked call to: bdb_nwkJoiningFormation
   2354                    bdb_NotifyCommissioningModeStart(BDB_COMMISSIONING_NWK_STEERING);
   \   000061                ; Setup parameters for call to function bdb_NotifyCommissioningModeStart
   \   000061   7901         MOV       R1,#0x1
   \   000063   12....       LCALL     `??bdb_NotifyCommissioningModeStart::?relay`; Banked call to: bdb_NotifyCommissioningModeStart
   2355                  }
   2356                }
   2357          #endif
   2358          #if (ZG_BUILD_COORDINATOR_TYPE)
   2359                if(ZG_DEVICE_COORDINATOR_TYPE)
   2360                {
   2361                  bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_STEERING_ON_NWK, FALSE);
   2362                }
   2363          #endif
   2364              }
   2365              return;
   \                     ??bdb_startResumeCommissioningProcess_2:
   \   000066   02....       LJMP      ??bdb_startResumeCommissioningProcess_0 & 0xFFFF
   2366            }
   2367          
   2368            if(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_NWK_FORMATION)
   \                     ??bdb_startResumeCommissioningProcess_1:
   \   000069   A2E2         MOV       C,0xE0 /* A   */.2
   \   00006B   500F         JNC       ??bdb_startResumeCommissioningProcess_5
   2369            {
   2370              bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_FORMATION;
   \   00006D   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000070   7405         MOV       A,#0x5
   \   000072   F0           MOVX      @DPTR,A
   2371          
   2372              if(bdbAttributes.bdbNodeCommissioningCapability & BDB_NETWORK_FORMATION_CAPABILITY)
   2373              {
   2374                if(!bdbAttributes.bdbNodeIsOnANetwork)
   2375                {
   2376          #if (BDB_TOUCHLINK_CAPABILITY_ENABLED == TRUE)
   2377                bdb_ClearNetworkParams();
   2378          #endif
   2379                  vDoPrimaryScan = TRUE;
   2380          
   2381                  osal_memset(&bdbCommissioningProcedureState,0,sizeof(bdbCommissioningProcedureState));
   2382                  bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_FORMATION;
   2383          
   2384                  bdb_nwkJoiningFormation(FALSE);
   2385                  bdb_NotifyCommissioningModeStart(BDB_COMMISSIONING_FORMATION);
   2386                  return;
   2387                }
   2388              }
   2389              bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_FORMATION, FALSE);
   \   000073                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000073   7A00         MOV       R2,#0x0
   \   000075   F9           MOV       R1,A
   \   000076   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   2390              return;
   \   000079   02....       LJMP      ??bdb_startResumeCommissioningProcess_0 & 0xFFFF
   2391            }
   2392          
   2393          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
   2394            if(bdbAttributes.bdbCommissioningMode & BDB_COMMISSIONING_MODE_FINDING_BINDING)
   \                     ??bdb_startResumeCommissioningProcess_5:
   \   00007C   A2E3         MOV       C,0xE0 /* A   */.3
   \   00007E   4003         JC        $+5
   \   000080   02....       LJMP      ??bdb_startResumeCommissioningProcess_0 & 0xFFFF
   2395            {
   2396              bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_FINDING_BINDING;
   \   000083   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000086   7406         MOV       A,#0x6
   \   000088   F0           MOVX      @DPTR,A
   2397          
   2398              //Is the device on a network?
   2399              if(bdb_isDeviceNonFactoryNew())
   \   000089   90....       MOV       DPTR,#bdbAttributes + 14
   \   00008C   E0           MOVX      A,@DPTR
   \   00008D   7003         JNZ       $+5
   \   00008F   02....       LJMP      ??bdb_startResumeCommissioningProcess_6 & 0xFFFF
   2400              {
   2401                zclAttrRec_t attrRec;
   2402          
   2403                endPointDesc_t *bdb_CurrEpDescriptor = NULL;
   2404          
   2405                bdb_CurrEpDescriptor = bdb_setEpDescListToActiveEndpoint();
   \   000092                ; Setup parameters for call to function bdb_setEpDescListToActiveEndpoint
   \   000092   12....       LCALL     `??bdb_setEpDescListToActiveEndpoint::?relay`; Banked call to: bdb_setEpDescListToActiveEndpoint
   \   000095   8A..         MOV       ?V0,R2
   \   000097   8B..         MOV       ?V1,R3
   \   000099   AE..         MOV       R6,?V0
   \   00009B   AF..         MOV       R7,?V1
   2406          
   2407                //If not found endpoint with Identify cluster is found, then report fail
   2408                if(bdb_CurrEpDescriptor == NULL)
   \   00009D   EA           MOV       A,R2
   \   00009E   4F           ORL       A,R7
   \   00009F   7003         JNZ       $+5
   \   0000A1   02....       LJMP      ??bdb_startResumeCommissioningProcess_6 & 0xFFFF
   2409                {
   2410                  bdb_exitFindingBindingWStatus(BDB_COMMISSIONING_FAILURE);
   \   0000A4                ; Setup parameters for call to function bdb_exitFindingBindingWStatus
   2411                  return;
   2412                }
   2413          
   2414                if( bdb_CurrEpDescriptorList->epDesc->epType & BDB_FINDING_AND_BINDING_TARGET)  //F&B as Target
   \   0000A4   12....       LCALL     ?Subroutine21 & 0xFFFF
   \                     ??CrossCallReturnLabel_18:
   \   0000A7   F8           MOV       R0,A
   \   0000A8   A3           INC       DPTR
   \   0000A9   12....       LCALL     ??Subroutine51_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_84:
   \   0000AC   A3           INC       DPTR
   \   0000AD   E0           MOVX      A,@DPTR
   \   0000AE   A2E1         MOV       C,0xE0 /* A   */.1
   \   0000B0   4003         JC        $+5
   \   0000B2   02....       LJMP      ??bdb_startResumeCommissioningProcess_7 & 0xFFFF
   2415                {
   2416                  if (zclFindAttrRec( bdb_CurrEpDescriptor->endPoint, ZCL_CLUSTER_ID_GEN_IDENTIFY,
   2417                            ATTRID_IDENTIFY_TIME, &attrRec ) )
   \   0000B5                ; Setup parameters for call to function zclFindAttrRec
   \   0000B5   7403         MOV       A,#0x3
   \   0000B7   12....       LCALL     ?XSTACK_DISP100_8
   \   0000BA   88..         MOV       ?V0,R0
   \   0000BC   89..         MOV       ?V1,R1
   \   0000BE   78..         MOV       R0,#?V0
   \   0000C0   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0000C3   7C00         MOV       R4,#0x0
   \   0000C5   7D00         MOV       R5,#0x0
   \   0000C7   7A03         MOV       R2,#0x3
   \   0000C9   7B00         MOV       R3,#0x0
   \   0000CB   8E82         MOV       DPL,R6
   \   0000CD   8F83         MOV       DPH,R7
   \   0000CF   E0           MOVX      A,@DPTR
   \   0000D0   F9           MOV       R1,A
   \   0000D1   12....       LCALL     `??zclFindAttrRec::?relay`; Banked call to: zclFindAttrRec
   \   0000D4   7402         MOV       A,#0x2
   \   0000D6   12....       LCALL     ?DEALLOC_XSTACK8
   \   0000D9   E9           MOV       A,R1
   \   0000DA   606C         JZ        ??bdb_startResumeCommissioningProcess_8
   2418                  {
   2419                    //Set it to at less 180
   2420                    if ( *((uint16*)attrRec.attr.dataPtr) <= BDBC_MIN_COMMISSIONING_TIME )
   \   0000DC   7409         MOV       A,#0x9
   \   0000DE   12....       LCALL     ?XSTACK_DISP0_8
   \   0000E1   12....       LCALL     ?Subroutine26 & 0xFFFF
   \                     ??CrossCallReturnLabel_26:
   \   0000E4   C3           CLR       C
   \   0000E5   E0           MOVX      A,@DPTR
   \   0000E6   94B5         SUBB      A,#-0x4b
   \   0000E8   A3           INC       DPTR
   \   0000E9   E0           MOVX      A,@DPTR
   \   0000EA   9400         SUBB      A,#0x0
   \   0000EC   5039         JNC       ??bdb_startResumeCommissioningProcess_9
   2421                    {
   2422                      *((uint16*)attrRec.attr.dataPtr) = BDBC_MIN_COMMISSIONING_TIME;
   \   0000EE   8882         MOV       DPL,R0
   \   0000F0   8983         MOV       DPH,R1
   \   0000F2   74B4         MOV       A,#-0x4c
   \   0000F4   F0           MOVX      @DPTR,A
   \   0000F5   A3           INC       DPTR
   \   0000F6   E4           CLR       A
   \   0000F7   F0           MOVX      @DPTR,A
   2423                       osal_start_timerEx( bdb_TaskID, BDB_IDENTIFY_TIMEOUT, 1000 );
   \   0000F8                ; Setup parameters for call to function osal_start_timerEx
   \   0000F8   90....       MOV       DPTR,#__Constant_3e8
   \   0000FB   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   0000FE   7A00         MOV       R2,#0x0
   \   000100   7B20         MOV       R3,#0x20
   \   000102   12....       LCALL     ??Subroutine56_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_133:
   \   000105   12....       LCALL     ?DEALLOC_XSTACK8
   2424          
   2425                      if(pfnIdentifyTimeChangeCB != NULL)
   \   000108   90....       MOV       DPTR,#pfnIdentifyTimeChangeCB
   \   00010B   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_101:
   \   00010E   6017         JZ        ??bdb_startResumeCommissioningProcess_9
   2426                      {
   2427                        if(bdbIndentifyActiveEndpoint == 0xFF)
   \   000110   90....       MOV       DPTR,#bdbIndentifyActiveEndpoint
   \   000113   E0           MOVX      A,@DPTR
   \   000114   F4           CPL       A
   \   000115   7004         JNZ       ??bdb_startResumeCommissioningProcess_10
   2428                        {
   2429                          pfnIdentifyTimeChangeCB(bdbIndentifyActiveEndpoint);
   \   000117                ; Setup parameters for indirect call
   \   000117   79FF         MOV       R1,#-0x1
   \   000119   8006         SJMP      ??bdb_startResumeCommissioningProcess_11
   2430                        }
   2431                        else
   2432                        {
   2433                          pfnIdentifyTimeChangeCB(bdb_CurrEpDescriptor->endPoint);
   \                     ??bdb_startResumeCommissioningProcess_10:
   \   00011B                ; Setup parameters for indirect call
   \   00011B   8E82         MOV       DPL,R6
   \   00011D   8F83         MOV       DPH,R7
   \   00011F   E0           MOVX      A,@DPTR
   \   000120   F9           MOV       R1,A
   2434                        }
   2435                      }
   2436                    }
   \                     ??bdb_startResumeCommissioningProcess_11:
   \   000121   12....       LCALL     ?Subroutine22 & 0xFFFF
   \                     ??CrossCallReturnLabel_87:
   \   000124   12....       LCALL     ?CALL_IND
   2437                    //Attribute found and set, report success
   2438                    if(!(bdb_CurrEpDescriptorList->epDesc->epType & BDB_FINDING_AND_BINDING_INITIATOR))
   \                     ??bdb_startResumeCommissioningProcess_9:
   \   000127   12....       LCALL     ?Subroutine16 & 0xFFFF
   \                     ??CrossCallReturnLabel_12:
   \   00012A   4004         JC        ??bdb_startResumeCommissioningProcess_12
   2439                    {
   2440                      bdb_exitFindingBindingWStatus(BDB_COMMISSIONING_FB_TARGET_IN_PROGRESS);
   \   00012C                ; Setup parameters for call to function bdb_exitFindingBindingWStatus
   \   00012C   7909         MOV       R1,#0x9
   \   00012E   801F         SJMP      ??bdb_startResumeCommissioningProcess_13
   2441                    }
   2442                    else
   2443                    {
   2444                      bdbCommissioningModeMsg_t bdbCommissioningModeMsg;
   2445          
   2446                      bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_FINDING_BINDING;
   \                     ??bdb_startResumeCommissioningProcess_12:
   \   000130   7401         MOV       A,#0x1
   \   000132   12....       LCALL     ?XSTACK_DISP0_8
   \   000135   12....       LCALL     ?Subroutine10 & 0xFFFF
   2447                      bdbCommissioningModeMsg.bdbCommissioningStatus = BDB_COMMISSIONING_FB_TARGET_IN_PROGRESS;
   2448          
   2449                      bdb_NotifyApp((uint8*)&bdbCommissioningModeMsg);
   2450                    }
   2451                  }
   \                     ??CrossCallReturnLabel_113:
   \   000138   7409         MOV       A,#0x9
   \   00013A   12....       LCALL     ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_2:
   \   00013D   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000140   12....       LCALL     ?Subroutine15 & 0xFFFF
   \                     ??CrossCallReturnLabel_76:
   \   000143   12....       LCALL     ?DEALLOC_XSTACK8
   \   000146   800A         SJMP      ??bdb_startResumeCommissioningProcess_7
   2452                  else
   2453                  {
   2454                    //Attribute not found and no initiator process, report fail
   2455                    if(!(bdb_CurrEpDescriptorList->epDesc->epType & BDB_FINDING_AND_BINDING_INITIATOR))
   \                     ??bdb_startResumeCommissioningProcess_8:
   \   000148   12....       LCALL     ?Subroutine16 & 0xFFFF
   \                     ??CrossCallReturnLabel_13:
   \   00014B   4005         JC        ??bdb_startResumeCommissioningProcess_7
   2456                    {
   2457                      bdb_exitFindingBindingWStatus(BDB_COMMISSIONING_FAILURE);
   \   00014D                ; Setup parameters for call to function bdb_exitFindingBindingWStatus
   \   00014D   790E         MOV       R1,#0xe
   \                     ??bdb_startResumeCommissioningProcess_13:
   \   00014F   12....       LCALL     `??bdb_exitFindingBindingWStatus::?relay`; Banked call to: bdb_exitFindingBindingWStatus
   2458                    }
   2459                  }
   2460                }  //F&B Target
   2461          
   2462                if( bdb_CurrEpDescriptorList->epDesc->epType & BDB_FINDING_AND_BINDING_INITIATOR)  //F&B as Initiator
   \                     ??bdb_startResumeCommissioningProcess_7:
   \   000152   12....       LCALL     ?Subroutine21 & 0xFFFF
   \                     ??CrossCallReturnLabel_19:
   \   000155   2401         ADD       A,#0x1
   \   000157   F8           MOV       R0,A
   \   000158   A3           INC       DPTR
   \   000159   E0           MOVX      A,@DPTR
   \   00015A   3400         ADDC      A,#0x0
   \   00015C   F9           MOV       R1,A
   \   00015D   8882         MOV       DPL,R0
   \   00015F   F583         MOV       DPH,A
   \   000161   E0           MOVX      A,@DPTR
   \   000162   A2E0         MOV       C,0xE0 /* A   */.0
   \   000164   5053         JNC       ??bdb_startResumeCommissioningProcess_0
   2463                {
   2464                  bdbCommissioningModeMsg_t bdbCommissioningModeMsg;
   2465          
   2466                  //If no function to add binds is available then do not process Initiator
   2467                  if(!pbindAddEntry)
   \   000166   90....       MOV       DPTR,#pbindAddEntry
   \   000169   12....       LCALL     ??Subroutine54_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_117:
   \   00016C   7010         JNZ       ??bdb_startResumeCommissioningProcess_14
   2468                  {
   2469                    //If no target process, then report fail
   2470                    if(!(bdb_CurrEpDescriptorList->epDesc->epType & BDB_FINDING_AND_BINDING_TARGET))
   \   00016E   8882         MOV       DPL,R0
   \   000170   8983         MOV       DPH,R1
   \   000172   E0           MOVX      A,@DPTR
   \   000173   A2E1         MOV       C,0xE0 /* A   */.1
   \   000175   4042         JC        ??bdb_startResumeCommissioningProcess_0
   2471                    {
   2472                      bdb_exitFindingBindingWStatus(BDB_COMMISSIONING_FAILURE);
   2473                    }
   2474                  }
   2475                  else
   2476                  {
   2477                    //Send identify query with the endpoint requested
   2478                    if(bdb_SendIdentifyQuery(bdb_CurrEpDescriptor->endPoint) != ZSuccess)
   2479                    {
   2480                      bdb_exitFindingBindingWStatus(BDB_COMMISSIONING_FAILURE);
   2481                    }
   2482          
   2483                    //If periodic F&B is enabled
   2484                    if ( FINDING_AND_BINDING_PERIODIC_ENABLE == TRUE )
   2485                    {
   2486                      // total F&B time will be at least BDBC_MIN_COMMISSIONING_TIME, and at most (BDBC_MIN_COMMISSIONING_TIME + FINDING_AND_BINDING_PERIODIC_TIME - 1)
   2487                      bdb_FB_InitiatorCurrentCyclesNumber = (BDBC_MIN_COMMISSIONING_TIME + (FINDING_AND_BINDING_PERIODIC_TIME - 1)) / FINDING_AND_BINDING_PERIODIC_TIME;
   2488          
   2489                      osal_start_timerEx(bdb_TaskID, BDB_FINDING_AND_BINDING_PERIOD_TIMEOUT, FINDING_AND_BINDING_PERIODIC_TIME * 1000);
   2490                    }
   2491          
   2492                    bdbCommissioningModeMsg.bdbCommissioningMode = BDB_COMMISSIONING_FINDING_BINDING;
   2493                    bdbCommissioningModeMsg.bdbCommissioningStatus = BDB_COMMISSIONING_FB_INITITATOR_IN_PROGRESS;
   2494          
   2495                    bdb_NotifyApp((uint8*)&bdbCommissioningModeMsg);
   2496                  }
   2497                } //F&B Initiator
   2498              }
   2499              //Not in the network
   2500              else
   2501              {
   2502                bdb_exitFindingBindingWStatus(BDB_COMMISSIONING_FAILURE);
   \                     ??bdb_startResumeCommissioningProcess_6:
   \   000177                ; Setup parameters for call to function bdb_exitFindingBindingWStatus
   \   000177   790E         MOV       R1,#0xe
   \   000179   12....       LCALL     `??bdb_exitFindingBindingWStatus::?relay`; Banked call to: bdb_exitFindingBindingWStatus
   2503              }
   2504          
   2505              return;
   \   00017C   803B         SJMP      ??bdb_startResumeCommissioningProcess_0
   \                     ??bdb_startResumeCommissioningProcess_14:
   \   00017E                ; Setup parameters for call to function bdb_SendIdentifyQuery
   \   00017E   8E82         MOV       DPL,R6
   \   000180   8F83         MOV       DPH,R7
   \   000182   E0           MOVX      A,@DPTR
   \   000183   F9           MOV       R1,A
   \   000184   12....       LCALL     `??bdb_SendIdentifyQuery::?relay`; Banked call to: bdb_SendIdentifyQuery
   \   000187   E9           MOV       A,R1
   \   000188   6005         JZ        ??bdb_startResumeCommissioningProcess_15
   \   00018A                ; Setup parameters for call to function bdb_exitFindingBindingWStatus
   \   00018A   790E         MOV       R1,#0xe
   \   00018C   12....       LCALL     `??bdb_exitFindingBindingWStatus::?relay`; Banked call to: bdb_exitFindingBindingWStatus
   \                     ??bdb_startResumeCommissioningProcess_15:
   \   00018F   90....       MOV       DPTR,#bdb_FB_InitiatorCurrentCyclesNumber
   \   000192   740C         MOV       A,#0xc
   \   000194   F0           MOVX      @DPTR,A
   \   000195                ; Setup parameters for call to function osal_start_timerEx
   \   000195   90....       MOV       DPTR,#__Constant_3a98
   \   000198   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   00019B   7A40         MOV       R2,#0x40
   \   00019D   12....       LCALL     ??Subroutine55_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_129:
   \   0001A0   12....       LCALL     ?DEALLOC_XSTACK8
   \   0001A3   7401         MOV       A,#0x1
   \   0001A5   12....       LCALL     ?XSTACK_DISP0_8
   \   0001A8   12....       LCALL     ?Subroutine10 & 0xFFFF
   2506            }
   \                     ??CrossCallReturnLabel_114:
   \   0001AB   740A         MOV       A,#0xa
   \   0001AD   12....       LCALL     ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_3:
   \   0001B0   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   0001B3   12....       LCALL     ?Subroutine15 & 0xFFFF
   \                     ??CrossCallReturnLabel_77:
   \   0001B6   12....       LCALL     ?DEALLOC_XSTACK8
   2507          #endif
   2508          
   2509          }
   \                     ??bdb_startResumeCommissioningProcess_0:
   \   0001B9   740B         MOV       A,#0xb
   \   0001BB   02....       LJMP      ??Subroutine59_0 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine22:
   \   000000   90....       MOV       DPTR,#pfnIdentifyTimeChangeCB + 1
   \   000003                REQUIRE ??Subroutine51_0
   \   000003                ; // Fall through to label ??Subroutine51_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine21:
   \   000000   12....       LCALL     ?Subroutine35 & 0xFFFF
   \                     ??CrossCallReturnLabel_46:
   \   000003   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine35:
   \   000000   90....       MOV       DPTR,#bdb_CurrEpDescriptorList
   \   000003   E0           MOVX      A,@DPTR
   \   000004   F8           MOV       R0,A
   \   000005   A3           INC       DPTR
   \   000006   E0           MOVX      A,@DPTR
   \   000007   F583         MOV       DPH,A
   \   000009   8882         MOV       DPL,R0
   \   00000B   A3           INC       DPTR
   \   00000C   A3           INC       DPTR
   \   00000D   E0           MOVX      A,@DPTR
   \   00000E   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine16:
   \   000000   12....       LCALL     ?Subroutine35 & 0xFFFF
   \                     ??CrossCallReturnLabel_45:
   \   000003   F8           MOV       R0,A
   \   000004   A3           INC       DPTR
   \   000005   E0           MOVX      A,@DPTR
   \   000006   F583         MOV       DPH,A
   \   000008   8882         MOV       DPL,R0
   \   00000A   A3           INC       DPTR
   \   00000B   E0           MOVX      A,@DPTR
   \   00000C   A2E0         MOV       C,0xE0 /* A   */.0
   \   00000E   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine10:
   \   000000   7403         MOV       A,#0x3
   \   000002                REQUIRE ??Subroutine53_0
   \   000002                ; // Fall through to label ??Subroutine53_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine54_0:
   \   000000   12....       LCALL     ??Subroutine46_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_152:
   \   000003   EA           MOV       A,R2
   \   000004   4B           ORL       A,R3
   \   000005   22           RET
   2510          
   2511          /*********************************************************************
   2512           * @fn          bdb_event_loop
   2513           *
   2514           * @brief       Main event loop bdb tasks.
   2515           *
   2516           * @param       task_id - task id
   2517           * @param       events - event bitmap
   2518           *
   2519           * @return      unprocessed events
   2520           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2521          UINT16 bdb_event_loop(byte task_id, UINT16 events)
   \                     bdb_event_loop:
   2522          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V6
   \   000000                REQUIRE ?V7
   \   000000   74F0         MOV       A,#-0x10
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 13
   \   000005   74F3         MOV       A,#-0xd
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   EA           MOV       A,R2
   \   00000B   FE           MOV       R6,A
   \   00000C   EB           MOV       A,R3
   \   00000D   FF           MOV       R7,A
   2523            (void)task_id;  // Intentionally unreferenced parameter
   2524          
   2525          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
   2526            endPointDesc_t * bdb_CurrEpDescriptor;
   2527          #endif
   2528          
   2529            if(events & BDB_CHANGE_COMMISSIONING_STATE)
   \   00000E   EA           MOV       A,R2
   \   00000F   5404         ANL       A,#0x4
   \   000011   6044         JZ        ??bdb_event_loop_0
   2530            {
   2531              switch(bdbCommissioningProcedureState.bdbCommissioningState)
   \   000013   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000016   E0           MOVX      A,@DPTR
   \   000017   600D         JZ        ??bdb_event_loop_1
   \   000019   14           DEC       A
   \   00001A   600F         JZ        ??bdb_event_loop_2
   \   00001C   24FD         ADD       A,#-0x3
   \   00001E   6014         JZ        ??bdb_event_loop_3
   \   000020   24FE         ADD       A,#-0x2
   \   000022   6019         JZ        ??bdb_event_loop_4
   \   000024   802B         SJMP      ??bdb_event_loop_5
   2532              {
   2533                case BDB_COMMISSIONING_STATE_START_RESUME:
   2534                  bdb_startResumeCommissioningProcess();
   \                     ??bdb_event_loop_1:
   \   000026                ; Setup parameters for call to function bdb_startResumeCommissioningProcess
   \   000026   12....       LCALL     `??bdb_startResumeCommissioningProcess::?relay`; Banked call to: bdb_startResumeCommissioningProcess
   2535                break;
   \   000029   8026         SJMP      ??bdb_event_loop_5
   2536          
   2537                case BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE:
   2538                  if (ZG_BUILD_JOINING_TYPE)
   2539                  {
   2540                    bdb_tcLinkKeyExchangeAttempt(TRUE,BDB_REQ_TC_STACK_VERSION);
   \                     ??bdb_event_loop_2:
   \   00002B                ; Setup parameters for call to function bdb_tcLinkKeyExchangeAttempt
   \   00002B   7A01         MOV       R2,#0x1
   \   00002D   7901         MOV       R1,#0x1
   \   00002F   12....       LCALL     `??bdb_tcLinkKeyExchangeAttempt::?relay`; Banked call to: bdb_tcLinkKeyExchangeAttempt
   2541                  }
   2542                break;
   \   000032   801D         SJMP      ??bdb_event_loop_5
   2543          
   2544                case BDB_COMMISSIONING_STATE_STEERING_ON_NWK:
   2545                  bdb_nwkSteeringDeviceOnNwk();
   2546          
   2547                  bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_STEERING_ON_NWK, TRUE);
   \                     ??bdb_event_loop_3:
   \   000034                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000034   7A01         MOV       R2,#0x1
   \   000036   7904         MOV       R1,#0x4
   \   000038   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   2548                break;
   \   00003B   8014         SJMP      ??bdb_event_loop_5
   2549          
   2550                case BDB_COMMISSIONING_STATE_FINDING_BINDING:
   2551                  bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_SUCCESS;
   \                     ??bdb_event_loop_4:
   \   00003D   90....       MOV       DPTR,#bdbAttributes + 10
   \   000040   E4           CLR       A
   \   000041   F0           MOVX      @DPTR,A
   2552                  bdbCommissioningProcedureState.bdbCommissioningState = BDB_COMMISSIONING_STATE_START_RESUME;
   \   000042   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000045   12....       LCALL     ??Subroutine58_0 & 0xFFFF
   2553                  osal_start_timerEx(bdb_TaskID,BDB_CHANGE_COMMISSIONING_STATE,50);
   \                     ??CrossCallReturnLabel_141:
   \   000048   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   00004B   12....       LCALL     ?Subroutine14 & 0xFFFF
   \                     ??CrossCallReturnLabel_127:
   \   00004E   12....       LCALL     ?DEALLOC_XSTACK8
   2554                break;
   2555          
   2556              }
   2557              return (events ^ BDB_CHANGE_COMMISSIONING_STATE);
   \                     ??bdb_event_loop_5:
   \   000051   EE           MOV       A,R6
   \   000052   6404         XRL       A,#0x4
   \   000054   02....       LJMP      ??bdb_event_loop_6 & 0xFFFF
   2558            }
   2559          
   2560            if ( events & SYS_EVENT_MSG )
   \                     ??bdb_event_loop_0:
   \   000057   EB           MOV       A,R3
   \   000058   5480         ANL       A,#0x80
   \   00005A   706E         JNZ       ??bdb_event_loop_7
   2561            {
   2562              uint8 *msg_ptr;
   2563          
   2564              while ( (msg_ptr = osal_msg_receive( bdb_TaskID )) )
   2565              {
   2566                //Process the Incomming ZDO messages used by BDB commissioning methods
   2567                if(((bdbInMsg_t*)msg_ptr)->hdr.event == BDB_ZDO_CB_MSG)
   2568                {
   2569                  bdb_processZDOMgs((zdoIncomingMsg_t *)msg_ptr);
   2570                }
   2571          
   2572                //Validate the is receive on the right process
   2573                else if(((bdbInMsg_t*)msg_ptr)->hdr.event == bdbCommissioningProcedureState.bdbCommissioningState)
   2574                {
   2575                  bdb_ProcessOSALMsg( (bdbInMsg_t *)msg_ptr );
   2576                }
   2577                //Notify the user
   2578                else if(((bdbInMsg_t*)msg_ptr)->hdr.event == BDB_NOTIFY_USER)
   2579                {
   2580                  ((bdbCommissioningModeMsg_t*) ((bdbInMsg_t*)msg_ptr)->buf)->bdbRemainingCommissioningModes = bdbAttributes.bdbCommissioningMode;
   2581                  if(pfnCommissioningStatusCB)
   2582                  {
   2583                    pfnCommissioningStatusCB((bdbCommissioningModeMsg_t*) (((bdbInMsg_t*)msg_ptr)->buf));
   2584                  }
   2585          #ifdef MT_APP_CNF_FUNC
   2586                  //Notify the host processor about the event
   2587                  MT_AppCnfCommissioningNotification((bdbCommissioningModeMsg_t*) (((bdbInMsg_t*)msg_ptr)->buf));
   2588          #endif
   2589                }
   2590          #if (ZG_BUILD_COORDINATOR_TYPE)
   2591                else
   2592                {
   2593                  if(ZG_DEVICE_COORDINATOR_TYPE)
   2594                  {
   2595                    //Notify the status
   2596                    if(((bdbInMsg_t*)msg_ptr)->hdr.event == BDB_TC_LINK_KEY_EXCHANGE_PROCESS)
   2597                    {
   2598                      pfnTCLinkKeyExchangeProcessCB( (bdb_TCLinkKeyExchProcess_t*) ((bdbInMsg_t*)msg_ptr)->buf);
   2599                    }
   2600                  }
   2601                }
   2602          #endif
   2603                // Release the memory
   2604                osal_msg_deallocate( msg_ptr );
   2605              }
   2606          
   2607              // Return unprocessed events
   2608              return (events ^ SYS_EVENT_MSG);
   2609            }
   2610          
   2611          
   2612            if(events & BDB_PROCESS_TIMEOUT)
   \   00005C   EB           MOV       A,R3
   \   00005D   5410         ANL       A,#0x10
   \   00005F   7003         JNZ       $+5
   \   000061   02....       LJMP      ??bdb_event_loop_8 & 0xFFFF
   2613            {
   2614              bdb_processTimeout();
   \   000064   90....       MOV       DPTR,#zgDeviceLogicalType
   \   000067   E0           MOVX      A,@DPTR
   \   000068   6401         XRL       A,#0x1
   \   00006A   6008         JZ        ??bdb_event_loop_9
   \   00006C   E0           MOVX      A,@DPTR
   \   00006D   6402         XRL       A,#0x2
   \   00006F   6003         JZ        $+5
   \   000071   02....       LJMP      ??bdb_event_loop_10 & 0xFFFF
   \                     ??bdb_event_loop_9:
   \   000074   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000077   E0           MOVX      A,@DPTR
   \   000078   14           DEC       A
   \   000079   7003         JNZ       $+5
   \   00007B   02....       LJMP      ??bdb_event_loop_11 & 0xFFFF
   \   00007E   24FE         ADD       A,#-0x2
   \   000080   6003         JZ        $+5
   \   000082   02....       LJMP      ??bdb_event_loop_10 & 0xFFFF
   \   000085   90....       MOV       DPTR,#bdbCommissioningProcedureState + 2
   \   000088   E0           MOVX      A,@DPTR
   \   000089   6402         XRL       A,#0x2
   \   00008B   6003         JZ        $+5
   \   00008D   02....       LJMP      ??bdb_event_loop_10 & 0xFFFF
   \   000090   7401         MOV       A,#0x1
   \   000092   F0           MOVX      @DPTR,A
   \   000093                ; Setup parameters for call to function bdb_nwkAssocAttemt
   \   000093   7900         MOV       R1,#0x0
   \   000095   12....       LCALL     `??bdb_nwkAssocAttemt::?relay`; Banked call to: bdb_nwkAssocAttemt
   \   000098   02....       LJMP      ??bdb_event_loop_10 & 0xFFFF
   \                     ??bdb_event_loop_12:
   \   00009B   740A         MOV       A,#0xa
   \   00009D   68           XRL       A,R0
   \   00009E   7023         JNZ       ??bdb_event_loop_13
   \   0000A0   90....       MOV       DPTR,#bdbAttributes + 11
   \   0000A3   E0           MOVX      A,@DPTR
   \   0000A4   8A82         MOV       DPL,R2
   \   0000A6   8B83         MOV       DPH,R3
   \   0000A8   A3           INC       DPTR
   \   0000A9   A3           INC       DPTR
   \   0000AA   A3           INC       DPTR
   \   0000AB   A3           INC       DPTR
   \   0000AC   F0           MOVX      @DPTR,A
   \   0000AD   90....       MOV       DPTR,#pfnCommissioningStatusCB
   \   0000B0   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_102:
   \   0000B3   600E         JZ        ??bdb_event_loop_13
   \   0000B5                ; Setup parameters for indirect call
   \   0000B5   EA           MOV       A,R2
   \   0000B6   2402         ADD       A,#0x2
   \   0000B8   FA           MOV       R2,A
   \   0000B9   E4           CLR       A
   \   0000BA   35..         ADDC      A,?V1
   \   0000BC   FB           MOV       R3,A
   \   0000BD   12....       LCALL     ??Subroutine51_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_85:
   \   0000C0   12....       LCALL     ?CALL_IND
   \                     ??bdb_event_loop_13:
   \   0000C3                ; Setup parameters for call to function osal_msg_deallocate
   \   0000C3   AA..         MOV       R2,?V0
   \   0000C5   AB..         MOV       R3,?V1
   \   0000C7   12....       LCALL     `??osal_msg_deallocate::?relay`; Banked call to: osal_msg_deallocate
   \                     ??bdb_event_loop_7:
   \   0000CA                ; Setup parameters for call to function osal_msg_receive
   \   0000CA   90....       MOV       DPTR,#bdb_TaskID
   \   0000CD   E0           MOVX      A,@DPTR
   \   0000CE   F9           MOV       R1,A
   \   0000CF   12....       LCALL     `??osal_msg_receive::?relay`; Banked call to: osal_msg_receive
   \   0000D2   8A..         MOV       ?V0,R2
   \   0000D4   8B..         MOV       ?V1,R3
   \   0000D6   EA           MOV       A,R2
   \   0000D7   4B           ORL       A,R3
   \   0000D8   604C         JZ        ??bdb_event_loop_14
   \   0000DA   8A82         MOV       DPL,R2
   \   0000DC   8B83         MOV       DPH,R3
   \   0000DE   E0           MOVX      A,@DPTR
   \   0000DF   F8           MOV       R0,A
   \   0000E0   74D3         MOV       A,#-0x2d
   \   0000E2   68           XRL       A,R0
   \   0000E3   7032         JNZ       ??bdb_event_loop_15
   \   0000E5   EA           MOV       A,R2
   \   0000E6   240C         ADD       A,#0xc
   \   0000E8   F582         MOV       DPL,A
   \   0000EA   E4           CLR       A
   \   0000EB   35..         ADDC      A,?V1
   \   0000ED   F583         MOV       DPH,A
   \   0000EF   E0           MOVX      A,@DPTR
   \   0000F0   F5..         MOV       ?V2,A
   \   0000F2   A3           INC       DPTR
   \   0000F3   E0           MOVX      A,@DPTR
   \   0000F4   F5..         MOV       ?V3,A
   \   0000F6   78..         MOV       R0,#?V2
   \   0000F8   12....       LCALL     ?US_SWITCH_DENSE
   \                     `?<Jumptable for bdb_event_loop>_0`:
   \   0000FB   0180         DW        32769
   \   0000FD   03           DB        3
   \   0000FE   ....         DW        ??bdb_event_loop_13
   \   000100   ....         DW        ??bdb_event_loop_16
   \   000102   ....         DW        ??bdb_event_loop_17
   \   000104   ....         DW        ??bdb_event_loop_13
   \   000106   ....         DW        ??bdb_event_loop_18
   \                     ??bdb_event_loop_17:
   \   000108                ; Setup parameters for call to function bdb_ProcessNodeDescRsp
   \   000108   12....       LCALL     `??bdb_ProcessNodeDescRsp::?relay`; Banked call to: bdb_ProcessNodeDescRsp
   \   00010B   80B6         SJMP      ??bdb_event_loop_13
   \                     ??bdb_event_loop_18:
   \   00010D                ; Setup parameters for call to function bdb_ProcessSimpleDesc
   \   00010D   12....       LCALL     `??bdb_ProcessSimpleDesc::?relay`; Banked call to: bdb_ProcessSimpleDesc
   \   000110   80B1         SJMP      ??bdb_event_loop_13
   \                     ??bdb_event_loop_16:
   \   000112                ; Setup parameters for call to function bdb_ProcessIEEEAddrRsp
   \   000112   12....       LCALL     `??bdb_ProcessIEEEAddrRsp::?relay`; Banked call to: bdb_ProcessIEEEAddrRsp
   \   000115   80AC         SJMP      ??bdb_event_loop_13
   \                     ??bdb_event_loop_15:
   \   000117   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   00011A   E0           MOVX      A,@DPTR
   \   00011B   68           XRL       A,R0
   \   00011C   6003         JZ        $+5
   \   00011E   02....       LJMP      ??bdb_event_loop_12 & 0xFFFF
   \   000121                ; Setup parameters for call to function bdb_ProcessOSALMsg
   \   000121   12....       LCALL     `??bdb_ProcessOSALMsg::?relay`; Banked call to: bdb_ProcessOSALMsg
   \   000124   809D         SJMP      ??bdb_event_loop_13
   \                     ??bdb_event_loop_14:
   \   000126   EE           MOV       A,R6
   \   000127   FA           MOV       R2,A
   \   000128   EF           MOV       A,R7
   \   000129   6480         XRL       A,#0x80
   \   00012B   02....       LJMP      ??bdb_event_loop_19 & 0xFFFF
   \                     ??bdb_event_loop_11:
   \   00012E                ; Setup parameters for call to function bdb_tcLinkKeyExchangeAttempt
   \   00012E   A3           INC       DPTR
   \   00012F   E0           MOVX      A,@DPTR
   \   000130   FA           MOV       R2,A
   \   000131   7900         MOV       R1,#0x0
   \   000133   12....       LCALL     `??bdb_tcLinkKeyExchangeAttempt::?relay`; Banked call to: bdb_tcLinkKeyExchangeAttempt
   2615              // Return unprocessed events
   2616              return (events ^ BDB_PROCESS_TIMEOUT);
   \                     ??bdb_event_loop_10:
   \   000136   EE           MOV       A,R6
   \   000137   FA           MOV       R2,A
   \   000138   EF           MOV       A,R7
   \   000139   6410         XRL       A,#0x10
   \   00013B   02....       LJMP      ??bdb_event_loop_19 & 0xFFFF
   2617            }
   2618          
   2619            if(events &  BDB_REPORT_TIMEOUT){
   \                     ??bdb_event_loop_8:
   \   00013E   EA           MOV       A,R2
   \   00013F   5480         ANL       A,#0x80
   \   000141   6009         JZ        ??bdb_event_loop_20
   2620          #ifdef BDB_REPORTING
   2621              bdb_RepProcessEvent();
   \   000143                ; Setup parameters for call to function bdb_RepProcessEvent
   \   000143   12....       LCALL     `??bdb_RepProcessEvent::?relay`; Banked call to: bdb_RepProcessEvent
   2622          #endif
   2623              // Return unprocessed events
   2624              return (events ^ BDB_REPORT_TIMEOUT);
   \   000146   EE           MOV       A,R6
   \   000147   6480         XRL       A,#0x80
   \   000149   02....       LJMP      ??bdb_event_loop_6 & 0xFFFF
   2625            }
   2626          
   2627          #if (ZG_BUILD_JOINING_TYPE)
   2628            if(events & BDB_TC_LINK_KEY_EXCHANGE_FAIL)
   \                     ??bdb_event_loop_20:
   \   00014C   EA           MOV       A,R2
   \   00014D   5402         ANL       A,#0x2
   \   00014F   603A         JZ        ??bdb_event_loop_21
   2629            {
   2630              if(ZG_DEVICE_JOINING_TYPE)
   \   000151   90....       MOV       DPTR,#zgDeviceLogicalType
   \   000154   E0           MOVX      A,@DPTR
   \   000155   6401         XRL       A,#0x1
   \   000157   6005         JZ        ??bdb_event_loop_22
   \   000159   E0           MOVX      A,@DPTR
   \   00015A   6402         XRL       A,#0x2
   \   00015C   7028         JNZ       ??bdb_event_loop_23
   2631              {
   2632                NLME_LeaveReq_t leaveReq;
   2633                // Set every field to 0
   2634                osal_memset( &leaveReq, 0, sizeof( NLME_LeaveReq_t ) );
   \                     ??bdb_event_loop_22:
   \   00015E                ; Setup parameters for call to function osal_memset
   \   00015E   7C05         MOV       R4,#0x5
   \   000160   7D00         MOV       R5,#0x0
   \   000162   7900         MOV       R1,#0x0
   \   000164   AA..         MOV       R2,?XSP + 0
   \   000166   AB..         MOV       R3,?XSP + 1
   \   000168   12....       LCALL     `??osal_memset::?relay`; Banked call to: osal_memset
   2635          
   2636                bdb_setNodeIsOnANetwork(FALSE);
   \   00016B                ; Setup parameters for call to function bdb_setNodeIsOnANetwork
   \   00016B   7900         MOV       R1,#0x0
   \   00016D   12....       LCALL     `??bdb_setNodeIsOnANetwork::?relay`; Banked call to: bdb_setNodeIsOnANetwork
   2637          
   2638                if ( NLME_LeaveReq( &leaveReq ) != ZSuccess )
   \   000170                ; Setup parameters for call to function NLME_LeaveReq
   \   000170   AA..         MOV       R2,?XSP + 0
   \   000172   AB..         MOV       R3,?XSP + 1
   \   000174   12....       LCALL     `??NLME_LeaveReq::?relay`; Banked call to: NLME_LeaveReq
   \   000177   E9           MOV       A,R1
   \   000178   600C         JZ        ??bdb_event_loop_23
   2639                {
   2640                  osal_set_event( bdb_TaskID,BDB_TC_LINK_KEY_EXCHANGE_FAIL);
   \   00017A                ; Setup parameters for call to function osal_set_event
   \   00017A   7A02         MOV       R2,#0x2
   \   00017C   7B00         MOV       R3,#0x0
   \   00017E   90....       MOV       DPTR,#bdb_TaskID
   \   000181   E0           MOVX      A,@DPTR
   \   000182   F9           MOV       R1,A
   \   000183   12....       LCALL     `??osal_set_event::?relay`; Banked call to: osal_set_event
   2641                }
   2642              }
   2643              // Return unprocessed events
   2644              return (events ^ BDB_TC_LINK_KEY_EXCHANGE_FAIL);
   \                     ??bdb_event_loop_23:
   \   000186   EE           MOV       A,R6
   \   000187   6402         XRL       A,#0x2
   \   000189   8054         SJMP      ??bdb_event_loop_6
   2645            }
   2646          #endif
   2647          
   2648            if(events & BDB_TC_JOIN_TIMEOUT)
   \                     ??bdb_event_loop_21:
   \   00018B   EB           MOV       A,R3
   \   00018C   5408         ANL       A,#0x8
   \   00018E   6006         JZ        ??bdb_event_loop_24
   2649            {
   2650          #if (ZG_BUILD_COORDINATOR_TYPE)
   2651              if(ZG_DEVICE_COORDINATOR_TYPE)
   2652              {
   2653                bdb_TCProcessJoiningList();
   2654              }
   2655          #endif
   2656              return (events ^ BDB_TC_JOIN_TIMEOUT);
   \   000190   EB           MOV       A,R3
   \   000191   6408         XRL       A,#0x8
   \   000193   02....       LJMP      ??bdb_event_loop_19 & 0xFFFF
   2657            }
   2658          
   2659          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
   2660          
   2661            if(events & BDB_FINDING_AND_BINDING_PERIOD_TIMEOUT)
   \                     ??bdb_event_loop_24:
   \   000196   EA           MOV       A,R2
   \   000197   5440         ANL       A,#0x40
   \   000199   6049         JZ        ??bdb_event_loop_25
   2662            {
   2663              if ( FINDING_AND_BINDING_PERIODIC_ENABLE == TRUE )
   2664              {
   2665                bdb_CurrEpDescriptor = bdb_setEpDescListToActiveEndpoint();
   \   00019B                ; Setup parameters for call to function bdb_setEpDescListToActiveEndpoint
   \   00019B   12....       LCALL     `??bdb_setEpDescListToActiveEndpoint::?relay`; Banked call to: bdb_setEpDescListToActiveEndpoint
   \   00019E   8A..         MOV       ?V0,R2
   \   0001A0   8B..         MOV       ?V1,R3
   2666          
   2667                //If we have endpoint from which to send the identify command, then proceed, otherwise finish
   2668                if(bdb_CurrEpDescriptor != NULL) //just a safty check. The fact that we got to this functuon at all means that this cannot be NULL
   \   0001A2   EA           MOV       A,R2
   \   0001A3   4B           ORL       A,R3
   \   0001A4   602B         JZ        ??bdb_event_loop_26
   2669                {
   2670                  //Substract an attempt
   2671                  bdb_FB_InitiatorCurrentCyclesNumber--;
   2672          
   2673                  if(bdb_FB_InitiatorCurrentCyclesNumber > 0)
   \   0001A6   90....       MOV       DPTR,#bdb_FB_InitiatorCurrentCyclesNumber
   \   0001A9   E0           MOVX      A,@DPTR
   \   0001AA   14           DEC       A
   \   0001AB   F0           MOVX      @DPTR,A
   \   0001AC   6029         JZ        ??bdb_event_loop_27
   2674                  {
   2675                    //Only send Identify Query if there is no pending responses from a previous identify query
   2676                    if ((osal_get_timeoutEx(bdb_TaskID, BDB_RESPONDENT_PROCESS_TIMEOUT) == 0) && (bdb_getRespondentRetry(pRespondentHead) == NULL))
   \   0001AE                ; Setup parameters for call to function osal_get_timeoutEx
   \   0001AE   12....       LCALL     ?Subroutine19 & 0xFFFF
   \                     ??CrossCallReturnLabel_58:
   \   0001B1   7010         JNZ       ??bdb_event_loop_28
   \   0001B3                ; Setup parameters for call to function bdb_getRespondentRetry
   \   0001B3   12....       LCALL     ?Subroutine24 & 0xFFFF
   \                     ??CrossCallReturnLabel_24:
   \   0001B6   700B         JNZ       ??bdb_event_loop_28
   2677                    {
   2678                      //Send identify query with the endpoint requested
   2679                      bdb_SendIdentifyQuery(bdb_CurrEpDescriptor->endPoint);
   \   0001B8                ; Setup parameters for call to function bdb_SendIdentifyQuery
   \   0001B8   85..82       MOV       DPL,?V0
   \   0001BB   85..83       MOV       DPH,?V1
   \   0001BE   E0           MOVX      A,@DPTR
   \   0001BF   F9           MOV       R1,A
   \   0001C0   12....       LCALL     `??bdb_SendIdentifyQuery::?relay`; Banked call to: bdb_SendIdentifyQuery
   2680                    }
   2681                    osal_start_timerEx(bdb_TaskID, BDB_FINDING_AND_BINDING_PERIOD_TIMEOUT, FINDING_AND_BINDING_PERIODIC_TIME * 1000);
   \                     ??bdb_event_loop_28:
   \   0001C3                ; Setup parameters for call to function osal_start_timerEx
   \   0001C3   90....       MOV       DPTR,#__Constant_3a98
   \   0001C6   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   0001C9   7A40         MOV       R2,#0x40
   \   0001CB   12....       LCALL     ??Subroutine55_0 & 0xFFFF
   2682                  }
   2683                }
   2684              }
   \                     ??CrossCallReturnLabel_130:
   \   0001CE   12....       LCALL     ?DEALLOC_XSTACK8
   2685          
   2686              if (bdb_FB_InitiatorCurrentCyclesNumber == 0)
   \                     ??bdb_event_loop_26:
   \   0001D1   90....       MOV       DPTR,#bdb_FB_InitiatorCurrentCyclesNumber
   \   0001D4   E0           MOVX      A,@DPTR
   \   0001D5   7005         JNZ       ??bdb_event_loop_29
   2687              {
   2688                bdb_exitFindingBindingWStatus( BDB_COMMISSIONING_FB_NO_IDENTIFY_QUERY_RESPONSE );
   \                     ??bdb_event_loop_27:
   \   0001D7                ; Setup parameters for call to function bdb_exitFindingBindingWStatus
   \   0001D7   790B         MOV       R1,#0xb
   \   0001D9   12....       LCALL     `??bdb_exitFindingBindingWStatus::?relay`; Banked call to: bdb_exitFindingBindingWStatus
   2689              }
   2690          
   2691              return (events ^ BDB_FINDING_AND_BINDING_PERIOD_TIMEOUT);
   \                     ??bdb_event_loop_29:
   \   0001DC   EE           MOV       A,R6
   \   0001DD   6440         XRL       A,#0x40
   \                     ??bdb_event_loop_6:
   \   0001DF   FA           MOV       R2,A
   \   0001E0   EF           MOV       A,R7
   \   0001E1   02....       LJMP      ??bdb_event_loop_19 & 0xFFFF
   2692            }
   2693          
   2694            if(events & BDB_IDENTIFY_TIMEOUT)
   \                     ??bdb_event_loop_25:
   \   0001E4   EB           MOV       A,R3
   \   0001E5   5420         ANL       A,#0x20
   \   0001E7   7003         JNZ       $+5
   \   0001E9   02....       LJMP      ??bdb_event_loop_30 & 0xFFFF
   2695            {
   2696              zclAttrRec_t identifyAttrRec;
   2697              epList_t *bdb_CurrEpDescriptorNextInList = NULL;
   2698              bdb_CurrEpDescriptorNextInList = bdb_HeadEpDescriptorList;
   \   0001EC   90....       MOV       DPTR,#bdb_HeadEpDescriptorList
   \   0001EF   12....       LCALL     ?Subroutine38 & 0xFFFF
   \                     ??CrossCallReturnLabel_108:
   \   0001F2   88..         MOV       ?V0,R0
   \   0001F4   F5..         MOV       ?V1,A
   2699          
   2700              bool KeepIdentifyTimerRunning = FALSE;
   \   0001F6   75..00       MOV       ?V4,#0x0
   \   0001F9   8024         SJMP      ??CrossCallReturnLabel_20
   2701          
   2702              while(bdb_CurrEpDescriptorNextInList != NULL )
   2703              {
   2704                endPointDesc_t *bdb_EpDescriptor = NULL;
   2705                bdb_EpDescriptor = bdb_CurrEpDescriptorNextInList->epDesc;
   2706          
   2707                //Do not check ZDO or Zigbee reserved endpoints
   2708                if((bdb_CurrEpDescriptorNextInList->epDesc->endPoint == 0) || (bdb_CurrEpDescriptorNextInList->epDesc->endPoint >= BDB_ZIGBEE_RESERVED_ENDPOINTS_START))
   2709                {
   2710                  bdb_CurrEpDescriptorNextInList = bdb_CurrEpDescriptorNextInList->nextDesc;
   2711                  continue;
   2712                }
   2713          
   2714                if ( zclFindAttrRec( bdb_EpDescriptor->endPoint, ZCL_CLUSTER_ID_GEN_IDENTIFY,
   2715                                  ATTRID_IDENTIFY_TIME, &identifyAttrRec ) )
   2716                {
   2717                  if(*((uint16*)identifyAttrRec.attr.dataPtr) > 0)
   2718                  {
   2719                    (uint16)(*((uint16*)identifyAttrRec.attr.dataPtr))--;
   2720                    KeepIdentifyTimerRunning = TRUE;
   2721                  }
   2722                  else
   2723                  {
   2724                    // Use bdb success main state
   2725                    bdbAttributes.bdbCommissioningStatus = BDB_COMMISSIONING_SUCCESS;
   \                     ??bdb_event_loop_31:
   \   0001FB   90....       MOV       DPTR,#bdbAttributes + 10
   \   0001FE   E4           CLR       A
   \   0001FF   F0           MOVX      @DPTR,A
   2726                    if(pfnIdentifyTimeChangeCB != NULL)
   \   000200   90....       MOV       DPTR,#pfnIdentifyTimeChangeCB
   \   000203   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_103:
   \   000206   600E         JZ        ??bdb_event_loop_32
   2727                    {
   2728                      pfnIdentifyTimeChangeCB(bdb_EpDescriptor->endPoint);
   \   000208                ; Setup parameters for indirect call
   \   000208   85..82       MOV       DPL,?V2
   \   00020B   85..83       MOV       DPH,?V3
   \   00020E   E0           MOVX      A,@DPTR
   \   00020F   F9           MOV       R1,A
   \   000210   12....       LCALL     ?Subroutine22 & 0xFFFF
   2729                    }
   2730                  }
   \                     ??CrossCallReturnLabel_88:
   \   000213   12....       LCALL     ?CALL_IND
   2731                }
   2732                bdb_CurrEpDescriptorNextInList = bdb_CurrEpDescriptorNextInList->nextDesc;
   \                     ??bdb_event_loop_32:
   \   000216   85..82       MOV       DPL,?V0
   \   000219   85..83       MOV       DPH,?V1
   \   00021C   12....       LCALL     ?Subroutine23 & 0xFFFF
   \                     ??CrossCallReturnLabel_20:
   \   00021F   E5..         MOV       A,?V0
   \   000221   45..         ORL       A,?V1
   \   000223   6069         JZ        ??bdb_event_loop_33
   \   000225   85..82       MOV       DPL,?V0
   \   000228   85..83       MOV       DPH,?V1
   \   00022B   A3           INC       DPTR
   \   00022C   A3           INC       DPTR
   \   00022D   12....       LCALL     ?Subroutine38 & 0xFFFF
   \                     ??CrossCallReturnLabel_109:
   \   000230   8882         MOV       DPL,R0
   \   000232   F583         MOV       DPH,A
   \   000234   8582..       MOV       ?V2,DPL
   \   000237   8583..       MOV       ?V3,DPH
   \   00023A   E0           MOVX      A,@DPTR
   \   00023B   60D9         JZ        ??bdb_event_loop_32
   \   00023D   C3           CLR       C
   \   00023E   94F1         SUBB      A,#-0xf
   \   000240   50D4         JNC       ??bdb_event_loop_32
   \   000242                ; Setup parameters for call to function zclFindAttrRec
   \   000242   7405         MOV       A,#0x5
   \   000244   12....       LCALL     ?XSTACK_DISP100_8
   \   000247   88..         MOV       ?V6,R0
   \   000249   89..         MOV       ?V7,R1
   \   00024B   78..         MOV       R0,#?V6
   \   00024D   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000250   7C00         MOV       R4,#0x0
   \   000252   7D00         MOV       R5,#0x0
   \   000254   7A03         MOV       R2,#0x3
   \   000256   7B00         MOV       R3,#0x0
   \   000258   85..82       MOV       DPL,?V2
   \   00025B   85..83       MOV       DPH,?V3
   \   00025E   E0           MOVX      A,@DPTR
   \   00025F   F9           MOV       R1,A
   \   000260   12....       LCALL     `??zclFindAttrRec::?relay`; Banked call to: zclFindAttrRec
   \   000263   7402         MOV       A,#0x2
   \   000265   12....       LCALL     ?DEALLOC_XSTACK8
   \   000268   E9           MOV       A,R1
   \   000269   60AB         JZ        ??bdb_event_loop_32
   \   00026B   740B         MOV       A,#0xb
   \   00026D   12....       LCALL     ?XSTACK_DISP0_8
   \   000270   12....       LCALL     ?Subroutine28 & 0xFFFF
   \                     ??CrossCallReturnLabel_33:
   \   000273   8882         MOV       DPL,R0
   \   000275   12....       LCALL     ?Subroutine20 & 0xFFFF
   \                     ??CrossCallReturnLabel_119:
   \   000278   6081         JZ        ??bdb_event_loop_31
   \   00027A   EA           MOV       A,R2
   \   00027B   24FF         ADD       A,#-0x1
   \   00027D   1A           DEC       R2
   \   00027E   EB           MOV       A,R3
   \   00027F   34FF         ADDC      A,#-0x1
   \   000281   FB           MOV       R3,A
   \   000282   8882         MOV       DPL,R0
   \   000284   8983         MOV       DPH,R1
   \   000286   12....       LCALL     ??Subroutine62_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_158:
   \   000289   75..01       MOV       ?V4,#0x1
   \   00028C   8088         SJMP      ??bdb_event_loop_32
   2733              }
   2734          
   2735              //If any endpoint has identify running, keep the timer on
   2736              if(KeepIdentifyTimerRunning)
   \                     ??bdb_event_loop_33:
   \   00028E   E5..         MOV       A,?V4
   \   000290   6012         JZ        ??bdb_event_loop_34
   2737              {
   2738                osal_start_timerEx( bdb_TaskID, BDB_IDENTIFY_TIMEOUT, 1000 );
   \   000292                ; Setup parameters for call to function osal_start_timerEx
   \   000292   90....       MOV       DPTR,#__Constant_3e8
   \   000295   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000298   7A00         MOV       R2,#0x0
   \   00029A   7B20         MOV       R3,#0x20
   \   00029C   12....       LCALL     ??Subroutine56_0 & 0xFFFF
   2739              }
   \                     ??CrossCallReturnLabel_134:
   \   00029F   12....       LCALL     ?DEALLOC_XSTACK8
   \   0002A2   8007         SJMP      ??CrossCallReturnLabel_73
   2740              else
   2741              {
   2742                osal_stop_timerEx( bdb_TaskID, BDB_IDENTIFY_TIMEOUT );
   \                     ??bdb_event_loop_34:
   \   0002A4                ; Setup parameters for call to function osal_stop_timerEx
   \   0002A4   7A00         MOV       R2,#0x0
   \   0002A6   7B20         MOV       R3,#0x20
   \   0002A8   12....       LCALL     ??Subroutine47_0 & 0xFFFF
   2743              }
   2744          
   2745              // Return unprocessed events
   2746              return (events ^ BDB_IDENTIFY_TIMEOUT);
   \                     ??CrossCallReturnLabel_73:
   \   0002AB   EE           MOV       A,R6
   \   0002AC   FA           MOV       R2,A
   \   0002AD   EF           MOV       A,R7
   \   0002AE   6420         XRL       A,#0x20
   \   0002B0   800D         SJMP      ??bdb_event_loop_19
   2747            }
   2748          
   2749            if(events & BDB_RESPONDENT_PROCESS_TIMEOUT)
   \                     ??bdb_event_loop_30:
   \   0002B2   EB           MOV       A,R3
   \   0002B3   5440         ANL       A,#0x40
   \   0002B5   600B         JZ        ??bdb_event_loop_35
   2750            {
   2751              // Send Simple Descriptor request to a respondent node
   2752              bdb_ProcessRespondentList();
   \   0002B7                ; Setup parameters for call to function bdb_ProcessRespondentList
   \   0002B7   12....       LCALL     `??bdb_ProcessRespondentList::?relay`; Banked call to: bdb_ProcessRespondentList
   2753          
   2754              return (events ^ BDB_RESPONDENT_PROCESS_TIMEOUT);
   \   0002BA   EE           MOV       A,R6
   \   0002BB   FA           MOV       R2,A
   \   0002BC   EF           MOV       A,R7
   \   0002BD   6440         XRL       A,#0x40
   \                     ??bdb_event_loop_19:
   \   0002BF   FB           MOV       R3,A
   \   0002C0   8004         SJMP      ??bdb_event_loop_36
   2755            }
   2756          #endif
   2757          
   2758            return 0;
   \                     ??bdb_event_loop_35:
   \   0002C2   7A00         MOV       R2,#0x0
   \   0002C4   7B00         MOV       R3,#0x0
   \                     ??bdb_event_loop_36:
   \   0002C6   740D         MOV       A,#0xd
   \   0002C8   12....       LCALL     ?DEALLOC_XSTACK8
   \   0002CB   7F08         MOV       R7,#0x8
   \   0002CD   02....       LJMP      ?BANKED_LEAVE_XDATA
   2759          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine20:
   \   000000   F583         MOV       DPH,A
   \   000002                REQUIRE ??Subroutine54_0
   \   000002                ; // Fall through to label ??Subroutine54_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine23:
   \   000000   E0           MOVX      A,@DPTR
   \   000001   F5..         MOV       ?V0,A
   \   000003   A3           INC       DPTR
   \   000004   E0           MOVX      A,@DPTR
   \   000005   F5..         MOV       ?V1,A
   \   000007   22           RET
   2760          
   2761          /*********************************************************************
   2762           * @fn          bdb_processZDOMgs
   2763           *
   2764           * @brief       Process ZDO messages used as part of BDB commissioning methods
   2765           *
   2766           * @param       zdoIncomingMsg_t - ZDO message
   2767           *
   2768           * @return
   2769           */
   2770          static void bdb_processZDOMgs(zdoIncomingMsg_t *pMsg)
   2771          {
   2772            switch ( pMsg->clusterID )
   2773            {
   2774          #if (BDB_FINDING_BINDING_CAPABILITY_ENABLED==1)
   2775              case IEEE_addr_rsp:
   2776                 bdb_ProcessIEEEAddrRsp(pMsg);
   2777              break;
   2778              case Simple_Desc_rsp:
   2779                bdb_ProcessSimpleDesc(pMsg);
   2780              break;
   2781          #endif
   2782          
   2783          #if (ZG_BUILD_JOINING_TYPE)
   2784              case Node_Desc_rsp:
   2785                bdb_ProcessNodeDescRsp(pMsg);
   2786              break;
   2787          #endif
   2788          
   2789              default:
   2790              break;
   2791            }
   2792          }
   2793          
   2794          
   2795          /*********************************************************************
   2796           * @fn      bdb_ProcessNodeDescRsp
   2797           *
   2798           * @brief   Process Node Descriptor response to validate the stack version of the
   2799           *
   2800           * @param   zdoIncomingMsg_t *pMsg
   2801           *
   2802           * @return  none
   2803           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2804          void bdb_ProcessNodeDescRsp(zdoIncomingMsg_t *pMsg)
   \                     bdb_ProcessNodeDescRsp:
   2805          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 35
   \   000005   74DD         MOV       A,#-0x23
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   EA           MOV       A,R2
   \   00000B   FE           MOV       R6,A
   \   00000C   EB           MOV       A,R3
   \   00000D   FF           MOV       R7,A
   2806            //Avoid processing unintended messages
   2807            if(requestNewTrustCenterLinkKey &&
   2808              (bdbCommissioningProcedureState.bdbCommissioningState == BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE))
   \   00000E   90....       MOV       DPTR,#requestNewTrustCenterLinkKey
   \   000011   E0           MOVX      A,@DPTR
   \   000012   607C         JZ        ??CrossCallReturnLabel_43
   \   000014   90....       MOV       DPTR,#bdbCommissioningProcedureState
   \   000017   E0           MOVX      A,@DPTR
   \   000018   6401         XRL       A,#0x1
   \   00001A   7074         JNZ       ??CrossCallReturnLabel_43
   2809            {
   2810              if(!APSME_IsDistributedSecurity())
   \   00001C                ; Setup parameters for call to function APSME_IsDistributedSecurity
   \   00001C   12....       LCALL     `??APSME_IsDistributedSecurity::?relay`; Banked call to: APSME_IsDistributedSecurity
   \   00001F   E9           MOV       A,R1
   \   000020   706E         JNZ       ??CrossCallReturnLabel_43
   2811              {
   2812                //Is this from the coordinator?
   2813                if(pMsg->srcAddr.addr.shortAddr == 0x0000)
   \   000022   8E82         MOV       DPL,R6
   \   000024   8F83         MOV       DPH,R7
   \   000026   A3           INC       DPTR
   \   000027   A3           INC       DPTR
   \   000028   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_104:
   \   00002B   7063         JNZ       ??CrossCallReturnLabel_43
   2814                {
   2815                  ZDO_NodeDescRsp_t NDRsp;
   2816                  uint8 StackComplianceRev;
   2817          
   2818                  //Stop timer to avoid unintended resets
   2819                  osal_stop_timerEx( bdb_TaskID, BDB_PROCESS_TIMEOUT);
   \   00002D                ; Setup parameters for call to function osal_stop_timerEx
   \   00002D   12....       LCALL     ?Subroutine17 & 0xFFFF
   2820          
   2821                  ZDO_ParseNodeDescRsp(pMsg, &NDRsp);
   \                     ??CrossCallReturnLabel_68:
   \   000030                ; Setup parameters for call to function ZDO_ParseNodeDescRsp
   \   000030   7413         MOV       A,#0x13
   \   000032   12....       LCALL     ?XSTACK_DISP102_8
   \   000035   EE           MOV       A,R6
   \   000036   FA           MOV       R2,A
   \   000037   EF           MOV       A,R7
   \   000038   FB           MOV       R3,A
   \   000039   12....       LCALL     `??ZDO_ParseNodeDescRsp::?relay`; Banked call to: ZDO_ParseNodeDescRsp
   2822          
   2823                  StackComplianceRev = NDRsp.nodeDesc.ServerMask >> STACK_COMPLIANCE_CURRENT_REV_POS;
   2824          
   2825                  if( StackComplianceRev >= STACK_COMPL_REV_21 )
   \   00003C   741E         MOV       A,#0x1e
   \   00003E   12....       LCALL     ?XSTACK_DISP0_8
   \   000041   12....       LCALL     ?Subroutine23 & 0xFFFF
   \                     ??CrossCallReturnLabel_21:
   \   000044   7409         MOV       A,#0x9
   \   000046   78..         MOV       R0,#?V0
   \   000048   12....       LCALL     ?US_SHR
   \   00004B   C3           CLR       C
   \   00004C   E5..         MOV       A,?V0
   \   00004E   9415         SUBB      A,#0x15
   \   000050   95E0         SUBB      A,0xE0 /* A   */
   \   000052   C3           CLR       C
   \   000053   65D0         XRL       A,PSW
   \   000055   33           RLC       A
   \   000056   4009         JC        ??bdb_ProcessNodeDescRsp_0
   2826                  {
   2827                    bdb_tcLinkKeyExchangeAttempt(TRUE,BDB_REQ_TC_LINK_KEY);
   \   000058                ; Setup parameters for call to function bdb_tcLinkKeyExchangeAttempt
   \   000058   7A02         MOV       R2,#0x2
   \   00005A   7901         MOV       R1,#0x1
   \   00005C   12....       LCALL     `??bdb_tcLinkKeyExchangeAttempt::?relay`; Banked call to: bdb_tcLinkKeyExchangeAttempt
   \   00005F   802F         SJMP      ??CrossCallReturnLabel_43
   2828                  }
   2829                  else
   2830                  {
   2831                    APSME_TCLKDevEntry_t TCLKDevEntry;
   2832          
   2833                    //Save the KeyAttribute for joining device that it has joined non-R21 nwk
   2834                    TCLKDevEntry.keyAttributes = ZG_NON_R21_NWK_JOINED;
   \                     ??bdb_ProcessNodeDescRsp_0:
   \   000061   7410         MOV       A,#0x10
   \   000063   12....       LCALL     ?XSTACK_DISP0_8
   \   000066   74FD         MOV       A,#-0x3
   \   000068   F0           MOVX      @DPTR,A
   2835                    osal_nv_write(ZCD_NV_TCLK_TABLE_START,osal_offsetof(APSME_TCLKDevEntry_t,keyAttributes),sizeof(uint8),&TCLKDevEntry.keyAttributes);
   \   000069                ; Setup parameters for call to function osal_nv_write
   \   000069   8582..       MOV       ?V0,DPL
   \   00006C   8583..       MOV       ?V1,DPH
   \   00006F   78..         MOV       R0,#?V0
   \   000071   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000074   75..01       MOV       ?V0,#0x1
   \   000077   75..00       MOV       ?V1,#0x0
   \   00007A   78..         MOV       R0,#?V0
   \   00007C   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00007F   7C10         MOV       R4,#0x10
   \   000081   7D00         MOV       R5,#0x0
   \   000083   7A11         MOV       R2,#0x11
   \   000085   7B01         MOV       R3,#0x1
   \   000087   12....       LCALL     ??Subroutine45_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_64:
   \   00008A   12....       LCALL     ?DEALLOC_XSTACK8
   2836          
   2837                    bdb_setNodeJoinLinkKeyType(BDB_DEFAULT_GLOBAL_TRUST_CENTER_LINK_KEY);
   \   00008D                ; Setup parameters for call to function bdb_setNodeJoinLinkKeyType
   \   00008D   12....       LCALL     ?Subroutine34 & 0xFFFF
   2838                    bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE, TRUE);
   2839                  }
   2840                }
   2841              }
   2842            }
   2843          }
   \                     ??CrossCallReturnLabel_43:
   \   000090   7423         MOV       A,#0x23
   \   000092   80..         SJMP      ??Subroutine59_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine34:
   \   000000   7900         MOV       R1,#0x0
   \   000002   12....       LCALL     `??bdb_setNodeJoinLinkKeyType::?relay`; Banked call to: bdb_setNodeJoinLinkKeyType
   \   000005                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000005                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000005   7A01         MOV       R2,#0x1
   \   000007   7901         MOV       R1,#0x1
   \   000009   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   \   00000C   22           RET
   2844          
   2845          
   2846          /*********************************************************************
   2847           * @fn          bdb_touchlinkSendFNReset
   2848           *
   2849           * @brief       Starts the Factory New Procedure for Initiator
   2850           *
   2851           * @param       isOnANetwork - TRUE if the devices is not FN, FALSE otherwise
   2852           *
   2853           * @return      none
   2854           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2855          void bdb_touchlinkSendFNReset( void )
   \                     bdb_touchlinkSendFNReset:
   2856          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
   2857          #ifdef BDB_TL_INITIATOR
   2858            touchLinkInitiator_ResetToFNProcedure( );
   2859          #endif
   2860          }
   \   000000   02....       LJMP      ?BRET
   2861          
   2862          
   2863          /*********************************************************************
   2864           * @fn          bdb_setNodeIsOnANetwork
   2865           *
   2866           * @brief       Sets and saves in Nv bdbNodeIsOnANetwork attribute
   2867           *
   2868           * @param       isOnANetwork - TRUE if the devices is not FN, FALSE otherwise
   2869           *
   2870           * @return      none
   2871           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2872          void bdb_setNodeIsOnANetwork(bool isOnANetwork)
   \                     bdb_setNodeIsOnANetwork:
   2873          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   \   000006   FE           MOV       R6,A
   2874            if((bdbAttributes.bdbNodeIsOnANetwork != isOnANetwork) || (!bdb_initialization))
   \   000007   90....       MOV       DPTR,#bdbAttributes + 14
   \   00000A   E0           MOVX      A,@DPTR
   \   00000B   6E           XRL       A,R6
   \   00000C   7006         JNZ       ??bdb_setNodeIsOnANetwork_0
   \   00000E   90....       MOV       DPTR,#bdb_initialization
   \   000011   E0           MOVX      A,@DPTR
   \   000012   7029         JNZ       ??bdb_setNodeIsOnANetwork_1
   2875            {
   2876              //We lose our network
   2877              if(!isOnANetwork)
   \                     ??bdb_setNodeIsOnANetwork_0:
   \   000014   E9           MOV       A,R1
   \   000015   7005         JNZ       ??bdb_setNodeIsOnANetwork_2
   2878              {
   2879                bdbAttributes.bdbCommissioningMode = 0;
   \   000017   90....       MOV       DPTR,#bdbAttributes + 11
   \   00001A   E4           CLR       A
   \   00001B   F0           MOVX      @DPTR,A
   2880              }
   2881          
   2882              bdbAttributes.bdbNodeIsOnANetwork = isOnANetwork;
   \                     ??bdb_setNodeIsOnANetwork_2:
   \   00001C   E9           MOV       A,R1
   \   00001D   90....       MOV       DPTR,#bdbAttributes + 14
   \   000020   F0           MOVX      @DPTR,A
   2883          
   2884              osal_nv_write(ZCD_NV_BDBNODEISONANETWORK,0,sizeof(bdbAttributes.bdbNodeIsOnANetwork),&bdbAttributes.bdbNodeIsOnANetwork);
   \   000021                ; Setup parameters for call to function osal_nv_write
   \   000021   75....       MOV       ?V0,#(bdbAttributes + 14) & 0xff
   \   000024   75....       MOV       ?V1,#((bdbAttributes + 14) >> 8) & 0xff
   \   000027   78..         MOV       R0,#?V0
   \   000029   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00002C   75..01       MOV       ?V0,#0x1
   \   00002F   75..00       MOV       ?V1,#0x0
   \   000032   78..         MOV       R0,#?V0
   \   000034   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000037   12....       LCALL     ?Subroutine30 & 0xFFFF
   2885            }
   \                     ??CrossCallReturnLabel_61:
   \   00003A   12....       LCALL     ?DEALLOC_XSTACK8
   2886          }
   \                     ??bdb_setNodeIsOnANetwork_1:
   \   00003D   80..         SJMP      ??Subroutine60_0
   2887          
   2888          /*********************************************************************
   2889           * @fn          bdb_setCommissioningGroupID
   2890           *
   2891           * @brief       Sets the commissioning groupd ID
   2892           *
   2893           * @param       groupID
   2894           *
   2895           * @return      none
   2896           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   EA           MOV       A,R2
   \   000001   F0           MOVX      @DPTR,A
   \   000002   A3           INC       DPTR
   \   000003   EB           MOV       A,R3
   \   000004                REQUIRE ??Subroutine41_0
   \   000004                ; // Fall through to label ??Subroutine41_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2897          void bdb_setCommissioningGroupID(uint16 groupID)
   \                     bdb_setCommissioningGroupID:
   2898          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   2899            bdbAttributes.bdbCommissioningGroupID = groupID;
   \   000004   90....       MOV       DPTR,#bdbAttributes + 8
   \   000007   02....       LJMP      ?Subroutine3 & 0xFFFF
   2900          }
   2901          
   2902          /*********************************************************************
   2903           * @fn      bdb_CreateRespondentList
   2904           *
   2905           * @brief   Create respondent list for finding and binding if empty
   2906           *
   2907           * @param   pHead - pointer to a pointer of the list head
   2908           *
   2909           * @return  none
   2910           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine13:
   \   000000   EA           MOV       A,R2
   \   000001   FE           MOV       R6,A
   \   000002   EB           MOV       A,R3
   \   000003   FF           MOV       R7,A
   \   000004   8A82         MOV       DPL,R2
   \   000006   F583         MOV       DPH,A
   \   000008                REQUIRE ??Subroutine52_0
   \   000008                ; // Fall through to label ??Subroutine52_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2911          void bdb_CreateRespondentList( bdbFindingBindingRespondent_t **pHead )
   \                     bdb_CreateRespondentList:
   2912          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   12....       LCALL     ?Subroutine13 & 0xFFFF
   2913          
   2914            // Create the list if empty
   2915            if ( *pHead == NULL )
   \                     ??CrossCallReturnLabel_89:
   \   000008   700A         JNZ       ??CrossCallReturnLabel_37
   2916            {
   2917              *pHead = ( bdbFindingBindingRespondent_t* )osal_mem_alloc( sizeof( bdbFindingBindingRespondent_t ) );
   \   00000A                ; Setup parameters for call to function osal_mem_alloc
   \   00000A   12....       LCALL     ?Subroutine7 & 0xFFFF
   2918          
   2919              if ( *pHead != NULL )
   \                     ??CrossCallReturnLabel_154:
   \   00000D   EA           MOV       A,R2
   \   00000E   49           ORL       A,R1
   \   00000F   6003         JZ        ??CrossCallReturnLabel_37
   2920              {
   2921                (*pHead)->pNext = NULL;
   \   000011   12....       LCALL     ?Subroutine31 & 0xFFFF
   2922              }
   2923            }
   2924            return;
   \                     ??CrossCallReturnLabel_37:
   \   000014   80..         SJMP      ??Subroutine60_0
   2925          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine31:
   \   000000   EA           MOV       A,R2
   \   000001   12....       LCALL     ?Subroutine40 & 0xFFFF
   \                     ??CrossCallReturnLabel_56:
   \   000004   E4           CLR       A
   \   000005   F0           MOVX      @DPTR,A
   \   000006   A3           INC       DPTR
   \   000007   F0           MOVX      @DPTR,A
   \   000008   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine7:
   \   000000   7A11         MOV       R2,#0x11
   \   000002   7B00         MOV       R3,#0x0
   \   000004   12....       LCALL     `??osal_mem_alloc::?relay`; Banked call to: osal_mem_alloc
   \   000007   8B..         MOV       ?V1,R3
   \   000009   A9..         MOV       R1,?V1
   \   00000B   8E82         MOV       DPL,R6
   \   00000D   8F83         MOV       DPH,R7
   \   00000F                REQUIRE ??Subroutine62_0
   \   00000F                ; // Fall through to label ??Subroutine62_0
   2926          
   2927          /*********************************************************************
   2928           * @fn      bdb_AddRespondentNode
   2929           *
   2930           * @brief   Add node to respondent list for finding and binding
   2931           *
   2932           * @param   pHead - pointer to a pointer of the list head
   2933           *
   2934           * @return  pointer to new node
   2935           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2936          bdbFindingBindingRespondent_t* bdb_AddRespondentNode( bdbFindingBindingRespondent_t **pHead, zclIdentifyQueryRsp_t *pCmd )
   \                     bdb_AddRespondentNode:
   2937          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   12....       LCALL     ?Subroutine13 & 0xFFFF
   2938            bdbFindingBindingRespondent_t **pCurr;
   2939            bdbFindingBindingRespondent_t *temp;
   2940          
   2941              // Create respondent list if empty
   2942            if ( *pHead == NULL )
   \                     ??CrossCallReturnLabel_90:
   \   000008   7006         JNZ       ??bdb_AddRespondentNode_0
   2943            {
   2944              bdb_CreateRespondentList( pHead );
   \   00000A                ; Setup parameters for call to function bdb_CreateRespondentList
   \   00000A   12....       LCALL     `??bdb_CreateRespondentList::?relay`; Banked call to: bdb_CreateRespondentList
   2945              return *pHead;
   \   00000D   02....       LJMP      ??CrossCallReturnLabel_38 & 0xFFFF
   2946            }
   2947            else
   2948            {
   2949              // if pCmd is equal to NULL, don't look for duplucates
   2950              if( pCmd != NULL )
   \                     ??bdb_AddRespondentNode_0:
   \   000010   EC           MOV       A,R4
   \   000011   4D           ORL       A,R5
   \   000012   606B         JZ        ??bdb_AddRespondentNode_1
   2951              {
   2952                //Find if any duplicate in the list
   2953                temp = *pHead;
   \   000014   E8           MOV       A,R0
   \   000015   FA           MOV       R2,A
   \   000016   E9           MOV       A,R1
   \   000017   FB           MOV       R3,A
   \   000018   8C82         MOV       DPL,R4
   \   00001A   8D83         MOV       DPH,R5
   \   00001C   12....       LCALL     ?Subroutine27 & 0xFFFF
   2954          
   2955                while(temp != NULL)
   2956                {
   2957                  if((temp->data.endPoint == pCmd->srcAddr->endPoint) && (temp->data.panId == pCmd->srcAddr->panId))
   \                     ??CrossCallReturnLabel_29:
   \   00001F   8A82         MOV       DPL,R2
   \   000021   8B83         MOV       DPH,R3
   \   000023   A3           INC       DPTR
   \   000024   A3           INC       DPTR
   \   000025   A3           INC       DPTR
   \   000026   A3           INC       DPTR
   \   000027   A3           INC       DPTR
   \   000028   A3           INC       DPTR
   \   000029   A3           INC       DPTR
   \   00002A   A3           INC       DPTR
   \   00002B   A3           INC       DPTR
   \   00002C   E0           MOVX      A,@DPTR
   \   00002D   FE           MOV       R6,A
   \   00002E   8C82         MOV       DPL,R4
   \   000030   8D83         MOV       DPH,R5
   \   000032   A3           INC       DPTR
   \   000033   A3           INC       DPTR
   \   000034   A3           INC       DPTR
   \   000035   A3           INC       DPTR
   \   000036   A3           INC       DPTR
   \   000037   A3           INC       DPTR
   \   000038   A3           INC       DPTR
   \   000039   A3           INC       DPTR
   \   00003A   A3           INC       DPTR
   \   00003B   E0           MOVX      A,@DPTR
   \   00003C   6E           XRL       A,R6
   \   00003D   7034         JNZ       ??bdb_AddRespondentNode_2
   \   00003F   8A82         MOV       DPL,R2
   \   000041   8B83         MOV       DPH,R3
   \   000043   A3           INC       DPTR
   \   000044   A3           INC       DPTR
   \   000045   A3           INC       DPTR
   \   000046   A3           INC       DPTR
   \   000047   A3           INC       DPTR
   \   000048   A3           INC       DPTR
   \   000049   A3           INC       DPTR
   \   00004A   A3           INC       DPTR
   \   00004B   A3           INC       DPTR
   \   00004C   A3           INC       DPTR
   \   00004D   12....       LCALL     ?Subroutine29 & 0xFFFF
   \                     ??CrossCallReturnLabel_35:
   \   000050   A3           INC       DPTR
   \   000051   A3           INC       DPTR
   \   000052   A3           INC       DPTR
   \   000053   A3           INC       DPTR
   \   000054   A3           INC       DPTR
   \   000055   A3           INC       DPTR
   \   000056   A3           INC       DPTR
   \   000057   A3           INC       DPTR
   \   000058   A3           INC       DPTR
   \   000059   A3           INC       DPTR
   \   00005A   E0           MOVX      A,@DPTR
   \   00005B   6E           XRL       A,R6
   \   00005C   7003         JNZ       ??bdb_AddRespondentNode_3
   \   00005E   A3           INC       DPTR
   \   00005F   E0           MOVX      A,@DPTR
   \   000060   6F           XRL       A,R7
   \                     ??bdb_AddRespondentNode_3:
   \   000061   7010         JNZ       ??bdb_AddRespondentNode_2
   2958                  {
   2959                    //Duplicate
   2960                    if(temp->data.addr.shortAddr == pCmd->srcAddr->addr.shortAddr)
   \   000063   8A82         MOV       DPL,R2
   \   000065   8B83         MOV       DPH,R3
   \   000067   12....       LCALL     ?Subroutine29 & 0xFFFF
   2961                    {
   2962                      return NULL;
   2963                    }
   2964                  }
   \                     ??CrossCallReturnLabel_36:
   \   00006A   E0           MOVX      A,@DPTR
   \   00006B   6E           XRL       A,R6
   \   00006C   7003         JNZ       ??bdb_AddRespondentNode_4
   \   00006E   A3           INC       DPTR
   \   00006F   E0           MOVX      A,@DPTR
   \   000070   6F           XRL       A,R7
   \                     ??bdb_AddRespondentNode_4:
   \   000071   6023         JZ        ??bdb_AddRespondentNode_5
   2965                  temp = temp->pNext;
   \                     ??bdb_AddRespondentNode_2:
   \   000073   EA           MOV       A,R2
   \   000074   240F         ADD       A,#0xf
   \   000076   F582         MOV       DPL,A
   \   000078   E4           CLR       A
   \   000079   3B           ADDC      A,R3
   \   00007A   12....       LCALL     ?Subroutine20 & 0xFFFF
   2966                }
   2967              }
   \                     ??CrossCallReturnLabel_116:
   \   00007D   70A0         JNZ       ??CrossCallReturnLabel_29
   2968          
   2969              pCurr = &((*pHead)->pNext);
   2970          
   2971              while ( *pCurr != NULL )
   2972              {
   2973                pCurr = &((*pCurr)->pNext);
   \                     ??bdb_AddRespondentNode_1:
   \   00007F   E8           MOV       A,R0
   \   000080   240F         ADD       A,#0xf
   \   000082   FE           MOV       R6,A
   \   000083   E4           CLR       A
   \   000084   39           ADDC      A,R1
   \   000085   FF           MOV       R7,A
   2974              }
   \   000086   8E82         MOV       DPL,R6
   \   000088   8F83         MOV       DPH,R7
   \   00008A   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_105:
   \   00008D   70F0         JNZ       ??bdb_AddRespondentNode_1
   2975          
   2976              *pCurr = ( bdbFindingBindingRespondent_t* )osal_mem_alloc( sizeof( bdbFindingBindingRespondent_t ) );
   \   00008F                ; Setup parameters for call to function osal_mem_alloc
   \   00008F   12....       LCALL     ?Subroutine7 & 0xFFFF
   2977          
   2978              if(*pCurr == NULL)
   \                     ??CrossCallReturnLabel_155:
   \   000092   EA           MOV       A,R2
   \   000093   49           ORL       A,R1
   \   000094   7006         JNZ       ??bdb_AddRespondentNode_6
   2979              {
   2980                //No memory
   2981                return NULL;
   \                     ??bdb_AddRespondentNode_5:
   \   000096   7A00         MOV       R2,#0x0
   \   000098   7B00         MOV       R3,#0x0
   \   00009A   800A         SJMP      ??CrossCallReturnLabel_145
   2982              }
   2983          
   2984              (*pCurr)->pNext = NULL;
   \                     ??bdb_AddRespondentNode_6:
   \   00009C   12....       LCALL     ?Subroutine31 & 0xFFFF
   2985            }
   2986          
   2987            return *pCurr;
   \                     ??CrossCallReturnLabel_38:
   \   00009F   8E82         MOV       DPL,R6
   \   0000A1   8F83         MOV       DPH,R7
   \   0000A3   12....       LCALL     ??Subroutine61_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_145:
   \   0000A6   02....       LJMP      ??Subroutine60_0 & 0xFFFF
   2988          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine29:
   \   000000   12....       LCALL     ?Subroutine37 & 0xFFFF
   \                     ??CrossCallReturnLabel_50:
   \   000003   8C82         MOV       DPL,R4
   \   000005   8D83         MOV       DPH,R5
   \   000007   22           RET
   2989          
   2990          /*********************************************************************
   2991           * @fn      bdb_zclRespondentListClean
   2992           *
   2993           * @brief   This function free reserved memory for respondent list
   2994           *
   2995           * @param   pHead - begin of the respondent list
   2996           *
   2997           * @return  status
   2998           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2999          void bdb_zclRespondentListClean( bdbFindingBindingRespondent_t **pHead )
   \                     bdb_zclRespondentListClean:
   3000          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   12....       LCALL     ?Subroutine13 & 0xFFFF
   3001            bdbFindingBindingRespondent_t **pCurr;
   3002            bdbFindingBindingRespondent_t **pNext;
   3003          
   3004            if ( *pHead == NULL )
   \                     ??CrossCallReturnLabel_91:
   \   000008   6035         JZ        ??bdb_zclRespondentListClean_0
   3005            {
   3006              return;
   3007            }
   3008          
   3009            pCurr = pHead;
   \   00000A   8A..         MOV       ?V0,R2
   \   00000C   8B..         MOV       ?V1,R3
   \   00000E   801C         SJMP      ??bdb_zclRespondentListClean_1
   3010          
   3011            while( *pCurr != NULL )
   3012            {
   3013              pNext = &((*pCurr)->pNext);
   \                     ??bdb_zclRespondentListClean_2:
   \   000010   EA           MOV       A,R2
   \   000011   240F         ADD       A,#0xf
   \   000013   F5..         MOV       ?V2,A
   \   000015   E4           CLR       A
   \   000016   3B           ADDC      A,R3
   \   000017   F5..         MOV       ?V3,A
   3014              osal_mem_free( *pCurr );
   \   000019                ; Setup parameters for call to function osal_mem_free
   \   000019   12....       LCALL     `??osal_mem_free::?relay`; Banked call to: osal_mem_free
   3015              *pCurr = ( bdbFindingBindingRespondent_t* )NULL;
   \   00001C   85..82       MOV       DPL,?V0
   \   00001F   85..83       MOV       DPH,?V1
   \   000022   E4           CLR       A
   \   000023   F0           MOVX      @DPTR,A
   \   000024   A3           INC       DPTR
   \   000025   F0           MOVX      @DPTR,A
   3016              pCurr = pNext;
   \   000026   85....       MOV       ?V0,?V2
   \   000029   85....       MOV       ?V1,?V3
   3017            }
   \                     ??bdb_zclRespondentListClean_1:
   \   00002C   85..82       MOV       DPL,?V0
   \   00002F   85..83       MOV       DPH,?V1
   \   000032   12....       LCALL     ??Subroutine54_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_118:
   \   000035   70D9         JNZ       ??bdb_zclRespondentListClean_2
   3018            *pHead = NULL;
   \   000037   8E82         MOV       DPL,R6
   \   000039   8F83         MOV       DPH,R7
   \   00003B   E4           CLR       A
   \   00003C   F0           MOVX      @DPTR,A
   \   00003D   A3           INC       DPTR
   \   00003E   F0           MOVX      @DPTR,A
   3019          }
   \                     ??bdb_zclRespondentListClean_0:
   \   00003F   02....       LJMP      ??Subroutine50_0 & 0xFFFF
   3020          
   3021           /*********************************************************************
   3022           * PRIVATE FUNCTIONS
   3023           *********************************************************************/
   3024          
   3025          /*********************************************************************
   3026           * @fn      bdb_ProcessOSALMsg
   3027           *
   3028           * @brief   Process the incoming task message.
   3029           *
   3030           * @param   msgPtr - message to process
   3031           *
   3032           * @return  none
   3033           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3034          void bdb_ProcessOSALMsg( bdbInMsg_t *msgPtr )
   \                     bdb_ProcessOSALMsg:
   3035          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000   74F6         MOV       A,#-0xa
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 26
   \   000005   74E6         MOV       A,#-0x1a
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   3036          
   3037            switch(msgPtr->hdr.event)
   \   00000A   8A82         MOV       DPL,R2
   \   00000C   8B83         MOV       DPH,R3
   \   00000E   E0           MOVX      A,@DPTR
   \   00000F   14           DEC       A
   \   000010   7003         JNZ       $+5
   \   000012   02....       LJMP      ??bdb_ProcessOSALMsg_0 & 0xFFFF
   \   000015   24FE         ADD       A,#-0x2
   \   000017   6003         JZ        $+5
   \   000019   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3038            {
   3039          #if (ZG_BUILD_JOINING_TYPE)
   3040              case BDB_COMMISSIONING_STATE_JOINING:
   3041                if(ZG_DEVICE_JOINING_TYPE)
   \   00001C   90....       MOV       DPTR,#zgDeviceLogicalType
   \   00001F   E0           MOVX      A,@DPTR
   \   000020   6401         XRL       A,#0x1
   \   000022   6008         JZ        ??bdb_ProcessOSALMsg_2
   \   000024   E0           MOVX      A,@DPTR
   \   000025   6402         XRL       A,#0x2
   \   000027   6003         JZ        $+5
   \   000029   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3042                {
   3043                  switch(msgPtr->buf[0])
   \                     ??bdb_ProcessOSALMsg_2:
   \   00002C   8A82         MOV       DPL,R2
   \   00002E   8B83         MOV       DPH,R3
   \   000030   A3           INC       DPTR
   \   000031   A3           INC       DPTR
   \   000032   E0           MOVX      A,@DPTR
   \   000033   6006         JZ        ??bdb_ProcessOSALMsg_3
   \   000035   14           DEC       A
   \   000036   6018         JZ        ??bdb_ProcessOSALMsg_4
   \   000038   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3044                  {
   3045                    case BDB_JOIN_EVENT_NWK_DISCOVERY:
   3046                      if(msgPtr->hdr.status == BDB_MSG_EVENT_SUCCESS)
   \                     ??bdb_ProcessOSALMsg_3:
   \   00003B   8A82         MOV       DPL,R2
   \   00003D   8B83         MOV       DPH,R3
   \   00003F   A3           INC       DPTR
   \   000040   E0           MOVX      A,@DPTR
   \   000041   7005         JNZ       ??bdb_ProcessOSALMsg_5
   3047                      {
   3048                        bdb_filterNwkDisc();
   \   000043                ; Setup parameters for call to function bdb_filterNwkDisc
   \   000043   12....       LCALL     `??bdb_filterNwkDisc::?relay`; Banked call to: bdb_filterNwkDisc
   3049                        bdb_tryNwkAssoc();
   \   000046                ; Setup parameters for call to function bdb_tryNwkAssoc
   \   000046   805E         SJMP      ??bdb_ProcessOSALMsg_6
   3050                      }
   3051                      else
   3052                      {
   3053                        bdb_nwkDiscoveryAttempt(FALSE);
   \                     ??bdb_ProcessOSALMsg_5:
   \   000048                ; Setup parameters for call to function bdb_nwkDiscoveryAttempt
   \   000048   7900         MOV       R1,#0x0
   \   00004A   12....       LCALL     `??bdb_nwkDiscoveryAttempt::?relay`; Banked call to: bdb_nwkDiscoveryAttempt
   \   00004D   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3054                      }
   3055                    break;
   3056          
   3057                    case BDB_JOIN_EVENT_ASSOCIATION:
   3058                      if(msgPtr->hdr.status == BDB_MSG_EVENT_SUCCESS)
   \                     ??bdb_ProcessOSALMsg_4:
   \   000050   8A82         MOV       DPL,R2
   \   000052   8B83         MOV       DPH,R3
   \   000054   A3           INC       DPTR
   \   000055   E0           MOVX      A,@DPTR
   \   000056   700C         JNZ       ??bdb_ProcessOSALMsg_7
   3059                      {
   3060                        bdbCommissioningProcedureState.bdbJoinState = BDB_JOIN_STATE_WAITING_NWK_KEY;
   \   000058   90....       MOV       DPTR,#bdbCommissioningProcedureState + 2
   \   00005B   7402         MOV       A,#0x2
   \   00005D   F0           MOVX      @DPTR,A
   3061                        //Nwk key timeout get right timing
   3062                        osal_start_timerEx(bdb_TaskID,BDB_PROCESS_TIMEOUT, BDB_DEFAULT_DEVICE_UNAUTH_TIMEOUT);
   \   00005E                ; Setup parameters for call to function osal_start_timerEx
   \   00005E   90....       MOV       DPTR,#__Constant_bb8
   \   000061   02....       LJMP      ??bdb_ProcessOSALMsg_8 & 0xFFFF
   3063                      }
   3064                      else
   3065                      {
   3066                        if ( (NLME_GetShortAddr() != INVALID_NODE_ADDR) ||
   3067                             (_NIB.nwkDevAddress != INVALID_NODE_ADDR) )
   \                     ??bdb_ProcessOSALMsg_7:
   \   000064                ; Setup parameters for call to function NLME_GetShortAddr
   \   000064   12....       LCALL     `??NLME_GetShortAddr::?relay`; Banked call to: NLME_GetShortAddr
   \   000067   74FE         MOV       A,#-0x2
   \   000069   6A           XRL       A,R2
   \   00006A   7003         JNZ       ??bdb_ProcessOSALMsg_9
   \   00006C   74FF         MOV       A,#-0x1
   \   00006E   6B           XRL       A,R3
   \                     ??bdb_ProcessOSALMsg_9:
   \   00006F   700D         JNZ       ??bdb_ProcessOSALMsg_10
   \   000071   90....       MOV       DPTR,#_NIB + 20
   \   000074   E0           MOVX      A,@DPTR
   \   000075   64FE         XRL       A,#0xfe
   \   000077   7003         JNZ       ??bdb_ProcessOSALMsg_11
   \   000079   A3           INC       DPTR
   \   00007A   E0           MOVX      A,@DPTR
   \   00007B   F4           CPL       A
   \                     ??bdb_ProcessOSALMsg_11:
   \   00007C   601D         JZ        ??bdb_ProcessOSALMsg_12
   3068                        {
   3069                          uint16 addr = INVALID_NODE_ADDR;
   \                     ??bdb_ProcessOSALMsg_10:
   \   00007E   7407         MOV       A,#0x7
   \   000080   12....       LCALL     ?XSTACK_DISP0_8
   \   000083   74FE         MOV       A,#-0x2
   \   000085   F0           MOVX      @DPTR,A
   \   000086   A3           INC       DPTR
   \   000087   04           INC       A
   \   000088   F0           MOVX      @DPTR,A
   3070                          // Invalidate nwk addr so end device does not use in its data reqs.
   3071                          _NIB.nwkDevAddress = INVALID_NODE_ADDR;
   \   000089   90....       MOV       DPTR,#_NIB + 20
   \   00008C   14           DEC       A
   \   00008D   F0           MOVX      @DPTR,A
   \   00008E   A3           INC       DPTR
   \   00008F   04           INC       A
   \   000090   F0           MOVX      @DPTR,A
   3072                          ZMacSetReq( ZMacShortAddress, (uint8 *)&addr );
   \   000091                ; Setup parameters for call to function ZMacSetReq
   \   000091   7407         MOV       A,#0x7
   \   000093   12....       LCALL     ?XSTACK_DISP101_8
   \   000096   7953         MOV       R1,#0x53
   \   000098   12....       LCALL     `??ZMacSetReq::?relay`; Banked call to: ZMacSetReq
   3073                        }
   3074          
   3075                        //Clear the neighbor Table and network discovery tables.
   3076                        nwkNeighborInitTable();
   \                     ??bdb_ProcessOSALMsg_12:
   \   00009B                ; Setup parameters for call to function nwkNeighborInitTable
   \   00009B   12....       LCALL     `??nwkNeighborInitTable::?relay`; Banked call to: nwkNeighborInitTable
   3077                        NLME_NwkDiscTerm();
   \   00009E                ; Setup parameters for call to function NLME_NwkDiscTerm
   \   00009E   12....       LCALL     `??NLME_NwkDiscTerm::?relay`; Banked call to: NLME_NwkDiscTerm
   3078                        _NIB.nwkState = NWK_INIT;
   \   0000A1   90....       MOV       DPTR,#_NIB + 35
   \   0000A4   E4           CLR       A
   \   0000A5   F0           MOVX      @DPTR,A
   3079          
   3080                        bdb_tryNwkAssoc();
   \   0000A6                ; Setup parameters for call to function bdb_tryNwkAssoc
   \                     ??bdb_ProcessOSALMsg_6:
   \   0000A6   12....       LCALL     `??bdb_tryNwkAssoc::?relay`; Banked call to: bdb_tryNwkAssoc
   \   0000A9   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3081                      }
   3082                    break;
   3083                  }
   3084                }
   3085              break;
   3086          
   3087              case BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE:
   3088                if(ZG_DEVICE_JOINING_TYPE)
   \                     ??bdb_ProcessOSALMsg_0:
   \   0000AC   90....       MOV       DPTR,#zgDeviceLogicalType
   \   0000AF   E0           MOVX      A,@DPTR
   \   0000B0   6401         XRL       A,#0x1
   \   0000B2   6008         JZ        ??bdb_ProcessOSALMsg_13
   \   0000B4   E0           MOVX      A,@DPTR
   \   0000B5   6402         XRL       A,#0x2
   \   0000B7   6003         JZ        $+5
   \   0000B9   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3089                {
   3090                  if(msgPtr->hdr.status != BDB_MSG_EVENT_SUCCESS)
   \                     ??bdb_ProcessOSALMsg_13:
   \   0000BC   8A82         MOV       DPL,R2
   \   0000BE   8B83         MOV       DPH,R3
   \   0000C0   A3           INC       DPTR
   \   0000C1   E0           MOVX      A,@DPTR
   \   0000C2   6011         JZ        ??bdb_ProcessOSALMsg_14
   3091                  {
   3092                    bdbAttributes.bdbTCLinkKeyExchangeAttempts++;
   \   0000C4   90....       MOV       DPTR,#bdbAttributes + 16
   \   0000C7   E0           MOVX      A,@DPTR
   \   0000C8   04           INC       A
   \   0000C9   F0           MOVX      @DPTR,A
   3093                    if(bdbAttributes.bdbTCLinkKeyExchangeAttempts > bdbAttributes.bdbTCLinkKeyExchangeAttemptsMax)
   \   0000CA   F8           MOV       R0,A
   \   0000CB   A3           INC       DPTR
   \   0000CC   E0           MOVX      A,@DPTR
   \   0000CD   C3           CLR       C
   \   0000CE   98           SUBB      A,R0
   \   0000CF   5004         JNC       ??bdb_ProcessOSALMsg_14
   3094                    {
   3095                      //TCLK process fail due to many attempts fails
   3096                      bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE, FALSE);
   \   0000D1                ; Setup parameters for call to function bdb_reportCommissioningState
   \   0000D1   7A00         MOV       R2,#0x0
   \   0000D3   806D         SJMP      ??bdb_ProcessOSALMsg_15
   3097                      return;
   3098                    }
   3099                  }
   3100                  switch(bdbCommissioningProcedureState.bdbTCExchangeState)
   \                     ??bdb_ProcessOSALMsg_14:
   \   0000D5   90....       MOV       DPTR,#bdbCommissioningProcedureState + 1
   \   0000D8   E0           MOVX      A,@DPTR
   \   0000D9   14           DEC       A
   \   0000DA   600C         JZ        ??bdb_ProcessOSALMsg_16
   \   0000DC   14           DEC       A
   \   0000DD   606A         JZ        ??bdb_ProcessOSALMsg_17
   \   0000DF   14           DEC       A
   \   0000E0   7003         JNZ       $+5
   \   0000E2   02....       LJMP      ??bdb_ProcessOSALMsg_18 & 0xFFFF
   \   0000E5   02....       LJMP      ??bdb_ProcessOSALMsg_1 & 0xFFFF
   3101                  {
   3102                    case BDB_REQ_TC_STACK_VERSION:
   3103                      bdb_requestTCStackVersion();
   \                     ??bdb_ProcessOSALMsg_16:
   \   0000E8   90....       MOV       DPTR,#requestNewTrustCenterLinkKey
   \   0000EB   E0           MOVX      A,@DPTR
   \   0000EC   604D         JZ        ??bdb_ProcessOSALMsg_19
   \   0000EE                ; Setup parameters for call to function APSME_IsDistributedSecurity
   \   0000EE   12....       LCALL     `??APSME_IsDistributedSecurity::?relay`; Banked call to: APSME_IsDistributedSecurity
   \   0000F1   E9           MOV       A,R1
   \   0000F2   7043         JNZ       ??bdb_ProcessOSALMsg_20
   \   0000F4   90....       MOV       DPTR,#bdbAttributes + 18
   \   0000F7   E0           MOVX      A,@DPTR
   \   0000F8   702D         JNZ       ??bdb_ProcessOSALMsg_21
   \   0000FA   7419         MOV       A,#0x19
   \   0000FC   12....       LCALL     ?XSTACK_DISP0_8
   \   0000FF   7402         MOV       A,#0x2
   \   000101   F0           MOVX      @DPTR,A
   \   000102   7411         MOV       A,#0x11
   \   000104   12....       LCALL     ?XSTACK_DISP0_8
   \   000107   E4           CLR       A
   \   000108   F0           MOVX      @DPTR,A
   \   000109   A3           INC       DPTR
   \   00010A   F0           MOVX      @DPTR,A
   \   00010B                ; Setup parameters for call to function ZDP_NWKAddrOfInterestReq
   \   00010B   F5..         MOV       ?V0,A
   \   00010D   78..         MOV       R0,#?V0
   \   00010F   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000112   7902         MOV       R1,#0x2
   \   000114   7C00         MOV       R4,#0x0
   \   000116   7D00         MOV       R5,#0x0
   \   000118   7412         MOV       A,#0x12
   \   00011A   12....       LCALL     ?XSTACK_DISP101_8
   \   00011D   12....       LCALL     `??ZDP_NWKAddrOfInterestReq::?relay`; Banked call to: ZDP_NWKAddrOfInterestReq
   \   000120   7401         MOV       A,#0x1
   \   000122   12....       LCALL     ?DEALLOC_XSTACK8
   \   000125                ; Setup parameters for call to function osal_stop_timerEx
   \   000125   806D         SJMP      ??bdb_ProcessOSALMsg_22
   \                     ??bdb_ProcessOSALMsg_21:
   \   000127   90....       MOV       DPTR,#pfnCBKETCLinkKeyExchange
   \   00012A   12....       LCALL     ??Subroutine52_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_106:
   \   00012D   6078         JZ        ??bdb_ProcessOSALMsg_1
   \   00012F                ; Setup parameters for indirect call
   \   00012F   12....       LCALL     ??Subroutine51_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_86:
   \   000132   12....       LCALL     ?CALL_IND
   \   000135   8070         SJMP      ??bdb_ProcessOSALMsg_1
   \                     ??bdb_ProcessOSALMsg_20:
   \   000137                ; Setup parameters for call to function bdb_setNodeJoinLinkKeyType
   \   000137   7901         MOV       R1,#0x1
   \   000139   8002         SJMP      ??bdb_ProcessOSALMsg_23
   \                     ??bdb_ProcessOSALMsg_19:
   \   00013B                ; Setup parameters for call to function bdb_setNodeJoinLinkKeyType
   \   00013B   7900         MOV       R1,#0x0
   \                     ??bdb_ProcessOSALMsg_23:
   \   00013D   12....       LCALL     `??bdb_setNodeJoinLinkKeyType::?relay`; Banked call to: bdb_setNodeJoinLinkKeyType
   \   000140                ; Setup parameters for call to function bdb_reportCommissioningState
   \   000140   7A01         MOV       R2,#0x1
   \                     ??bdb_ProcessOSALMsg_15:
   \   000142   7901         MOV       R1,#0x1
   \   000144   12....       LCALL     `??bdb_reportCommissioningState::?relay`; Banked call to: bdb_reportCommissioningState
   \   000147   805E         SJMP      ??bdb_ProcessOSALMsg_1
   3104                    break;
   3105                    case BDB_REQ_TC_LINK_KEY:
   3106                      bdb_requestTCLinkKey();
   \                     ??bdb_ProcessOSALMsg_17:
   \   000149   7403         MOV       A,#0x3
   \   00014B   12....       LCALL     ?XSTACK_DISP0_8
   \   00014E   E4           CLR       A
   \   00014F   F0           MOVX      @DPTR,A
   \   000150   7404         MOV       A,#0x4
   \   000152   12....       LCALL     ?XSTACK_DISP0_8
   \   000155   7404         MOV       A,#0x4
   \   000157   F0           MOVX      @DPTR,A
   \   000158                ; Setup parameters for call to function APSME_RequestKeyReq
   \   000158   14           DEC       A
   \   000159   12....       LCALL     ?XSTACK_DISP101_8
   \   00015C   12....       LCALL     `??APSME_RequestKeyReq::?relay`; Banked call to: APSME_RequestKeyReq
   \   00015F                ; Setup parameters for call to function osal_stop_timerEx
   \   00015F   12....       LCALL     ?Subroutine17 & 0xFFFF
   \                     ??CrossCallReturnLabel_69:
   \   000162                ; Setup parameters for call to function osal_start_timerEx
   \   000162   90....       MOV       DPTR,#requestLinkKeyTimeout
   \   000165   8033         SJMP      ??bdb_ProcessOSALMsg_8
   3107                    break;
   3108                    case BDB_REQ_VERIFY_TC_LINK_KEY:
   3109                      bdb_requestVerifyTCLinkKey();
   \                     ??bdb_ProcessOSALMsg_18:
   \   000167                ; Setup parameters for call to function APSME_GetRequest
   \   000167   7409         MOV       A,#0x9
   \   000169   12....       LCALL     ?XSTACK_DISP102_8
   \   00016C   7A00         MOV       R2,#0x0
   \   00016E   7B00         MOV       R3,#0x0
   \   000170   79AB         MOV       R1,#-0x55
   \   000172   12....       LCALL     `??APSME_GetRequest::?relay`; Banked call to: APSME_GetRequest
   \   000175   7409         MOV       A,#0x9
   \   000177   12....       LCALL     ?XSTACK_DISP100_8
   \   00017A   85..82       MOV       DPL,?XSP + 0
   \   00017D   85..83       MOV       DPH,?XSP + 1
   \   000180   E8           MOV       A,R0
   \   000181   F0           MOVX      @DPTR,A
   \   000182   A3           INC       DPTR
   \   000183   E9           MOV       A,R1
   \   000184   F0           MOVX      @DPTR,A
   \   000185   7402         MOV       A,#0x2
   \   000187   12....       LCALL     ?XSTACK_DISP0_8
   \   00018A   7404         MOV       A,#0x4
   \   00018C   F0           MOVX      @DPTR,A
   \   00018D                ; Setup parameters for call to function APSME_VerifyKeyReq
   \   00018D   AA..         MOV       R2,?XSP + 0
   \   00018F   AB..         MOV       R3,?XSP + 1
   \   000191   12....       LCALL     `??APSME_VerifyKeyReq::?relay`; Banked call to: APSME_VerifyKeyReq
   \   000194                ; Setup parameters for call to function osal_stop_timerEx
   \                     ??bdb_ProcessOSALMsg_22:
   \   000194   12....       LCALL     ?Subroutine17 & 0xFFFF
   \                     ??CrossCallReturnLabel_70:
   \   000197                ; Setup parameters for call to function osal_start_timerEx
   \   000197   90....       MOV       DPTR,#__Constant_1388
   \                     ??bdb_ProcessOSALMsg_8:
   \   00019A   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   00019D   7A00         MOV       R2,#0x0
   \   00019F   7B10         MOV       R3,#0x10
   \   0001A1   12....       LCALL     ??Subroutine56_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_135:
   \   0001A4   12....       LCALL     ?DEALLOC_XSTACK8
   3110                    break;
   3111                  }
   3112                }
   3113             break;
   3114          #endif
   3115             }
   3116          }
   \                     ??bdb_ProcessOSALMsg_1:
   \   0001A7   741A         MOV       A,#0x1a
   \   0001A9   02....       LJMP      ??Subroutine59_0 & 0xFFFF
   3117          
   3118          
   3119          /*********************************************************************
   3120           * @fn      bdb_processTimeout
   3121           *
   3122           * @brief   Handles timeout of the bdb process
   3123           *
   3124           * @param   msgPtr - message to process
   3125           *
   3126           * @return  none
   3127           */
   3128          void bdb_processTimeout(void)
   3129          {
   3130          #if (ZG_BUILD_JOINING_TYPE)
   3131            if(ZG_DEVICE_JOINING_TYPE)
   3132            {
   3133              switch(bdbCommissioningProcedureState.bdbCommissioningState)
   3134              {
   3135                case BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE:
   3136          
   3137                  bdb_tcLinkKeyExchangeAttempt(FALSE,bdbCommissioningProcedureState.bdbTCExchangeState);
   3138                break;
   3139                case BDB_COMMISSIONING_STATE_JOINING:
   3140                  if(bdbCommissioningProcedureState.bdbJoinState == BDB_JOIN_STATE_WAITING_NWK_KEY)
   3141                  {
   3142                    //If nwk key fails, then try association again
   3143                    bdbCommissioningProcedureState.bdbJoinState = BDB_JOIN_STATE_ASSOC;
   3144                    bdb_nwkAssocAttemt(FALSE);
   3145                  }
   3146                break;
   3147              }
   3148            }
   3149          #endif
   3150          
   3151          }
   3152          
   3153          
   3154          /*********************************************************************
   3155           * @fn      bdb_SendMsg
   3156           *
   3157           * @brief   Send messages to bdb processing with the expected format
   3158           *
   3159           * @param   msgPtr - message to process
   3160           *
   3161           * @return  none
   3162           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3163          void bdb_SendMsg(uint8 taskID, uint8 toCommissioningState,uint8 status, uint8 len, uint8 *buf)
   \                     bdb_SendMsg:
   3164          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V5
   \   000000                REQUIRE ?V6
   \   000000                REQUIRE ?V7
   \   000000                REQUIRE ?V8
   \   000000   74EF         MOV       A,#-0x11
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 17
   \   000005                ; Auto size: 0
   \   000005   89..         MOV       ?V2,R1
   \   000007   8A..         MOV       ?V7,R2
   \   000009   8B..         MOV       ?V8,R3
   \   00000B   8C..         MOV       ?V3,R4
   3165            bdbInMsg_t *msgPtr = NULL;
   3166          
   3167            if ( (len > 0) && (buf != NULL) )
   \   00000D   EC           MOV       A,R4
   \   00000E   6058         JZ        ??bdb_SendMsg_0
   \   000010   7411         MOV       A,#0x11
   \   000012   12....       LCALL     ?XSTACK_DISP0_8
   \   000015   12....       LCALL     ?Subroutine23 & 0xFFFF
   \                     ??CrossCallReturnLabel_22:
   \   000018   E5..         MOV       A,?V0
   \   00001A   45..         ORL       A,?V1
   \   00001C   604A         JZ        ??bdb_SendMsg_0
   3168            {
   3169              uint8 tmpLength;
   3170              tmpLength = len;
   3171              tmpLength += sizeof(osal_event_hdr_t);
   3172          
   3173              msgPtr = (bdbInMsg_t *)osal_msg_allocate( tmpLength );
   \   00001E                ; Setup parameters for call to function osal_msg_allocate
   \   00001E   7402         MOV       A,#0x2
   \   000020   2C           ADD       A,R4
   \   000021   FA           MOV       R2,A
   \   000022   7B00         MOV       R3,#0x0
   \   000024   12....       LCALL     `??osal_msg_allocate::?relay`; Banked call to: osal_msg_allocate
   \   000027   8A..         MOV       ?V4,R2
   \   000029   8B..         MOV       ?V5,R3
   \   00002B   AE..         MOV       R6,?V4
   \   00002D   AF..         MOV       R7,?V5
   3174          
   3175              if ( msgPtr )
   \   00002F   EA           MOV       A,R2
   \   000030   4F           ORL       A,R7
   \   000031   6035         JZ        ??bdb_SendMsg_0
   3176              {
   3177                osal_memcpy( msgPtr->buf, buf, len );
   \   000033                ; Setup parameters for call to function osal_memcpy
   \   000033   85....       MOV       ?V4,?V0
   \   000036   85....       MOV       ?V5,?V1
   \   000039   75..00       MOV       ?V6,#0x0
   \   00003C   78..         MOV       R0,#?V4
   \   00003E   12....       LCALL     ?PUSH_XSTACK_I_THREE
   \   000041   AC..         MOV       R4,?V3
   \   000043   7D00         MOV       R5,#0x0
   \   000045   EA           MOV       A,R2
   \   000046   2402         ADD       A,#0x2
   \   000048   FA           MOV       R2,A
   \   000049   E4           CLR       A
   \   00004A   3F           ADDC      A,R7
   \   00004B   FB           MOV       R3,A
   \   00004C   12....       LCALL     `??osal_memcpy::?relay`; Banked call to: osal_memcpy
   \   00004F   7403         MOV       A,#0x3
   \   000051   12....       LCALL     ?DEALLOC_XSTACK8
   3178          
   3179                msgPtr->hdr.event = toCommissioningState;
   \   000054   8E82         MOV       DPL,R6
   \   000056   8F83         MOV       DPH,R7
   \   000058   E5..         MOV       A,?V7
   \   00005A   F0           MOVX      @DPTR,A
   3180                msgPtr->hdr.status = status;
   \   00005B   A3           INC       DPTR
   \   00005C   E5..         MOV       A,?V8
   \   00005E   F0           MOVX      @DPTR,A
   3181                osal_msg_send( taskID, (uint8 *)msgPtr );
   \   00005F                ; Setup parameters for call to function osal_msg_send
   \   00005F   EE           MOV       A,R6
   \   000060   FA           MOV       R2,A
   \   000061   EF           MOV       A,R7
   \   000062   FB           MOV       R3,A
   \   000063   A9..         MOV       R1,?V2
   \   000065   12....       LCALL     `??osal_msg_send::?relay`; Banked call to: osal_msg_send
   3182              }
   3183            }
   3184          }
   \                     ??bdb_SendMsg_0:
   \   000068   7F09         MOV       R7,#0x9
   \   00006A   02....       LJMP      ?BANKED_LEAVE_XDATA
   3185          
   3186          
   3187          /*********************************************************************
   3188           * @fn      bdb_RegisterCommissioningStatusCB
   3189           *
   3190           * @brief   Register a callback in which the status of the procedures done in
   3191           *          BDB commissioning process will be reported
   3192           *
   3193           * @param   bdbGCB_CommissioningStatus - application callback
   3194           *
   3195           * @return  none
   3196           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3197          void bdb_RegisterCommissioningStatusCB(bdbGCB_CommissioningStatus_t bdbGCB_CommissioningStatus)
   \                     bdb_RegisterCommissioningStatusCB:
   3198          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   3199            pfnCommissioningStatusCB = bdbGCB_CommissioningStatus;
   \   000004   90....       MOV       DPTR,#pfnCommissioningStatusCB
   \   000007   02....       LJMP      ?Subroutine3 & 0xFFFF
   3200          }
   3201          
   3202          /*********************************************************************
   3203           * @fn      bdb_ClearNetworkParams
   3204           *
   3205           * @brief   Restore nwk parameters to invalid if the device is not on a network
   3206           *
   3207           * @param   void
   3208           *
   3209           * @return  void
   3210           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3211          void bdb_ClearNetworkParams(void)
   \                     bdb_ClearNetworkParams:
   3212          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
   3213          #if (BDB_TOUCHLINK_CAPABILITY_ENABLED == TRUE)
   3214            if ( bdbAttributes.bdbNodeIsOnANetwork == FALSE )
   3215            {
   3216              //Clear the event
   3217              _NIB.nwkPanId = INVALID_NODE_ADDR;
   3218              _NIB.nwkLogicalChannel = 0;
   3219              _NIB.nwkDevAddress = INVALID_NODE_ADDR;
   3220              touchLink_SetMacNwkParams( _NIB.nwkDevAddress, _NIB.nwkPanId, _NIB.nwkLogicalChannel );
   3221            }
   3222          #endif
   3223          }
   \   000000   02....       LJMP      ?BRET
   3224          
   3225          /*********************************************************************
   3226           * @fn      bdb_getZCLFrameCounter
   3227           *
   3228           * @brief   Get the next ZCL Frame Counter for packet sequence number
   3229           *
   3230           * @param   none
   3231           *
   3232           * @return  next ZCL frame counter
   3233           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3234          uint8 bdb_getZCLFrameCounter(void)
   \                     bdb_getZCLFrameCounter:
   3235          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   3236            bdb_ZclTransactionSequenceNumber++;
   \   000004   90....       MOV       DPTR,#bdb_ZclTransactionSequenceNumber
   \   000007   E0           MOVX      A,@DPTR
   \   000008   04           INC       A
   \   000009   F0           MOVX      @DPTR,A
   3237            return bdb_ZclTransactionSequenceNumber;
   \   00000A   F9           MOV       R1,A
   \   00000B   02....       LJMP      ??Subroutine42_0 & 0xFFFF
   3238          
   3239          }
   3240          
   3241          
   3242          #if (ZG_BUILD_JOINING_TYPE)
   3243          /*********************************************************************
   3244           * @fn      bdb_RegisterCBKETCLinkKeyExchangeCB
   3245           *
   3246           * @brief   Register a callback in which the TC link key exchange procedure will
   3247           *          be performed by application.
   3248           *          Upon fail or success bdb must be notified, see bdb_CBKETCLinkKeyExchangeAttempt
   3249           *
   3250           * @param   bdbGCB_TCLinkKeyExchangeMethod - application callback
   3251           *
   3252           * @return  none
   3253           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3254          void bdb_RegisterCBKETCLinkKeyExchangeCB(bdbGCB_CBKETCLinkKeyExchange_t bdbGCB_CBKETCLinkKeyExchange)
   \                     bdb_RegisterCBKETCLinkKeyExchangeCB:
   3255          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   3256            if(bdbGCB_CBKETCLinkKeyExchange)
   \   000004   EA           MOV       A,R2
   \   000005   4B           ORL       A,R3
   \   000006   90....       MOV       DPTR,#pfnCBKETCLinkKeyExchange
   \   000009   600A         JZ        ??bdb_RegisterCBKETCLinkKeyExchangeCB_0
   3257            {
   3258              pfnCBKETCLinkKeyExchange = bdbGCB_CBKETCLinkKeyExchange;
   \   00000B   12....       LCALL     ??Subroutine62_0 & 0xFFFF
   3259              bdbAttributes.bdbTCLinkKeyExchangeMethod = BDB_TC_LINK_KEY_EXCHANGE_CBKE;
   \                     ??CrossCallReturnLabel_159:
   \   00000E   90....       MOV       DPTR,#bdbAttributes + 18
   \   000011   7401         MOV       A,#0x1
   \   000013   8007         SJMP      ??bdb_RegisterCBKETCLinkKeyExchangeCB_1
   3260            }
   3261            else
   3262            {
   3263              pfnCBKETCLinkKeyExchange = NULL;
   \                     ??bdb_RegisterCBKETCLinkKeyExchangeCB_0:
   \   000015   E4           CLR       A
   \   000016   F0           MOVX      @DPTR,A
   \   000017   A3           INC       DPTR
   \   000018   F0           MOVX      @DPTR,A
   3264              bdbAttributes.bdbTCLinkKeyExchangeMethod = BDB_TC_LINK_KEY_EXCHANGE_APS_KEY;
   \   000019   90....       MOV       DPTR,#bdbAttributes + 18
   3265            }
   \                     ??bdb_RegisterCBKETCLinkKeyExchangeCB_1:
   \   00001C   02....       LJMP      ??Subroutine41_0 & 0xFFFF
   3266          }
   3267          
   3268          /*********************************************************************
   3269           * @fn      bdb_RegisterForFilterNwkDescCB
   3270           *
   3271           * @brief   Register a callback in which the application gets the list of network
   3272           *          descriptors got from active scan.
   3273           *          Use bdb_nwkDescFree to release the network descriptors that are not
   3274           *          of interest and leave those which are to be attempted.
   3275           *
   3276           * @param   bdbGCB_FilterNwkDesc - application callback
   3277           *
   3278           * @return  none
   3279           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3280          void bdb_RegisterForFilterNwkDescCB(bdbGCB_FilterNwkDesc_t bdbGCB_FilterNwkDesc)
   \                     bdb_RegisterForFilterNwkDescCB:
   3281          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   3282            if(bdbGCB_FilterNwkDesc)
   \   000004   EA           MOV       A,R2
   \   000005   4B           ORL       A,R3
   \   000006   6006         JZ        ??CrossCallReturnLabel_160
   3283            {
   3284              pfnFilterNwkDesc = bdbGCB_FilterNwkDesc;
   \   000008   90....       MOV       DPTR,#pfnFilterNwkDesc
   \   00000B   12....       LCALL     ??Subroutine62_0 & 0xFFFF
   3285            }
   3286          }
   \                     ??CrossCallReturnLabel_160:
   \   00000E   02....       LJMP      ??Subroutine42_0 & 0xFFFF
   3287          
   3288          
   3289          /*********************************************************************
   3290           * @fn          bdb_CBKETCLinkKeyExchangeAttempt
   3291           *
   3292           * @brief       Tell BDB module the result of the TC link key exchange, to try
   3293           *              the default process or to keep going with the joining process.
   3294           *
   3295           * @param       didSuccess - TRUE if the process was succes, False otherwise
   3296           *
   3297           * @return      unprocessed events
   3298           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3299          void bdb_CBKETCLinkKeyExchangeAttempt(bool didSuccess)
   \                     bdb_CBKETCLinkKeyExchangeAttempt:
   3300          {
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV       A,R1
   3301            if(didSuccess)
   \   000006   6005         JZ        ??bdb_CBKETCLinkKeyExchangeAttempt_0
   3302            {
   3303              bdb_setNodeJoinLinkKeyType(BDB_DEFAULT_GLOBAL_TRUST_CENTER_LINK_KEY);
   \   000008                ; Setup parameters for call to function bdb_setNodeJoinLinkKeyType
   \   000008   12....       LCALL     ?Subroutine34 & 0xFFFF
   3304              bdb_reportCommissioningState(BDB_COMMISSIONING_STATE_TC_LINK_KEY_EXCHANGE, TRUE);
   3305            }
   \                     ??CrossCallReturnLabel_44:
   \   00000B   8012         SJMP      ??bdb_CBKETCLinkKeyExchangeAttempt_1
   3306            else
   3307            {
   3308              bdbAttributes.bdbTCLinkKeyExchangeMethod = BDB_TC_LINK_KEY_EXCHANGE_APS_KEY;
   \                     ??bdb_CBKETCLinkKeyExchangeAttempt_0:
   \   00000D   90....       MOV       DPTR,#bdbAttributes + 18
   \   000010   E4           CLR       A
   \   000011   F0           MOVX      @DPTR,A
   3309              //We are going back one state to try it again
   3310              bdbCommissioningProcedureState.bdbTCExchangeState -= BDB_TC_EXCHANGE_NEXT_STATE;
   \   000012   90....       MOV       DPTR,#bdbCommissioningProcedureState + 1
   \   000015   E0           MOVX      A,@DPTR
   \   000016   14           DEC       A
   \   000017   F0           MOVX      @DPTR,A
   3311              bdb_tcLinkKeyExchangeAttempt(TRUE,BDB_REQ_TC_STACK_VERSION);
   \   000018                ; Setup parameters for call to function bdb_tcLinkKeyExchangeAttempt
   \   000018   7A01         MOV       R2,#0x1
   \   00001A   7901         MOV       R1,#0x1
   \   00001C   12....       LCALL     `??bdb_tcLinkKeyExchangeAttempt::?relay`; Banked call to: bdb_tcLinkKeyExchangeAttempt
   3312            }
   3313          
   3314          }
   \                     ??bdb_CBKETCLinkKeyExchangeAttempt_1:
   \   00001F   02....       LJMP      ?Subroutine0 & 0xFFFF
   3315          #endif
   3316          
   3317          #if !defined (DISABLE_GREENPOWER_BASIC_PROXY) && (ZG_BUILD_RTR_TYPE)
   3318          
   3319          /*********************************************************************
   3320           * @fn      gp_ChangeChannelReq
   3321           *
   3322           * @brief   Callback function to notify the BDB about a GP commissioning
   3323           * request that will change the current channel for at most
   3324           * gpBirectionalCommissioningChangeChannelTimeout ms
   3325           *
   3326           * @param   channel - Channel in which the commissioning will take place
   3327           *
   3328           * @return  TRUE to allow change channel, FALSE to do not allow
   3329           */
   3330          static uint8 gp_ChangeChannelReq(void)
   3331          {
   3332            uint8 allowChangeChannel = TRUE;
   3333          
   3334            //Do not allow changes of channel if any process is in place
   3335            if(bdbAttributes.bdbCommissioningMode)
   3336            {
   3337              allowChangeChannel = FALSE;
   3338            }
   3339          
   3340            //Check application state to decide if allow change channel or not
   3341          
   3342            return allowChangeChannel;
   3343          }
   3344          
   3345          
   3346          /*********************************************************************
   3347           * @fn          gp_CBInit
   3348           *
   3349           * @brief       Register the callbacks for GP endpoint
   3350           *
   3351           * @param       none
   3352           *
   3353           * @return      none
   3354           */
   3355          void gp_CBInit(void)
   3356          {
   3357            GP_DataCnfGCB = GP_DataCnf;
   3358            GP_endpointInitGCB = gp_endpointInit;
   3359            GP_expireDuplicateFilteringGCB = gp_expireDuplicateFiltering;
   3360            GP_stopCommissioningModeGCB = gp_stopCommissioningMode;
   3361            GP_returnOperationalChannelGCB = gp_returnOperationalChannel;
   3362            GP_DataIndGCB = GP_DataInd;
   3363            GP_SecReqGCB = GP_SecReq;
   3364            GP_CheckAnnouncedDeviceGCB = gp_CheckAnnouncedDevice;
   3365          
   3366            GP_aliasConflictAnnce = &aliasConflictAnnce;
   3367          
   3368            GP_endpointInitGCB();
   3369          }
   3370          
   3371          #endif
   3372          
   3373          /*********************************************************************
   3374          *********************************************************************/
   3375          
   3376          
   3377          /******************************************************************************
   3378           * @fn          bdb_GenerateInstallCodeCRC
   3379           *
   3380           * @brief       Creates a CRC for the install code passed.
   3381           *
   3382           * @param       installCode - install code from which CRC will be generated
   3383           *
   3384           * @return      CRC
   3385           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3386          uint16 bdb_GenerateInstallCodeCRC(uint8 *installCode)
   \                     bdb_GenerateInstallCodeCRC:
   3387          {
   \   000000   C082         PUSH      DPL
   \   000002   C083         PUSH      DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 2
   \   000004   74FE         MOV       A,#-0x2
   \   000006   12....       LCALL     ?ALLOC_XSTACK8
   3388            uint16 CRC;
   3389          
   3390            bdb_calculateCCITT_CRC(installCode, INSTALL_CODE_LEN, &CRC);
   \   000009                ; Setup parameters for call to function bdb_calculateCCITT_CRC
   \   000009   90....       MOV       DPTR,#__Constant_10
   \   00000C   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   00000F   7404         MOV       A,#0x4
   \   000011   12....       LCALL     ?XSTACK_DISP102_8
   \   000014   12....       LCALL     `??bdb_calculateCCITT_CRC::?relay`; Banked call to: bdb_calculateCCITT_CRC
   \   000017   7404         MOV       A,#0x4
   \   000019   12....       LCALL     ?DEALLOC_XSTACK8
   3391          
   3392            return CRC;
   \   00001C   85..82       MOV       DPL,?XSP + 0
   \   00001F   85..83       MOV       DPH,?XSP + 1
   \   000022   12....       LCALL     ??Subroutine61_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_146:
   \   000025   7402         MOV       A,#0x2
   \   000027   02....       LJMP      ?Subroutine4 & 0xFFFF
   3393          }
   3394          
   3395          /******************************************************************************
   3396           * @fn          bdb_calculateCCITT_CRC
   3397           *
   3398           * @brief       Creates a CRC for the install code passed.
   3399           *
   3400           * @param       Mb - install code from which CRC will be generated
   3401           * @param       msglen - install code length
   3402           * @param       crc -
   3403           *
   3404           * @return      none
   3405           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3406          void bdb_calculateCCITT_CRC (uint8 *Mb, uint32 msglen, uint16 *crc)
   \                     bdb_calculateCCITT_CRC:
   3407          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 4
   \   000005   74FC         MOV       A,#-0x4
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   EA           MOV       A,R2
   \   00000B   FE           MOV       R6,A
   \   00000C   EB           MOV       A,R3
   \   00000D   FF           MOV       R7,A
   \   00000E   8C..         MOV       ?V0,R4
   \   000010   8D..         MOV       ?V1,R5
   3408            uint16 crcinit_direct;
   3409            uint16 crcinit_nondirect;
   3410            bdb_crcInit(crc, &crcinit_direct, &crcinit_nondirect);
   \   000012                ; Setup parameters for call to function bdb_crcInit
   \   000012   A8..         MOV       R0,?XSP + 0
   \   000014   A9..         MOV       R1,?XSP + 1
   \   000016   88..         MOV       ?V2,R0
   \   000018   89..         MOV       ?V3,R1
   \   00001A   78..         MOV       R0,#?V2
   \   00001C   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   00001F   7404         MOV       A,#0x4
   \   000021   12....       LCALL     ?XSTACK_DISP102_8
   \   000024   AA..         MOV       R2,?V0
   \   000026   AB..         MOV       R3,?V1
   \   000028   12....       LCALL     `??bdb_crcInit::?relay`; Banked call to: bdb_crcInit
   \   00002B   7402         MOV       A,#0x2
   \   00002D   12....       LCALL     ?DEALLOC_XSTACK8
   3411            *crc = bdb_crcBitByBitFast(Mb, msglen, crcinit_direct, crcinit_nondirect);
   \   000030                ; Setup parameters for call to function bdb_crcBitByBitFast
   \   000030   85..82       MOV       DPL,?XSP + 0
   \   000033   85..83       MOV       DPH,?XSP + 1
   \   000036   12....       LCALL     ?PUSH_XSTACK8_X_TWO
   \   000039   7412         MOV       A,#0x12
   \   00003B   12....       LCALL     ?XSTACK_DISP0_8
   \   00003E   12....       LCALL     ?PUSH_XSTACK8_X_FOUR
   \   000041   7408         MOV       A,#0x8
   \   000043   12....       LCALL     ?XSTACK_DISP0_8
   \   000046   12....       LCALL     ?Subroutine27 & 0xFFFF
   \                     ??CrossCallReturnLabel_30:
   \   000049   EE           MOV       A,R6
   \   00004A   FA           MOV       R2,A
   \   00004B   EF           MOV       A,R7
   \   00004C   FB           MOV       R3,A
   \   00004D   12....       LCALL     `??bdb_crcBitByBitFast::?relay`; Banked call to: bdb_crcBitByBitFast
   \   000050   7406         MOV       A,#0x6
   \   000052   12....       LCALL     ?DEALLOC_XSTACK8
   \   000055   85..82       MOV       DPL,?V0
   \   000058   85..83       MOV       DPH,?V1
   \   00005B   12....       LCALL     ??Subroutine62_0 & 0xFFFF
   3412          }
   \                     ??CrossCallReturnLabel_161:
   \   00005E   02....       LJMP      ?Subroutine2 & 0xFFFF
   3413          
   3414          
   3415          /******************************************************************************
   3416           * @fn          bdb_crcInit
   3417           *
   3418           * @brief       Initialize CRC calculation
   3419           *
   3420           * @param       crc -
   3421           * @param       crcinit_direct -
   3422           * @param       crcinit_nondirect -
   3423           *
   3424           * @return      none
   3425           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3426          void bdb_crcInit(uint16 *crc, uint16 *crcinit_direct, uint16 *crcinit_nondirect)
   \                     bdb_crcInit:
   3427          {
   \   000000   74F7         MOV       A,#-0x9
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   3428          
   3429            uint16 i;
   3430            uint16 bit;
   3431          
   3432            *crcinit_direct = CRC_INIT;
   \   000005   8C82         MOV       DPL,R4
   \   000007   8D83         MOV       DPH,R5
   \   000009   74FF         MOV       A,#-0x1
   \   00000B   F0           MOVX      @DPTR,A
   \   00000C   A3           INC       DPTR
   \   00000D   F0           MOVX      @DPTR,A
   3433            *crc = CRC_INIT;
   \   00000E   8A82         MOV       DPL,R2
   \   000010   8B83         MOV       DPH,R3
   \   000012   F0           MOVX      @DPTR,A
   \   000013   A3           INC       DPTR
   \   000014   F0           MOVX      @DPTR,A
   3434            for (i=0; i<CRC_ORDER; i++)
   \   000015   7E10         MOV       R6,#0x10
   3435            {
   3436              bit = *crc & 1;
   \                     ??bdb_crcInit_0:
   \   000017   8A82         MOV       DPL,R2
   \   000019   8B83         MOV       DPH,R3
   \   00001B   E0           MOVX      A,@DPTR
   \   00001C   F8           MOV       R0,A
   3437              if (bit) *crc^= CRC_POLYNOM;
   \   00001D   A2E0         MOV       C,0xE0 /* A   */.0
   \   00001F   5008         JNC       ??bdb_crcInit_1
   \   000021   6421         XRL       A,#0x21
   \   000023   F0           MOVX      @DPTR,A
   \   000024   A3           INC       DPTR
   \   000025   E0           MOVX      A,@DPTR
   \   000026   6410         XRL       A,#0x10
   \   000028   F0           MOVX      @DPTR,A
   3438              *crc >>= 1;
   \                     ??bdb_crcInit_1:
   \   000029   8A82         MOV       DPL,R2
   \   00002B   8B83         MOV       DPH,R3
   \   00002D   E0           MOVX      A,@DPTR
   \   00002E   FC           MOV       R4,A
   \   00002F   A3           INC       DPTR
   \   000030   E0           MOVX      A,@DPTR
   \   000031   C3           CLR       C
   \   000032   13           RRC       A
   \   000033   FD           MOV       R5,A
   \   000034   EC           MOV       A,R4
   \   000035   13           RRC       A
   \   000036   8A82         MOV       DPL,R2
   \   000038   8B83         MOV       DPH,R3
   \   00003A   F0           MOVX      @DPTR,A
   \   00003B   A3           INC       DPTR
   \   00003C   ED           MOV       A,R5
   \   00003D   F0           MOVX      @DPTR,A
   3439              if (bit) *crc|= CRC_HIGHBIT;
   \   00003E   E8           MOV       A,R0
   \   00003F   A2E0         MOV       C,0xE0 /* A   */.0
   \   000041   5009         JNC       ??bdb_crcInit_2
   \   000043   8A82         MOV       DPL,R2
   \   000045   8B83         MOV       DPH,R3
   \   000047   A3           INC       DPTR
   \   000048   E0           MOVX      A,@DPTR
   \   000049   4480         ORL       A,#0x80
   \   00004B   F0           MOVX      @DPTR,A
   3440            }
   \                     ??bdb_crcInit_2:
   \   00004C   1E           DEC       R6
   \   00004D   EE           MOV       A,R6
   \   00004E   70C7         JNZ       ??bdb_crcInit_0
   3441            *crcinit_nondirect = *crc;
   \   000050   8A82         MOV       DPL,R2
   \   000052   8B83         MOV       DPH,R3
   \   000054   12....       LCALL     ?Subroutine28 & 0xFFFF
   \                     ??CrossCallReturnLabel_34:
   \   000057   7409         MOV       A,#0x9
   \   000059   12....       LCALL     ?XSTACK_DISP0_8
   \   00005C   E0           MOVX      A,@DPTR
   \   00005D   FA           MOV       R2,A
   \   00005E   A3           INC       DPTR
   \   00005F   E0           MOVX      A,@DPTR
   \   000060   F583         MOV       DPH,A
   \   000062   8A82         MOV       DPL,R2
   \   000064   E8           MOV       A,R0
   \   000065   F0           MOVX      @DPTR,A
   \   000066   A3           INC       DPTR
   \   000067   E9           MOV       A,R1
   \   000068   F0           MOVX      @DPTR,A
   3442          
   3443          }
   \   000069   02....       LJMP      ?Subroutine0 & 0xFFFF
   3444          
   3445          
   3446          /******************************************************************************
   3447           * @fn          bdb_crcReflect
   3448           *
   3449           * @brief
   3450           *
   3451           * @param       crc -
   3452           * @param       bitnum -
   3453           *
   3454           * @return      none
   3455           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3456          uint16 bdb_crcReflect (uint16 crc, uint16 bitnum)
   \                     bdb_crcReflect:
   3457          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   3458          
   3459            // reflects the lower 'bitnum' bits of 'crc'
   3460          
   3461            uint16 i, j=1, crcout=0;
   \   000005   7E01         MOV       R6,#0x1
   \   000007   7F00         MOV       R7,#0x0
   \   000009   8F..         MOV       ?V0,R7
   \   00000B   8F..         MOV       ?V1,R7
   3462          
   3463            for (i=(uint16)1<<(bitnum-1); i; i>>=1) {
   \   00000D   8E..         MOV       ?V2,R6
   \   00000F   8F..         MOV       ?V3,R7
   \   000011   EC           MOV       A,R4
   \   000012   14           DEC       A
   \   000013   78..         MOV       R0,#?V2
   \   000015   12....       LCALL     ?S_SHL
   \   000018   A8..         MOV       R0,?V2
   \   00001A   A9..         MOV       R1,?V3
   \   00001C   8022         SJMP      ??bdb_crcReflect_0
   3464              if (crc & i) crcout|=j;
   \                     ??bdb_crcReflect_1:
   \   00001E   EA           MOV       A,R2
   \   00001F   58           ANL       A,R0
   \   000020   FC           MOV       R4,A
   \   000021   EB           MOV       A,R3
   \   000022   59           ANL       A,R1
   \   000023   FD           MOV       R5,A
   \   000024   EC           MOV       A,R4
   \   000025   4D           ORL       A,R5
   \   000026   600A         JZ        ??bdb_crcReflect_2
   \   000028   EE           MOV       A,R6
   \   000029   45..         ORL       A,?V0
   \   00002B   F5..         MOV       ?V0,A
   \   00002D   EF           MOV       A,R7
   \   00002E   45..         ORL       A,?V1
   \   000030   F5..         MOV       ?V1,A
   3465              j<<= 1;
   \                     ??bdb_crcReflect_2:
   \   000032   EE           MOV       A,R6
   \   000033   25E0         ADD       A,0xE0 /* A   */
   \   000035   FE           MOV       R6,A
   \   000036   EF           MOV       A,R7
   \   000037   33           RLC       A
   \   000038   FF           MOV       R7,A
   3466            }
   \   000039   E9           MOV       A,R1
   \   00003A   C3           CLR       C
   \   00003B   13           RRC       A
   \   00003C   F9           MOV       R1,A
   \   00003D   E8           MOV       A,R0
   \   00003E   13           RRC       A
   \   00003F   F8           MOV       R0,A
   \                     ??bdb_crcReflect_0:
   \   000040   E8           MOV       A,R0
   \   000041   49           ORL       A,R1
   \   000042   70DA         JNZ       ??bdb_crcReflect_1
   3467            return (crcout);
   \   000044   AA..         MOV       R2,?V0
   \   000046   AB..         MOV       R3,?V1
   \   000048   02....       LJMP      ??Subroutine50_0 & 0xFFFF
   3468          }
   3469          
   3470          
   3471          /******************************************************************************
   3472           * @fn          bdb_crcBitByBitFast
   3473           *
   3474           * @brief
   3475           *
   3476           * @param       p -
   3477           * @param       len -
   3478           * @param       crcinit_direct -
   3479           * @param       crcinit_nondirect -
   3480           *
   3481           * @return      crc
   3482           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   3483          uint16 bdb_crcBitByBitFast(uint8 * p, uint32 len, uint16 crcinit_direct, uint16 crcinit_nondirect)
   \                     bdb_crcBitByBitFast:
   3484          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V5
   \   000000                REQUIRE ?V6
   \   000000                REQUIRE ?V7
   \   000000                REQUIRE ?V8
   \   000000                REQUIRE ?V9
   \   000000                REQUIRE ?V10
   \   000000                REQUIRE ?V11
   \   000000   74EC         MOV       A,#-0x14
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 20
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV       ?V2,R2
   \   000007   8B..         MOV       ?V3,R3
   3485            // fast bit by bit algorithm without augmented zero bytes.
   3486            // does not use lookup table, suited for polynom orders between 1...32.
   3487          
   3488            uint16 i, j, c, bit;
   3489            uint16 crc = crcinit_direct;
   \   000009   EC           MOV       A,R4
   \   00000A   FE           MOV       R6,A
   \   00000B   ED           MOV       A,R5
   \   00000C   FF           MOV       R7,A
   3490          
   3491            for (i=0; i<len; i++) {
   \   00000D   75..00       MOV       ?V0,#0x0
   \   000010   75..00       MOV       ?V1,#0x0
   \   000013   7414         MOV       A,#0x14
   \   000015   12....       LCALL     ?XSTACK_DISP0_8
   \   000018   78..         MOV       R0,#?V8
   \   00001A   12....       LCALL     ?L_MOV_X
   \   00001D   8046         SJMP      ??bdb_crcBitByBitFast_0
   3492          
   3493              c = (uint16)*p++;
   \                     ??bdb_crcBitByBitFast_1:
   \   00001F   85..82       MOV       DPL,?V2
   \   000022   85..83       MOV       DPH,?V3
   \   000025   E0           MOVX      A,@DPTR
   \   000026   FA           MOV       R2,A
   \   000027   7B00         MOV       R3,#0x0
   \   000029   A3           INC       DPTR
   \   00002A   8582..       MOV       ?V2,DPL
   \   00002D   8583..       MOV       ?V3,DPH
   3494              c = bdb_crcReflect(c, 8);
   \   000030                ; Setup parameters for call to function bdb_crcReflect
   \   000030   7C08         MOV       R4,#0x8
   \   000032   7D00         MOV       R5,#0x0
   \   000034   12....       LCALL     `??bdb_crcReflect::?relay`; Banked call to: bdb_crcReflect
   3495          
   3496              for (j=0x80; j; j>>=1) {
   \   000037   7880         MOV       R0,#-0x80
   3497          
   3498                bit = crc & CRC_HIGHBIT;
   \                     ??bdb_crcBitByBitFast_2:
   \   000039   EF           MOV       A,R7
   \   00003A   5480         ANL       A,#0x80
   \   00003C   FD           MOV       R5,A
   3499                crc<<= 1;
   \   00003D   EE           MOV       A,R6
   \   00003E   25E0         ADD       A,0xE0 /* A   */
   \   000040   FE           MOV       R6,A
   \   000041   EF           MOV       A,R7
   \   000042   33           RLC       A
   \   000043   FF           MOV       R7,A
   3500                if (c & j) bit^= CRC_HIGHBIT;
   \   000044   EA           MOV       A,R2
   \   000045   58           ANL       A,R0
   \   000046   6004         JZ        ??bdb_crcBitByBitFast_3
   \   000048   7480         MOV       A,#-0x80
   \   00004A   6D           XRL       A,R5
   \   00004B   FD           MOV       R5,A
   3501                if (bit) crc^= CRC_POLYNOM;
   \                     ??bdb_crcBitByBitFast_3:
   \   00004C   ED           MOV       A,R5
   \   00004D   6008         JZ        ??bdb_crcBitByBitFast_4
   \   00004F   7421         MOV       A,#0x21
   \   000051   6E           XRL       A,R6
   \   000052   FE           MOV       R6,A
   \   000053   7410         MOV       A,#0x10
   \   000055   6F           XRL       A,R7
   \   000056   FF           MOV       R7,A
   3502              }
   \                     ??bdb_crcBitByBitFast_4:
   \   000057   C3           CLR       C
   \   000058   E8           MOV       A,R0
   \   000059   13           RRC       A
   \   00005A   F8           MOV       R0,A
   \   00005B   70DC         JNZ       ??bdb_crcBitByBitFast_2
   3503            }
   \   00005D   05..         INC       ?V0
   \   00005F   E5..         MOV       A,?V0
   \   000061   7002         JNZ       ??bdb_crcBitByBitFast_0
   \   000063   05..         INC       ?V1
   \                     ??bdb_crcBitByBitFast_0:
   \   000065   85....       MOV       ?V4,?V0
   \   000068   85....       MOV       ?V5,?V1
   \   00006B   E4           CLR       A
   \   00006C   F5..         MOV       ?V6,A
   \   00006E   F5..         MOV       ?V7,A
   \   000070   78..         MOV       R0,#?V8
   \   000072   79..         MOV       R1,#?V4
   \   000074   12....       LCALL     ?UL_GT
   \   000077   40A6         JC        ??bdb_crcBitByBitFast_1
   3504          
   3505            crc=bdb_crcReflect(crc, CRC_ORDER);
   3506            crc^= CRC_XOR;
   3507          
   3508            return(crc);
   \   000079                ; Setup parameters for call to function bdb_crcReflect
   \   000079   7C10         MOV       R4,#0x10
   \   00007B   7D00         MOV       R5,#0x0
   \   00007D   EE           MOV       A,R6
   \   00007E   FA           MOV       R2,A
   \   00007F   EF           MOV       A,R7
   \   000080   FB           MOV       R3,A
   \   000081   12....       LCALL     `??bdb_crcReflect::?relay`; Banked call to: bdb_crcReflect
   \   000084   EA           MOV       A,R2
   \   000085   F4           CPL       A
   \   000086   FA           MOV       R2,A
   \   000087   EB           MOV       A,R3
   \   000088   F4           CPL       A
   \   000089   FB           MOV       R3,A
   \   00008A   7F0C         MOV       R7,#0xc
   \   00008C   02....       LJMP      ?BANKED_LEAVE_XDATA
   3509          }

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for bdbAttributes>`:
   \   000000   00F0FF07     DD 134213632
   \   000004   00080000     DD 2048
   \   000008   FFFF         DW 65535
   \   00000A   00           DB 0
   \   00000B   00           DB 0
   \   00000C   05           DB 5
   \   00000D   04           DB 4
   \   00000E   00           DB 0
   \   00000F   00           DB 0
   \   000010   00           DB 0
   \   000011   03           DB 3
   \   000012   00           DB 0

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for vDoPrimaryScan>`:
   \   000000   01           DB 1

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for zgBdbInstallCodeCRC>`:
   \   000000   83           DB 131
   \   000001   FE           DB 254
   \   000002   D3           DB 211
   \   000003   40           DB 64
   \   000004   7A           DB 122
   \   000005   93           DB 147
   \   000006   97           DB 151
   \   000007   23           DB 35
   \   000008   A5           DB 165
   \   000009   C6           DB 198
   \   00000A   39           DB 57
   \   00000B   B2           DB 178
   \   00000C   69           DB 105
   \   00000D   16           DB 22
   \   00000E   D5           DB 213
   \   00000F   05           DB 5
   \   000010   C3           DB 195
   \   000011   B5           DB 181

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_3e8:
   \   000000   E8030000     DD 1000

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_32:
   \   000000   32000000     DD 50

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_12c:
   \   000000   2C010000     DD 300

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_1388:
   \   000000   88130000     DD 5000

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_c8:
   \   000000   C8000000     DD 200

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_0:
   \   000000   00000000     DD 0

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_3a98:
   \   000000   983A0000     DD 15000

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_bb8:
   \   000000   B80B0000     DD 3000

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_10:
   \   000000   10000000     DD 16

   Maximum stack usage in bytes:

   ISTACK XSTACK Function
   ------ ------ --------
      0     10   bdb_AddRespondentNode
        0     10   -> bdb_CreateRespondentList
        0     10   -> osal_mem_alloc
      0      9   bdb_CBKETCLinkKeyExchangeAttempt
        0      9   -> bdb_reportCommissioningState
        0      9   -> bdb_setNodeJoinLinkKeyType
        0      9   -> bdb_tcLinkKeyExchangeAttempt
      0      0   bdb_ClearNetworkParams
      0     20   bdb_CreateRespondentList
        0     10   -> osal_mem_alloc
      2     36   bdb_GenerateInstallCodeCRC
        2      6   -> bdb_calculateCCITT_CRC
      0      9   bdb_Init
        0      9   -> ZDO_RegisterForZDOMsg
        0      9   -> bdb_RepInit
      2     18   bdb_NetworkRestoredResumeState
        2      4   -> osal_start_timerEx
      1     36   bdb_NotifyCommissioningModeStart
        0     15   -> bdb_SendMsg
      0     78   bdb_ProcessNodeDescRsp
        0     45   -> APSME_IsDistributedSecurity
        0     45   -> ZDO_ParseNodeDescRsp
        0     45   -> bdb_reportCommissioningState
        0     45   -> bdb_setNodeJoinLinkKeyType
        0     45   -> bdb_tcLinkKeyExchangeAttempt
        0     49   -> osal_nv_write
        0     45   -> osal_stop_timerEx
      0     69   bdb_ProcessOSALMsg
        0     36   -> APSME_GetRequest
        0     36   -> APSME_IsDistributedSecurity
        0     36   -> APSME_RequestKeyReq
        0     36   -> APSME_VerifyKeyReq
        0     36   -> NLME_GetShortAddr
        0     36   -> NLME_NwkDiscTerm
        0     37   -> ZDP_NWKAddrOfInterestReq
        0     36   -> ZMacSetReq
        0     36   -> bdb_filterNwkDisc
        0     36   -> bdb_nwkDiscoveryAttempt
        0     36   -> bdb_reportCommissioningState
        0     36   -> bdb_setNodeJoinLinkKeyType
        0     36   -> bdb_tryNwkAssoc
        0     36   -> nwkNeighborInitTable
        0     40   -> osal_start_timerEx
        0     36   -> osal_stop_timerEx
      2      0   bdb_RegisterCBKETCLinkKeyExchangeCB
      2      0   bdb_RegisterCommissioningStatusCB
      2      0   bdb_RegisterForFilterNwkDescCB
      1     10   bdb_RegisterSimpleDescriptor
        0     10   -> afRegister
        0     10   -> osal_mem_alloc
      1     43   bdb_SendMsg
        0     20   -> osal_memcpy
        0     17   -> osal_msg_allocate
        0     17   -> osal_msg_send
      0     36   bdb_StartCommissioning
        0     32   -> APSME_IsDistributedSecurity
        0     32   -> ZDApp_ReadNetworkRestoreState
        0     32   -> ZDOInitDeviceEx
        0     32   -> bdb_RepConstructReportingData
        0     32   -> bdb_RepUpdateMarkBindings
        0     32   -> bdb_reportCommissioningState
        0     32   -> bdb_setNodeIsOnANetwork
        0     32   -> osal_get_timeoutEx
        0     32   -> osal_isbufset
        0     32   -> osal_memset
        0     32   -> osal_nv_delete
        0     32   -> osal_nv_item_len
        0     36   -> osal_nv_read
        0     36   -> osal_nv_write
        0     32   -> osal_set_event
        0     32   -> zgWriteStartupOptions
      0     24   bdb_ZclIdentifyCmdInd
        0     24   -> osal_start_timerEx
        0     20   -> osal_stop_timerEx
        0     22   -> zclFindAttrRec
      2      0   bdb_ZedAttemptRecoverNwk
        2      0   -> ZDOInitDeviceEx
      0     51   bdb_addInstallCode
        0     30   -> APSME_AddTCLinkKey
        0     30   -> bdb_GenerateInstallCodeCRC
        0     30   -> osal_build_uint16
        0     34   -> sspMMOHash
      0     28   bdb_calculateCCITT_CRC
        0     22   -> bdb_crcBitByBitFast
        0     18   -> bdb_crcInit
      0     42   bdb_crcBitByBitFast
        0     20   -> bdb_crcReflect
      0     27   bdb_crcInit
      0     32   bdb_crcReflect
      0      0   bdb_doTrustCenterRequireKeyExchange
      1     33   bdb_event_loop
        0     29   -> NLME_LeaveReq
        0     29   -> bdb_ProcessIEEEAddrRsp
        0     29   -> bdb_ProcessNodeDescRsp
        0     29   -> bdb_ProcessOSALMsg
        0     29   -> bdb_ProcessRespondentList
        0     29   -> bdb_ProcessSimpleDesc
        0     29   -> bdb_RepProcessEvent
        0     29   -> bdb_SendIdentifyQuery
        0     29   -> bdb_exitFindingBindingWStatus
        0     29   -> bdb_getRespondentRetry
        0     29   -> bdb_nwkAssocAttemt
        0     29   -> bdb_reportCommissioningState
        0     29   -> bdb_setEpDescListToActiveEndpoint
        0     29   -> bdb_setNodeIsOnANetwork
        0     29   -> bdb_startResumeCommissioningProcess
        0     29   -> bdb_tcLinkKeyExchangeAttempt
        0     29   -> osal_get_timeoutEx
        0     29   -> osal_memset
        0     29   -> osal_msg_deallocate
        0     29   -> osal_msg_receive
        0     29   -> osal_set_event
        0     33   -> osal_start_timerEx
        0     29   -> osal_stop_timerEx
        0     31   -> zclFindAttrRec
      0     47   bdb_filterNwkDisc
        0     11   -> bdb_nwkDescFree
        0     11   -> nwk_ExtPANIDValid
        0     11   -> nwk_desc_list_release
        0     11   -> nwk_getNwkDescList
        0     11   -> sAddrExtCmp
      2      0   bdb_getZCLFrameCounter
      2      0   bdb_isDeviceNonFactoryNew
      0     25   bdb_joinProcess
        0     14   -> NLME_JoinRequest
        0     10   -> NLME_SetPollRate
        0     10   -> NLME_SetQueuedPollRate
        0     10   -> NLME_SetResponseRate
        0     10   -> ZDApp_ChangeState
        0     10   -> ZDApp_NodeProfileSync
      0     42   bdb_nwkAssocAttemt
        0     13   -> bdb_SendMsg
        0     11   -> bdb_nwkDescFree
      2     14   bdb_nwkDescFree
        2      0   -> osal_mem_free
      0     49   bdb_nwkDiscoveryAttempt
        0     11   -> ZDApp_NetworkInit
        0     13   -> bdb_SendMsg
        0     11   -> bdb_reportCommissioningState
        0     11   -> bdb_setChannel
      0      9   bdb_nwkFormationAttempt
        0      9   -> bdb_nwkJoiningFormation
        0      9   -> bdb_reportCommissioningState
      0     33   bdb_nwkJoiningFormation
        0     12   -> ZDOInitDeviceEx
        0     12   -> bdb_reportCommissioningState
        0     12   -> bdb_setChannel
      2      1   bdb_parentLost
        2      1   -> NLME_OrphanStateSet
        2      1   -> ZDApp_ChangeState
        2      1   -> ZMacSetReq
        2      1   -> bdb_nwkDescFree
        2      1   -> bdb_reportCommissioningState
        2      1   -> nwk_desc_list_free
      0     15   bdb_rejoinNwk
        0     11   -> NLME_ReJoinRequest
        0     11   -> NLME_ReJoinRequestUnsecure
        0     11   -> ZDApp_ChangeState
        0     11   -> ZDApp_RestoreNwkKey
        0     11   -> ZMacSetReq
        0     15   -> osal_nv_write
      1     63   bdb_reportCommissioningState
        0     14   -> AT_UARTWriteErrMsg
        0     14   -> NLME_ResetRequest
        0     14   -> NLME_SetPollRate
        0     14   -> ZDApp_ChangeState
        0     14   -> ZDApp_RestoreNwkSecMaterial
        0     14   -> ZMacSetReq
        0     14   -> bdb_NetworkRestoredResumeState
        0     16   -> bdb_SendMsg
        0     14   -> bdb_getRespondentRetry
        0     14   -> bdb_nwkDescFree
        0     14   -> bdb_setFN
        0     14   -> bdb_zclRespondentListClean
        0     14   -> nwk_setStateIdle
        0     14   -> osal_get_timeoutEx
        0     18   -> osal_start_timerEx
        0     14   -> osal_stop_timerEx
        0     14   -> zgWriteStartupOptions
      2      5   bdb_resetLocalAction
        2      5   -> NLME_LeaveReq
        2      5   -> ZDApp_ResetTimerStart
        2      5   -> bdb_setFN
        2      5   -> osal_memset
      0     17   bdb_setActiveCentralizedLinkKey
        0     17   -> APSME_AddTCLinkKey
        0     17   -> APSME_SetDefaultKey
        0     17   -> bdb_addInstallCode
        0     17   -> osal_memset
      0     28   bdb_setChannel
        0     16   -> osal_nv_write
      0     12   bdb_setChannelAttribute
      2      0   bdb_setCommissioningGroupID
      2     14   bdb_setFN
        2      0   -> bdb_setNodeIsOnANetwork
        2      0   -> zgWriteStartupOptions
      0     46   bdb_setNodeIsOnANetwork
        0     14   -> osal_nv_write
      2     45   bdb_setNodeJoinLinkKeyType
      0     54   bdb_startResumeCommissioningProcess
        0     21   -> bdb_NotifyCommissioningModeStart
        0     21   -> bdb_SendIdentifyQuery
        0     23   -> bdb_SendMsg
        0     21   -> bdb_exitFindingBindingWStatus
        0     21   -> bdb_nwkJoiningFormation
        0     21   -> bdb_reportCommissioningState
        0     21   -> bdb_setEpDescListToActiveEndpoint
        0     21   -> osal_memset
        0     25   -> osal_start_timerEx
        0     23   -> zclFindAttrRec
      0     60   bdb_tcLinkKeyExchangeAttempt
        0     15   -> bdb_SendMsg
        0     13   -> osal_stop_timerEx
      0      0   bdb_touchlinkSendFNReset
      0     49   bdb_tryNwkAssoc
        0     13   -> bdb_SendMsg
        0     11   -> bdb_joinProcess
        0     11   -> bdb_nwkDescFree
      0     26   bdb_zclRespondentListClean
        0     12   -> osal_mem_free


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
      19  ?<Initializer for bdbAttributes>
       1  ?<Initializer for vDoPrimaryScan>
      18  ?<Initializer for zgBdbInstallCodeCRC>
       1  ??Subroutine41_0
       7  ??Subroutine42_0
      13  ??Subroutine43_0
       2  ??Subroutine44_0
       6  ??Subroutine45_0
       6  ??Subroutine46_0
       9  ??Subroutine47_0
      11  ??Subroutine48_0
       3  ??Subroutine49_0
       5  ??Subroutine50_0
       6  ??Subroutine51_0
       7  ??Subroutine52_0
       8  ??Subroutine53_0
       6  ??Subroutine54_0
       2  ??Subroutine55_0
      11  ??Subroutine56_0
       1  ??Subroutine57_0
       5  ??Subroutine58_0
       3  ??Subroutine59_0
       5  ??Subroutine60_0
       4  ??Subroutine61_0
       6  ??Subroutine62_0
       5  ?Subroutine0
       2  ?Subroutine1
       2  ?Subroutine10
       7  ?Subroutine11
       3  ?Subroutine12
       8  ?Subroutine13
       2  ?Subroutine14
       6  ?Subroutine15
      15  ?Subroutine16
       4  ?Subroutine17
       7  ?Subroutine18
       4  ?Subroutine19
       2  ?Subroutine2
       2  ?Subroutine20
       4  ?Subroutine21
       3  ?Subroutine22
       8  ?Subroutine23
      12  ?Subroutine24
       3  ?Subroutine25
       9  ?Subroutine26
       6  ?Subroutine27
       5  ?Subroutine28
       8  ?Subroutine29
       4  ?Subroutine3
       6  ?Subroutine30
       9  ?Subroutine31
       8  ?Subroutine32
       8  ?Subroutine33
      13  ?Subroutine34
      15  ?Subroutine35
       3  ?Subroutine36
       6  ?Subroutine37
       5  ?Subroutine38
       6  ?Subroutine39
       6  ?Subroutine4
       9  ?Subroutine40
      12  ?Subroutine5
      11  ?Subroutine6
      15  ?Subroutine7
      10  ?Subroutine8
      10  ?Subroutine9
       4  __Constant_0
       4  __Constant_10
       4  __Constant_12c
       4  __Constant_1388
       4  __Constant_32
       4  __Constant_3a98
       4  __Constant_3e8
       4  __Constant_bb8
       4  __Constant_c8
      19  bdbAttributes
       4  bdbCommissioningProcedureState
     169  bdb_AddRespondentNode
      34  bdb_CBKETCLinkKeyExchangeAttempt
       3  bdb_ClearNetworkParams
      22  bdb_CreateRespondentList
       2  bdb_CurrEpDescriptorList
       1  bdb_FBStateSuccessLatch
       1  bdb_FB_InitiatorCurrentCyclesNumber
      42  bdb_GenerateInstallCodeCRC
       2  bdb_HeadEpDescriptorList
      44  bdb_Init
      79  bdb_NetworkRestoredResumeState
      36  bdb_NotifyCommissioningModeStart
     148  bdb_ProcessNodeDescRsp
     428  bdb_ProcessOSALMsg
      31  bdb_RegisterCBKETCLinkKeyExchangeCB
      10  bdb_RegisterCommissioningStatusCB
      17  bdb_RegisterForFilterNwkDescCB
      58  bdb_RegisterSimpleDescriptor
     109  bdb_SendMsg
     501  bdb_StartCommissioning
       1  bdb_TaskID
     129  bdb_ZclIdentifyCmdInd
       1  bdb_ZclTransactionSequenceNumber
      38  bdb_ZedAttemptRecoverNwk
     120  bdb_addInstallCode
      97  bdb_calculateCCITT_CRC
     143  bdb_crcBitByBitFast
     108  bdb_crcInit
      75  bdb_crcReflect
       5  bdb_doTrustCenterRequireKeyExchange
     720  bdb_event_loop
     289  bdb_filterNwkDisc
      14  bdb_getZCLFrameCounter
       1  bdb_initialization
      12  bdb_isDeviceNonFactoryNew
     199  bdb_joinProcess
      75  bdb_nwkAssocAttemt
       1  bdb_nwkAssocRetriesCount
      87  bdb_nwkDescFree
      99  bdb_nwkDiscoveryAttempt
      48  bdb_nwkFormationAttempt
     109  bdb_nwkJoiningFormation
      84  bdb_parentLost
     157  bdb_rejoinNwk
     811  bdb_reportCommissioningState
      60  bdb_resetLocalAction
     105  bdb_setActiveCentralizedLinkKey
      65  bdb_setChannel
      32  bdb_setChannelAttribute
      10  bdb_setCommissioningGroupID
      19  bdb_setFN
      63  bdb_setNodeIsOnANetwork
      11  bdb_setNodeJoinLinkKeyType
     446  bdb_startResumeCommissioningProcess
      61  bdb_tcLinkKeyExchangeAttempt
       3  bdb_touchlinkSendFNReset
      77  bdb_tryNwkAssoc
      66  bdb_zclRespondentListClean
       2  pBDBListNwk
       2  pRespondentCurr
       2  pRespondentHead
       2  pRespondentNext
       2  pfnCBKETCLinkKeyExchange
       2  pfnCommissioningStatusCB
       2  pfnFilterNwkDesc
       1  touchLinkTargetEnabled
       1  vDoPrimaryScan
      18  zgBdbInstallCodeCRC
     300  -- Other

 
 6 578 bytes in segment BANKED_CODE
   300 bytes in segment BANK_RELAYS
    38 bytes in segment XDATA_I
    38 bytes in segment XDATA_ID
    36 bytes in segment XDATA_ROM_C
    29 bytes in segment XDATA_Z
 
   338 bytes of CODE     memory
     0 bytes of CONST    memory (+ 36 bytes shared)
 6 578 bytes of HUGECODE memory
    67 bytes of XDATA    memory

Errors: none
Warnings: none
